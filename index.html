<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio CCAS | v89 FINAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --blue: #0A1A3C; --gold: #CCA43B; --white: #fff; --green: #27ae60; --red: #c0392b; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--blue); color: var(--white); height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        * { box-sizing: border-box; outline: none; }
        input[type="file"] { display: none !important; }

        /* HEADER */
        .header { height: 80px; border-bottom: 3px solid var(--gold); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: rgba(0,0,0,0.3); }
        .logo-fixed { display: flex; align-items: center; gap: 15px; font-weight: 900; color: var(--gold); font-size: 1.4rem; }
        .logo-fixed img { height: 60px; background: white; padding: 5px; border-radius: 4px; border: 1px solid var(--gold); }
        .db-status { font-size: 0.8rem; padding: 2px 8px; border: 1px solid #555; border-radius: 4px; color: #aaa; margin-left: 10px; }
        .db-status.ok { color: var(--green); border-color: var(--green); }

        .btn { padding: 10px 20px; border-radius: 4px; font-weight: bold; border: none; cursor: pointer; color: white; display: flex; align-items: center; gap: 5px; }
        .btn-green { background: var(--green); }
        .btn-outline { border: 1px solid var(--gold); background: transparent; color: var(--gold); }

        /* VIEWS */
        #view-dash, #view-studio { flex: 1; display: none; overflow: hidden; }
        #view-dash { display: flex; flex-direction: column; padding: 40px; align-items: center; overflow-y: auto; }
        #view-studio { display: flex; } /* Initialement cach√© par JS */

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; width: 100%; max-width: 1200px; margin-top: 50px; }
        .card { background: rgba(255,255,255,0.05); border: 1px solid var(--gold); padding: 30px; text-align: center; cursor: pointer; position: relative; }
        .card-del { position: absolute; top: 10px; right: 10px; color: var(--red); background: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* STUDIO */
        .sidebar { width: 300px; border-right: 2px solid var(--gold); display: flex; flex-direction: column; background: rgba(0,0,0,0.2); }
        .side-head { padding: 20px; border-bottom: 1px solid #555; text-align: center; }
        .bat-list { flex: 1; overflow-y: auto; padding: 15px; }
        
        .bat-item { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; cursor: pointer; transition: 0.2s; }
        .bat-item.active { background: var(--gold); color: var(--blue); font-weight: bold; border-left: 5px solid white; }
        .bat-item.drag-over { background: rgba(46, 204, 113, 0.3); border: 2px dashed #2ecc71; }
        
        .editor { flex: 1; display: flex; flex-direction: column; background: var(--blue); }
        .editor-bar { height: 80px; border-bottom: 1px solid var(--gold); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: rgba(0,0,0,0.2); }
        .logo-sealed { background: white; padding: 5px; border: 1px solid var(--gold); height: 60px; display: flex; align-items: center; }
        .logo-sealed img { height: 100%; width: auto; }
        .content { flex: 1; overflow-y: auto; padding: 40px; }

        /* BLOCS */
        .block { display: flex; border: 2px solid var(--gold); margin-bottom: 40px; background: black; height: 400px; position: relative; }
        .block.drag-over { border-color: #2ecc71; box-shadow: 0 0 30px #2ecc71; transform: scale(1.02); z-index: 100; }
        .block-img { width: 60%; position: relative; border-right: 1px solid var(--gold); overflow: hidden; }
        .block-img img { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 100%; max-height: 100%; object-fit: contain; }
        .block-txt { width: 40%; display: flex; flex-direction: column; padding: 20px; background: var(--blue); }
        .editable { flex: 1; overflow-y: auto; padding: 10px; border: 1px dotted rgba(255,255,255,0.2); color: white; }
        
        .tools-overlay { position: absolute; top: 10px; left: 10px; display: flex; gap: 5px; z-index: 10; }
        .mini-btn { background: rgba(0,0,0,0.7); border: 1px solid white; color: white; padding: 5px 10px; cursor: pointer; }
        
        .drag-handle { cursor: grab; font-size: 1.5rem; padding-right: 10px; color: #888; }
        
        /* PAINT */
        #paint-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: none; flex-direction: column; }
        .paint-tools { height: 80px; display: flex; justify-content: center; align-items: center; gap: 20px; background: #111; }
        
        #toast { position: fixed; bottom: 30px; right: 30px; background: var(--green); color: white; padding: 15px 30px; border-radius: 50px; display: none; z-index: 11000; }
    </style>
</head>
<body>

<div id="toast">‚úÖ Sauvegard√© !</div>
<input type="file" id="f-imp" onchange="importData(this)">
<input type="file" id="f-photo" multiple accept="image/*" onchange="addPhotos(this)">

<div id="view-dash">
    <div class="header">
        <div class="logo-fixed">
            <img id="main-logo" src="Logo_Cr√©teil_Val_Marne.svg.png" alt="Logo" onerror="this.style.display='none'">
            STUDIO CCAS <span id="db-state" class="db-status">...</span>
        </div>
        <div style="display:flex; gap:15px;">
            <button class="btn btn-green" onclick="exportPC()">üì• SAUVEGARDE PC</button>
            <button class="btn btn-outline" onclick="document.getElementById('f-imp').click()">üìÇ CHARGER</button>
        </div>
    </div>
    <div id="grid" class="grid"></div>
    <div style="margin-top: 60px; text-align:center;">
        <button class="btn btn-outline" style="padding: 20px 50px; font-size: 1.3rem;" onclick="newProj()">+ NOUVEAU DOSSIER</button>
    </div>
</div>

<div id="view-studio">
    <div class="sidebar">
        <div class="side-head">
            <button class="btn btn-outline" style="width:100%" onclick="goHome()">‚¨ÖÔ∏è DOSSIERS</button>
            <h3 id="p-name" style="color:var(--gold); margin:20px 0; cursor:pointer; border-bottom:1px dashed #666;" onclick="renProj()">Projet</h3>
        </div>
        <div id="bat-list" class="bat-list"></div>
        <div style="padding: 20px;">
            <button class="btn btn-outline" style="width: 100%;" onclick="addBat()">+ RUBRIQUE</button>
        </div>
    </div>
    <div class="editor">
        <div class="editor-bar">
            <div class="logo-sealed"><img id="editor-logo" src="Logo_Cr√©teil_Val_Marne.svg.png"></div>
            <div id="bat-title" style="font-weight:bold; color:var(--gold); font-size:1.5rem; text-transform: uppercase;">Accueil</div>
            <div style="display:flex; gap:15px;">
                <button class="btn btn-green" onclick="exportPC()">üíæ SAUVER</button>
                <button class="btn btn-outline" onclick="genExportHTML()">üåç EXPORT SITE</button>
            </div>
        </div>
        <div id="content" class="content"></div>
    </div>
</div>

<div id="paint-modal">
    <div style="height:60px; display:flex; justify-content:space-between; align-items:center; padding:0 30px; background:#222; border-bottom:1px solid #444;">
        <b style="color:var(--gold)">RETOUCHE</b>
        <div><button class="btn btn-green" onclick="savePaint()">OK</button> <button class="btn btn-outline" onclick="closePaint()">ANNULER</button></div>
    </div>
    <div style="flex:1; display:flex; justify-content:center; overflow:hidden; background:#000;"><canvas id="canvas"></canvas></div>
    <div class="paint-tools">
        <button class="btn btn-outline" onclick="tool='rect'">‚¨ú</button>
        <button class="btn btn-outline" onclick="tool='circle'">‚≠ï</button>
        <button class="btn btn-outline" onclick="tool='arrow'">‚ÜóÔ∏è</button>
        <button class="btn btn-outline" onclick="tool='free'">‚úèÔ∏è</button>
        <input type="color" onchange="color=this.value" value="#ff0000" style="height:40px; border:none; background:none;">
        <input type="range" min="2" max="30" value="5" oninput="brushSize=parseInt(this.value)">
    </div>
</div>

<script>
/* MOTEUR v89 - DRAG & DROP RUBRIQUES CORRIG√â */
const DB_NAME="CCAS_DB_V89"; const DB_VER=1; let db=null, app={projects:{}}, curP=null, curB=null;

// DB
const req=indexedDB.open(DB_NAME,DB_VER);
req.onupgradeneeded=e=>{ db=e.target.result; if(!db.objectStoreNames.contains('data')) db.createObjectStore('data',{keyPath:'id'}); };
req.onsuccess=e=>{ db=e.target.result; document.getElementById('db-state').innerText="‚úÖ DB OK"; document.getElementById('db-state').classList.add('ok'); loadData(); };
req.onerror=()=>{ alert("Erreur BDD"); };

function loadData(){ const tx=db.transaction(['data'],'readonly'); const req=tx.objectStore('data').get('main'); req.onsuccess=()=>{ if(req.result){ app=req.result.val; renderDash(); } else { document.getElementById('view-dash').style.display='flex'; } }; }
function saveData(){ if(!db)return; const tx=db.transaction(['data'],'readwrite'); tx.objectStore('data').put({id:'main',val:app}); }

/* NAV */
function newProj(){ const n=prompt("Nom :"); if(n){ const id='p'+Date.now(); app.projects[id]={name:n,date:Date.now(),data:{}}; saveData(); renderDash(); openProj(id); } }
function openProj(id){ curP=id; curB=null; document.getElementById('view-dash').style.display='none'; document.getElementById('view-studio').style.display='flex'; document.getElementById('p-name').innerText=app.projects[id].name; if(Object.keys(app.projects[id].data).length===0) app.projects[id].data["Zone 1"]=[]; renderBats(); openBat(Object.keys(app.projects[id].data)[0]); }
function renProj(){ const n=prompt("Nom :",app.projects[curP].name); if(n){ app.projects[curP].name=n; document.getElementById('p-name').innerText=n; saveData(); } }
function goHome(){ document.getElementById('view-studio').style.display='none'; document.getElementById('view-dash').style.display='flex'; curP=null; renderDash(); }
function renderDash(){ const g=document.getElementById('grid'); g.innerHTML=''; Object.keys(app.projects).forEach(id=>{ const p=app.projects[id]; const d=document.createElement('div'); d.className='card'; d.innerHTML=`<div class="card-del" onclick="delProj('${id}',event)">√ó</div><div style="font-size:3rem; margin-bottom:10px;">üìÅ</div><b>${p.name}</b>`; d.onclick=()=>openProj(id); g.appendChild(d); }); }
function delProj(id,e){ e.stopPropagation(); if(confirm("Supprimer ?")){ delete app.projects[id]; saveData(); renderDash(); } }

/* RUBRIQUES + DRAG */
function addBat(){ const n=prompt("Nom :"); if(n){ if(!app.projects[curP].data[n]) app.projects[curP].data[n]=[]; saveData(); openBat(n); } }
function renderBats(){
    const l=document.getElementById('bat-list'); l.innerHTML='';
    Object.keys(app.projects[curP].data).forEach(b=>{
        const d=document.createElement('div'); d.className=`bat-item ${curB===b?'active':''}`;
        d.draggable=true;
        d.innerHTML=`<span class="drag-handle">‚ò∞</span><span onclick="openBat('${b}')" style="flex:1">${b}</span> <span onclick="delBat('${b}',event)" style="color:var(--red); font-weight:bold;">√ó</span>`;
        
        // DRAG LOGIC RUBRIQUES
        d.ondragstart = e => { e.dataTransfer.setData('src', b); e.dataTransfer.setData('type', 'bat'); };
        d.ondragover = e => { e.preventDefault(); d.classList.add('drag-over'); };
        d.ondragleave = e => { d.classList.remove('drag-over'); };
        d.ondrop = e => {
            e.stopPropagation(); d.classList.remove('drag-over');
            const src = e.dataTransfer.getData('src');
            if(e.dataTransfer.getData('type')==='bat' && src!==b){
                const data = app.projects[curP].data;
                const keys = Object.keys(data);
                const idxSrc = keys.indexOf(src);
                const idxTgt = keys.indexOf(b);
                // Reorder keys
                const newObj = {};
                keys.splice(idxTgt, 0, keys.splice(idxSrc, 1)[0]);
                keys.forEach(k => newObj[k] = data[k]);
                app.projects[curP].data = newObj;
                saveData(); renderBats();
            }
        };
        l.appendChild(d);
    });
}
function openBat(b){ curB=b; document.getElementById('bat-title').innerText=b; renderBats(); renderContent(); }
function delBat(b,e){ e.stopPropagation(); if(confirm("Supprimer ?")){ delete app.projects[curP].data[b]; if(curB===b) curB=null; saveData(); renderBats(); renderContent(); } }

/* PHOTOS + DRAG */
function addPhotos(i){
    if(!curB) return alert("S√©lectionnez une rubrique !");
    Array.from(i.files).forEach(f=>{
        const r=new FileReader();
        r.onload=e=>{
            const img=new Image();
            img.onload=()=>{
                const c=document.createElement('canvas'); const x=c.getContext('2d');
                let w=img.width, h=img.height; const max=1200; if(w>max){h*=max/w;w=max;}
                c.width=w; c.height=h; x.drawImage(img,0,0,w,h);
                app.projects[curP].data[curB].push({src:c.toDataURL('image/jpeg',0.8), text:"..."});
                saveData(); renderContent();
            }; img.src=e.target.result;
        }; r.readAsDataURL(f);
    }); i.value='';
}
function renderContent(){
    const c=document.getElementById('content'); c.innerHTML='';
    if(!curB) return;
    const btn=document.createElement('div'); btn.innerHTML='<button class="btn btn-outline" style="width:100%; margin-bottom:20px;" onclick="document.getElementById(\'f-photo\').click()">+ AJOUTER PHOTOS</button>'; c.appendChild(btn);
    
    app.projects[curP].data[curB].forEach((it,idx)=>{
        const b=document.createElement('div'); b.className='block'; b.draggable=true;
        b.innerHTML=`
            <div class="drag-handle" style="width:40px; display:flex; align-items:center; justify-content:center; background:#222; border-right:1px solid #444;">‚ò∞</div>
            <div class="block-img">
                <div class="tools-overlay"><button class="mini-btn" onclick="editP(${idx})">üé®</button> <button class="mini-btn" style="background:var(--red)" onclick="delP(${idx})">‚úñ</button></div>
                <img src="${it.src}">
            </div>
            <div class="block-txt"><div class="editable" contenteditable="true" oninput="updT(${idx},this.innerHTML)">${it.text}</div></div>`;
        
        // DRAG LOGIC PHOTOS
        b.ondragstart = e => { e.dataTransfer.setData('idx', idx); b.style.opacity='0.5'; };
        b.ondragend = e => { b.style.opacity='1'; };
        b.ondragover = e => { e.preventDefault(); b.classList.add('drag-over'); };
        b.ondragleave = e => { b.classList.remove('drag-over'); };
        b.ondrop = e => {
            e.stopPropagation(); b.classList.remove('drag-over');
            const from = parseInt(e.dataTransfer.getData('idx'));
            if(!isNaN(from) && from !== idx){
                const arr = app.projects[curP].data[curB];
                arr.splice(idx, 0, arr.splice(from, 1)[0]);
                saveData(); renderContent();
            }
        };
        c.appendChild(b);
    });
}
function updT(i,t){ app.projects[curP].data[curB][i].text=t; clearTimeout(window.st); window.st=setTimeout(saveData,1000); }
function delP(i){ if(confirm("Supprimer ?")){ app.projects[curP].data[curB].splice(i,1); saveData(); renderContent(); } }

/* PAINT */
let pI, pIm, tool='rect', color='#ff0000', brushSize=5, draw=false, sx, sy;
function editP(i){ pI=i; const s=app.projects[curP].data[curB][i].src; pIm=new Image(); pIm.onload=()=>{ const c=document.getElementById('canvas'); c.width=pIm.width; c.height=pIm.height; c.getContext('2d').drawImage(pIm,0,0); document.getElementById('paint-modal').style.display='flex'; }; pIm.src=s; }
function savePaint(){ app.projects[curP].data[curB][pI].src=document.getElementById('canvas').toDataURL('image/jpeg',0.8); saveData(); closePaint(); renderContent(); }
function closePaint(){ document.getElementById('paint-modal').style.display='none'; }
const cvs=document.getElementById('canvas');
cvs.onmousedown=e=>{ draw=true; const r=cvs.getBoundingClientRect(), s=cvs.width/r.width; sx=(e.clientX-r.left)*s; sy=(e.clientY-r.top)*s; cvs.getContext('2d').beginPath(); };
cvs.onmousemove=e=>{ if(!draw)return; const ctx=cvs.getContext('2d'), r=cvs.getBoundingClientRect(), s=cvs.width/r.width, x=(e.clientX-r.left)*s, y=(e.clientY-r.top)*s; ctx.strokeStyle=color; ctx.lineWidth=brushSize; if(tool=='free'){ctx.lineTo(x,y);ctx.stroke();} };
cvs.onmouseup=e=>{ draw=false; if(tool!='free'){ const ctx=cvs.getContext('2d'), r=cvs.getBoundingClientRect(), s=cvs.width/r.width, x=(e.clientX-r.left)*s, y=(e.clientY-r.top)*s; ctx.beginPath(); ctx.strokeStyle=color; ctx.lineWidth=brushSize; if(tool=='rect')ctx.strokeRect(sx,sy,x-sx,y-sy); if(tool=='circle'){const rad=Math.sqrt((x-sx)**2+(y-sy)**2);ctx.arc(sx,sy,rad,0,2*Math.PI);ctx.stroke();} if(tool=='arrow'){ctx.moveTo(sx,sy);ctx.lineTo(x,y);ctx.stroke();const a=Math.atan2(y-sy,x-sx);ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x-15*Math.cos(a-0.5),y-15*Math.sin(a-0.5));ctx.moveTo(x,y);ctx.lineTo(x-15*Math.cos(a+0.5),y-15*Math.sin(a+0.5));ctx.stroke();} } };

/* EXPORT */
function exportPC(){ saveData(); const b=new Blob([JSON.stringify(app)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`CCAS_BACKUP_${Date.now()}.json`; a.click(); }
function importData(i){ if(!i.files[0])return; const r=new FileReader(); r.onload=e=>{ try{app=JSON.parse(e.target.result); saveData(); renderDash(); }catch(x){}}; r.readAsText(i.files[0]); }

/* EXPORT HTML (AVEC LOGO BASE64 AUTO) */
function genExportHTML(){
    if(!window.JSZip) return alert("Erreur ZIP");
    
    // 1. Convertir le logo actuel (affich√© dans l'interface) en Base64
    const logoImg = document.getElementById('main-logo');
    const c = document.createElement('canvas');
    c.width = logoImg.naturalWidth || 200;
    c.height = logoImg.naturalHeight || 60;
    c.getContext('2d').drawImage(logoImg, 0, 0);
    const logoBase64 = c.toDataURL("image/png"); // Le logo est maintenant encod√©

    const proj = app.projects[curP];
    const jsonData = JSON.stringify(proj.data).replace(/</g, '\\u003c');
    
    const htmlContent = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{margin:0;background:#0A1A3C;color:white;font-family:'Segoe UI',sans-serif;height:100vh;display:flex;overflow:hidden}#side{width:300px;background:rgba(0,0,0,0.3);border-right:3px solid #CCA43B;display:flex;flex-direction:column}.head{padding:20px;color:#CCA43B;font-weight:800;border-bottom:1px solid #555;text-align:center;font-size:1.4rem;text-transform:uppercase}.btn{width:100%;padding:15px;color:#ccc;background:none;border:none;text-align:left;cursor:pointer;border-bottom:1px solid #444;font-size:1.1rem}.btn.active{color:#CCA43B;border-left:6px solid #CCA43B;background:rgba(204,164,59,0.1);font-weight:bold}#main{flex:1;display:flex;flex-direction:column;position:relative}.view{height:75vh;width:100%;display:flex;align-items:center;justify-content:center;background:black;border-bottom:3px solid #CCA43B;position:relative}.frame img{max-width:100%;max-height:100%;object-fit:contain}.bot{height:25vh;background:#0A1A3C;padding:30px;overflow-y:auto;box-sizing:border-box}#desc{color:white;font-size:1.4rem;line-height:1.6}#desc *{background:transparent!important}#desc font{color:inherit}#tit{color:#CCA43B;text-transform:uppercase;border-bottom:1px solid #555;padding-bottom:10px;margin-top:0;font-size:1.6rem}.nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(204,164,59,0.5);color:white;border:none;font-size:50px;padding:10px;cursor:pointer;border-radius:50%}.p{left:20px}.n{right:20px}.top-logo{position:absolute;top:10px;right:10px;background:white;padding:5px;border:1px solid #CCA43B;border-radius:4px;height:70px;display:flex;align-items:center}.top-logo img{height:100%;}@media print{#side,.nav{display:none}.view{height:60vh;page-break-inside:avoid}.bot{height:40vh;page-break-after:always}}</style></head><body>
    <div id="side"><div class="head">${proj.name}</div><div id="nav"></div></div>
    <div id="main"><div class="view"><div class="top-logo"><img src="${logoBase64}"></div><div id="sc"></div></div><div class="bot"><h2 id="tit"></h2><div id="desc"></div></div></div>
    <script>const data=${jsonData};const keys=Object.keys(data);let cBat=keys[0];let cIdx=0;function renderNav(){const n=document.getElementById('nav');n.innerHTML='';keys.forEach(k=>{const b=document.createElement('button');b.className='btn'+(cBat===k?' active':'');b.innerText=k;b.onclick=()=>{cBat=k;cIdx=0;show();renderNav()};n.appendChild(b)})}function show(){const s=document.getElementById('sc');const arr=data[cBat];document.querySelectorAll('.nav').forEach(e=>e.remove());if(!arr||!arr.length){s.innerHTML='';document.getElementById('tit').innerText=cBat;document.getElementById('desc').innerHTML="Aucune photo.";return}const item=arr[cIdx];s.innerHTML='<img src="'+item.src+'">';document.getElementById('tit').innerText=cBat+" ("+(cIdx+1)+"/"+arr.length+")";document.getElementById('desc').innerHTML=item.text;if(arr.length>1){const prev=document.createElement('button');prev.className='nav p';prev.innerText='‚ùÆ';prev.onclick=()=>{cIdx=(cIdx-1+arr.length)%arr.length;show()};document.querySelector('.view').appendChild(prev);const next=document.createElement('button');next.className='nav n';next.innerText='‚ùØ';next.onclick=()=>{cIdx=(cIdx+1)%arr.length;show()};document.querySelector('.view').appendChild(next)}}if(keys.length){renderNav();show()}<\/script></body></html>`;

    const z = new JSZip(); 
    z.file("Site_" + proj.name + ".html", htmlContent);
    z.generateAsync({type:"blob"}).then(b => { 
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); 
        a.download = "Site_" + proj.name + ".zip"; 
        a.click(); 
    });
}
</script>
</body>
</html>
