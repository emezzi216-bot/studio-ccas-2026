<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Studio CCAS | Master Edition</title>
    <style>
        :root { --royal-bg: #0A1A3C; --royal-gold: #CCA43B; --royal-gold-light: #F4D03F; --white: #FFFFFF; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: #eaeff2; display: flex; height: 100vh; overflow: hidden; color: #333; }
        
        /* --- SIDEBAR (GAUCHE) --- */
        #sidebar { width: 320px; background: var(--royal-bg); color: white; display: flex; flex-direction: column; box-shadow: 5px 0 20px rgba(0,0,0,0.3); z-index: 100; flex-shrink: 0; }
        .side-header { padding: 30px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; background: linear-gradient(to bottom, #0d2249, #0A1A3C); }
        .side-header h1 { font-size: 1.2rem; color: var(--royal-gold); margin: 0; text-transform: uppercase; letter-spacing: 2px; font-weight: 800; }
        
        #building-list { flex: 1; overflow-y: auto; padding: 15px; }
        .b-item { background: rgba(255,255,255,0.05); border-radius: 6px; padding: 15px; margin-bottom: 8px; cursor: pointer; border-left: 4px solid transparent; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .b-item:hover { background: rgba(255,255,255,0.1); }
        .b-item.active { background: rgba(204, 164, 59, 0.15); border-left-color: var(--royal-gold); color: var(--royal-gold); font-weight: bold; }
        .del-b-btn { color: #ff6b6b; font-weight: bold; padding: 5px 10px; border-radius: 4px; transition: 0.2s; }
        .del-b-btn:hover { background: rgba(255,0,0,0.2); }

        /* --- MAIN (DROITE) --- */
        #main { flex: 1; display: flex; flex-direction: column; background: #f4f6f8; min-width: 0; }
        
        /* TOP NAV */
        #top-nav { background: white; padding: 15px 30px; border-bottom: 1px solid #dce1e6; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .input-title { width: 400px; padding: 12px; border-radius: 6px; border: 2px solid #e2e8f0; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .input-title:focus { border-color: var(--royal-bg); outline: none; }
        
        .btn-gen { padding: 12px 30px; background: linear-gradient(135deg, var(--royal-bg), #1a3a6e); color: white; border: none; border-radius: 30px; font-weight: 800; cursor: pointer; box-shadow: 0 4px 15px rgba(10, 26, 60, 0.4); transition: transform 0.2s; letter-spacing: 0.5px; display: flex; align-items: center; gap: 10px; }
        .btn-gen:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(10, 26, 60, 0.5); }

        /* --- EDITOR AREA --- */
        #editor-workspace { flex: 1; overflow-y: auto; padding: 40px; scroll-behavior: smooth; }
        #active-title { font-size: 2rem; color: var(--royal-bg); margin-bottom: 30px; border-bottom: 3px solid var(--royal-gold); display: inline-block; padding-bottom: 5px; }

        /* PHOTO CARDS */
        .photo-entry { background: white; border-radius: 12px; padding: 20px; margin-bottom: 30px; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); position: relative; transition: transform 0.2s, box-shadow 0.2s; }
        .photo-entry:hover { box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .photo-entry.dragging { opacity: 0.5; border: 2px dashed var(--royal-gold); transform: scale(0.98); }

        .card-layout { display: flex; gap: 25px; align-items: flex-start; }
        .preview-img { width: 260px; height: 160px; object-fit: cover; border-radius: 8px; border: 2px solid var(--royal-bg); background: #eee; flex-shrink: 0; }
        
        /* TOOLS */
        .delete-btn { position: absolute; top: -12px; right: -12px; background: var(--danger); color: white; border: 3px solid white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s; z-index: 10; }
        .delete-btn:hover { transform: scale(1.15) rotate(90deg); background: #c0392b; }
        
        .drag-handle { cursor: grab; color: #a0aec0; padding: 5px; display: flex; flex-direction: column; justify-content: center; align-items: center; border-right: 1px solid #edf2f7; padding-right: 15px; margin-right: 5px; }
        .drag-handle:hover { color: var(--royal-gold); }
        .drag-handle span { font-size: 24px; line-height: 20px; }

        /* RICH EDITOR */
        .editor-wrapper { flex: 1; display: flex; flex-direction: column; border: 1px solid #cbd5e0; border-radius: 8px; overflow: hidden; }
        .word-toolbar { background: #f7fafc; padding: 8px; border-bottom: 1px solid #cbd5e0; display: flex; gap: 5px; flex-wrap: wrap; }
        .tool-grp { display: flex; gap: 2px; border-right: 1px solid #cbd5e0; padding-right: 8px; margin-right: 3px; align-items: center; }
        .word-toolbar button, .word-toolbar select { padding: 6px 10px; border: 1px solid transparent; background: transparent; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; color: #4a5568; }
        .word-toolbar button:hover { background: #edf2f7; color: var(--royal-bg); }
        .rich-box { padding: 15px; min-height: 120px; outline: none; font-size: 14px; line-height: 1.6; color: #2d3748; overflow-y: auto; background: white; }
        .rich-box:focus { background: #fffdf5; }

        /* OVERLAY LOADING */
        #courage-overlay { position: fixed; inset: 0; background: rgba(10, 26, 60, 0.98); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(10px); }
        #courage-photo { width: 350px; height: 350px; border-radius: 50%; border: 10px solid var(--royal-gold); object-fit: cover; box-shadow: 0 0 50px rgba(204, 164, 59, 0.5); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .upload-label { display: block; padding: 40px; border: 3px dashed #cbd5e0; border-radius: 12px; text-align: center; background: white; cursor: pointer; color: #718096; font-weight: bold; font-size: 1.1rem; transition: 0.2s; }
        .upload-label:hover { border-color: var(--royal-gold); color: var(--royal-bg); background: #fffdf0; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="side-header"><h1>STUDIO CCAS v5</h1><div style="font-size:0.7rem; opacity:0.7; margin-top:5px;">DIRECTION DES FINANCES</div></div>
    <div id="building-list"></div>
    <div style="padding: 20px; background: #08142b;">
        <button onclick="addBati()" style="width:100%; padding:14px; border-radius:8px; border: 2px dashed var(--royal-gold); background:transparent; color:var(--royal-gold); cursor:pointer; font-weight:bold; font-size:14px; margin-bottom: 12px; transition:0.2s;">+ NOUVEAU B√ÇTIMENT</button>
        <button onclick="resetData()" style="width:100%; padding:10px; border-radius:8px; background: #c0392b; border: none; color:white; cursor:pointer; font-size: 11px; font-weight:bold;">‚ö†Ô∏è TOUT REMETTRE √Ä Z√âRO</button>
    </div>
</div>

<div id="main">
    <div id="top-nav">
        <div style="display:flex; align-items:center; gap:20px;">
            <img src="Logo_Cr√©teil_Val_Marne.svg.png" id="main-logo-src" style="height:50px; display:block;" crossorigin="anonymous" onerror="this.src=''; this.alt='‚ö†Ô∏è LOGO MANQUANT SUR GITHUB'; this.style.color='red';">
            <input type="text" id="project-title" class="input-title" placeholder="NOM DU DOSSIER (ex: PLAN FROID 2026)..." oninput="save()">
        </div>
        <div style="display:flex; align-items:center; gap:15px;">
            <span id="save-indicator" style="font-size:11px; font-weight:bold; color:#27ae60; opacity:0; transition: opacity 0.5s;">üíæ SAUVEGARD√â</span>
            <button onclick="generateReport()" class="btn-gen"><span>G√âN√âRER LE FICHIER</span> üöÄ</button>
        </div>
    </div>
    
    <div id="editor-workspace">
        <div id="active-title">Bienvenue au Studio</div>
        <div id="photo-container"></div>
    </div>
</div>

<div id="courage-overlay">
    <img src="courage.jpg.JPG" id="courage-photo">
    <h2 style="color:var(--royal-gold); margin-top:40px; font-size: 3rem; text-transform: uppercase; font-weight: 900; letter-spacing: 3px; text-shadow: 0 5px 15px rgba(0,0,0,0.5);">COURAGE MAMIE ! ‚ù§Ô∏è</h2>
    <p style="color:white; font-size: 1.2rem; opacity: 0.8;">Finalisation du document officiel...</p>
</div>

<script>
    // --- 1. COEUR DU SYST√àME (Donn√©es & Sauvegarde) ---
    let diagnostic = JSON.parse(localStorage.getItem('ccas_master_v5')) || { buildings: {} };
    let activeB = null;
    let dragSrc = null;
    let logoBase64 = "";

    // Chargement initial
    window.onload = () => {
        const img = document.getElementById('main-logo-src');
        if(img.complete) convertLogo(img); else img.onload = () => convertLogo(img);
        
        if(diagnostic.title) document.getElementById('project-title').value = diagnostic.title;
        renderSide();
    };

    function convertLogo(img) {
        try {
            const c = document.createElement('canvas');
            c.width = img.naturalWidth; c.height = img.naturalHeight;
            c.getContext('2d').drawImage(img, 0, 0);
            logoBase64 = c.toDataURL('image/png');
        } catch(e) { console.warn("Logo non converti (local/cors) :", e); }
    }

    function save() {
        diagnostic.title = document.getElementById('project-title').value;
        localStorage.setItem('ccas_master_v5', JSON.stringify(diagnostic));
        const ind = document.getElementById('save-indicator');
        ind.style.opacity = 1; setTimeout(() => ind.style.opacity = 0, 1500);
    }

    function resetData() {
        if(confirm("ATTENTION : Vous allez tout effacer pour recommencer √† z√©ro.\n\nConfirmer ?")) {
            localStorage.removeItem('ccas_master_v5');
            location.reload();
        }
    }

    // --- 2. GESTION DES STRUCTURES (Gauche) ---
    function addBati() {
        const name = prompt("Nom du B√¢timent / Structure :");
        if (name && name.trim()) {
            if(!diagnostic.buildings[name]) {
                diagnostic.buildings[name] = [];
                renderSide();
                switchB(name);
                save();
            } else alert("Ce b√¢timent existe d√©j√† !");
        }
    }

    function renderSide() {
        const list = document.getElementById('building-list'); list.innerHTML = '';
        Object.keys(diagnostic.buildings).forEach(b => {
            const item = document.createElement('div');
            item.className = `b-item ${activeB === b ? 'active' : ''}`;
            item.innerHTML = `<span>${b}</span><span class="del-b-btn" onclick="delB('${b}', event)">√ó</span>`;
            item.onclick = () => switchB(b);
            list.appendChild(item);
        });
    }

    function delB(n, e) {
        e.stopPropagation();
        if(confirm("Supprimer d√©finitivement le dossier : " + n + " ?")) {
            delete diagnostic.buildings[n];
            if(activeB === n) { activeB = null; document.getElementById('photo-container').innerHTML = ''; document.getElementById('active-title').innerText = "Accueil"; }
            renderSide(); save();
        }
    }

    function switchB(name) {
        activeB = name;
        document.getElementById('active-title').innerText = name;
        renderSide();
        renderPhotos();
    }

    // --- 3. GESTION DES PHOTOS (Centre) ---
    function upPhotos(input) {
        if (!activeB) return;
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = e => {
                diagnostic.buildings[activeB].push({ img: e.target.result, desc: "" });
                renderPhotos(); save();
            };
            reader.readAsDataURL(file);
        });
    }

    function delPhoto(idx) {
        if(confirm("Supprimer cette photo ?")) {
            diagnostic.buildings[activeB].splice(idx, 1);
            renderPhotos(); save();
        }
    }

    function renderPhotos() {
        const cont = document.getElementById('photo-container');
        if (!activeB) { cont.innerHTML = '<div style="text-align:center; color:#888; font-style:italic;">Cliquez sur "+ NOUVEAU B√ÇTIMENT" √† gauche pour commencer.</div>'; return; }
        
        cont.innerHTML = `<label class="upload-label">+ AJOUTER DES PHOTOS ICI (S√©lection multiple possible)<input type="file" multiple onchange="upPhotos(this)" style="display:none;"></label>`;

        diagnostic.buildings[activeB].forEach((p, i) => {
            const card = document.createElement('div');
            card.className = 'photo-entry';
            card.draggable = true;
            card.dataset.index = i;
            
            card.innerHTML = `
                <div class="delete-btn" onclick="delPhoto(${i})" title="Supprimer">√ó</div>
                <div class="card-layout">
                    <div class="drag-handle" title="Maintenir pour d√©placer"><span>‚†ø</span></div>
                    <img src="${p.img}" class="preview-img">
                    <div class="editor-wrapper" onpointerdown="event.stopPropagation()">
                        <div class="word-toolbar">
                            <div class="tool-grp"><button onclick="cmd('bold')"><b>G</b></button><button onclick="cmd('italic')"><i>I</i></button><button onclick="cmd('underline')"><u>S</u></button></div>
                            <div class="tool-grp"><select onchange="cmd('fontSize', this.value)"><option value="3">Taille</option><option value="2">Petit</option><option value="5">Grand</option><option value="6">Titre</option></select></div>
                            <div class="tool-grp">
                                <button onclick="cmd('justifyLeft')">‚á§</button><button onclick="cmd('justifyCenter')">‚áπ</button>
                                <button onclick="cmd('insertUnorderedList')">‚Ä¢ Liste</button>
                            </div>
                            <div class="tool-grp">
                                <input type="color" onchange="cmd('foreColor', this.value)" title="Couleur Texte">
                                <button onclick="cmd('hiliteColor', '#FFFF00')" title="Surligneur Jaune" style="background:#FFFF00; color:black;">üñçÔ∏è</button>
                            </div>
                        </div>
                        <div class="rich-box" contenteditable="true" 
                             oninput="diagnostic.buildings['${activeB}'][${i}].desc = this.innerHTML; save()"
                             onpaste="setTimeout(save, 100)">${p.desc}</div>
                    </div>
                </div>`;
            
            // Drag & Drop Robuste
            card.addEventListener('dragstart', () => { dragSrc = card; card.classList.add('dragging'); });
            card.addEventListener('dragover', e => e.preventDefault());
            card.addEventListener('drop', () => {
                if (dragSrc !== card) {
                    const list = diagnostic.buildings[activeB];
                    const from = parseInt(dragSrc.dataset.index);
                    const to = parseInt(card.dataset.index);
                    const moved = list.splice(from, 1)[0];
                    list.splice(to, 0, moved);
                    renderPhotos(); save();
                }
            });
            card.addEventListener('dragend', () => card.classList.remove('dragging'));
            
            cont.appendChild(card);
        });
    }

    function cmd(c, v = null) { document.execCommand(c, false, v); }

    // --- 4. MOTEUR DE G√âN√âRATION (Le Rapport Final) ---
    function generateReport() {
        const title = document.getElementById('project-title').value || "Diagnostic_CCAS";
        document.getElementById('courage-overlay').style.display = 'flex';
        
        // Utilisation du logo s√©curis√© ou repli sur le fichier
        const finalLogo = logoBase64 || "Logo_Cr√©teil_Val_Marne.svg.png";

        setTimeout(() => {
            const dataStr = JSON.stringify(diagnostic).replace(/</g, '\\u003c'); // S√©curit√© script
            
            // TEMPLATE HTML FINAL INJECT√â
            const html = `<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><title>${title}</title><style>
                :root { --bg: #0A1A3C; --gold: #CCA43B; --txt: #F4F7FD; }
                body { font-family: 'Segoe UI', 'Helvetica Neue', sans-serif; margin: 0; display: flex; height: 100vh; background: #000; color: var(--txt); overflow: hidden; }
                
                /* NAVIGATION GAUCHE */
                #side { width: 280px; background: #050E24; border-right: 3px solid var(--gold); display: flex; flex-direction: column; z-index: 10; box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
                .nav-title { padding: 25px; color: var(--gold); font-weight: 800; border-bottom: 1px solid #1f2d40; text-transform: uppercase; font-size: 14px; letter-spacing: 1px; text-align:center; }
                .nav-scroll { flex:1; overflow-y:auto; }
                .nav-btn { width: 100%; padding: 20px 25px; text-align: left; border: none; background: none; color: #8E8E93; cursor: pointer; border-bottom: 1px solid #111; font-size: 14px; transition: 0.3s; }
                .nav-btn:hover { background: rgba(255,255,255,0.05); color: white; padding-left: 30px; }
                .nav-btn.active { color: var(--gold); background: rgba(204, 164, 59, 0.1); border-left: 5px solid var(--gold); font-weight: bold; }

                /* ZONE PRINCIPALE */
                #main { flex: 1; display: flex; flex-direction: column; position: relative; background: radial-gradient(circle at center, #142850, #0A1A3C); }
                
                /* --- ZONE SANCTUARIS√âE (Logo + Texte) --- 
                   Position absolue Top Right.
                   Padding Right sur le Viewer garantit que l'image ne touche jamais cette zone.
                */
                .header-zone { position: absolute; top: 25px; right: 25px; text-align: right; z-index: 50; pointer-events: none; }
                .header-logo { width: 180px; margin-bottom: 10px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4)); }
                .header-text { margin: 0; font-size: 0.75rem; color: var(--gold); font-weight: 700; text-transform: uppercase; line-height: 1.4; letter-spacing: 0.5px; width: 250px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

                /* VIEWER AVEC COULOIR DE S√âCURIT√â √Ä DROITE */
                .viewer-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px; padding-right: 300px; /* <--- LE COULOIR DE S√âCURIT√â */ }
                
                /* CADRE 16:9 FIXE ET √âL√âGANT */
                .frame { width: 100%; max-width: 1400px; aspect-ratio: 16/9; border: 4px solid var(--gold); background: #000; display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 0 80px rgba(0,0,0,0.8); border-radius: 2px; }
                .frame img { width: 100%; height: 100%; object-fit: contain; } /* L'image s'adapte sans d√©former */

                /* NAVIGATION FL√àCHES */
                .arr { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(10, 26, 60, 0.8); color: var(--gold); border: 2px solid var(--gold); padding: 20px; cursor: pointer; border-radius: 50%; font-size: 30px; z-index: 60; transition: 0.2s; display: flex; align-items: center; justify-content: center; width: 60px; height: 60px; }
                .arr:hover { background: var(--gold); color: #000; scale: 1.1; }
                .arr-left { left: -35px; } .arr-right { right: -35px; }

                /* DESCRIPTION BASSE */
                .desc-box { padding: 35px 50px; background: rgba(5, 14, 36, 0.95); border-top: 4px solid var(--gold); min-height: 150px; z-index: 40; box-shadow: 0 -10px 30px rgba(0,0,0,0.5); backdrop-filter: blur(10px); }
                .desc-title { margin: 0 0 15px 0; color: var(--gold); font-size: 1.8rem; text-transform: uppercase; font-weight: 300; letter-spacing: 2px; border-bottom: 1px solid rgba(204, 164, 59, 0.3); padding-bottom: 10px; display: inline-block; }
                .desc-content { font-size: 1.3rem; line-height: 1.6; font-weight: 300; color: #eef; }
                /* Preservation du formatage riche */
                .desc-content ul { padding-left: 20px; } .desc-content strong { color: white; font-weight: 600; }
            </style></head><body>
            <div id="side">
                <div class="nav-title">${title}</div>
                <div id="nav-list" class="nav-scroll"></div>
            </div>
            <div id="main">
                <div class="header-zone">
                    <img src="${finalLogo}" class="header-logo">
                    <p class="header-text">DIRECTION DES FINANCES ET DES<br>MOYENS G√âN√âRAUX DU CCAS</p>
                </div>
                <div class="viewer-container">
                    <div class="frame" id="frame-box">
                        <div id="img-slot" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;"></div>
                    </div>
                </div>
                <div class="desc-box">
                    <h2 id="b-name" class="desc-title"></h2>
                    <div id="txt-content" class="desc-content"></div>
                </div>
            </div>
            <script>
                const data = ${dataStr}; 
                let curB = Object.keys(data.buildings)[0]; 
                let curI = 0;

                function renderNav() {
                    const list = document.getElementById('nav-list'); list.innerHTML = '';
                    Object.keys(data.buildings).forEach(k => {
                        const btn = document.createElement('button');
                        btn.className = 'nav-btn' + (curB === k ? ' active' : '');
                        btn.innerText = k;
                        btn.onclick = () => { curB = k; curI = 0; show(); renderNav(); };
                        list.appendChild(btn);
                    });
                }

                function show() {
                    const slot = document.getElementById('img-slot');
                    const frame = document.getElementById('frame-box');
                    const items = data.buildings[curB];

                    if(!items || items.length === 0) { 
                        slot.innerHTML = '<div style="color:#666; font-style:italic;">Aucune photo dans ce dossier</div>';
                        document.getElementById('b-name').innerText = curB;
                        document.getElementById('txt-content').innerHTML = "";
                        frame.querySelectorAll('.arr').forEach(a => a.remove());
                        return; 
                    }

                    // Injection image
                    slot.innerHTML = '<img src="' + items[curI].img + '">';
                    document.getElementById('b-name').innerText = curB;
                    document.getElementById('txt-content').innerHTML = items[curI].desc || "<i>Aucune observation saisie.</i>";

                    // Gestion Fl√®ches
                    frame.querySelectorAll('.arr').forEach(a => a.remove());
                    if (items.length > 1) {
                        const l = document.createElement('div'); l.className = 'arr arr-left'; l.innerHTML = '‚ùÆ';
                        l.onclick = () => { curI = (curI - 1 + items.length) % items.length; show(); };
                        const r = document.createElement('div'); r.className = 'arr arr-right'; r.innerHTML = '‚ùØ';
                        r.onclick = () => { curI = (curI + 1) % items.length; show(); };
                        frame.appendChild(l); frame.appendChild(r);
                    }
                }

                window.onload = () => { if(curB) { renderNav(); show(); } };
            <\/script></body></html>`;
            
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // Nettoyage nom de fichier
            const safeName = title.replace(/[^a-z0-9]/gi, '_').toLowerCase() || "rapport_ccas";
            a.download = safeName + ".html";
            a.click();
            
            setTimeout(() => { document.getElementById('courage-overlay').style.display = 'none'; }, 2000);
        }, 1000);
    }
</script>
</body>
</html>
