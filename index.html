<!DOCTYPE html><html lang="fr"><head>
    <meta charset="UTF-8">
    <title>STUDIO CCAS | Cloud Expert</title>
    <style>
        :root { --blue: #0A1A3C; --gold: #CCA43B; --bg: #f4f7f9; --green: #27ae60; --cloud: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* HEADER */
        .main-header { background: var(--blue); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 100; }
        .cloud-status { background: var(--cloud); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; cursor: pointer; }
        
        #view-dashboard { flex:1; padding: 40px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; }
        .folder-card { background: white; border-radius: 15px; padding: 30px; text-align: center; cursor: pointer; border: 1px solid #ddd; position: relative; }
        .folder-card:hover { border-color: var(--gold); }

        #view-studio { display: none; height: calc(100vh - 70px); flex-direction: row; }
        #sidebar { width: 300px; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .bat-nav-item { padding: 15px 20px; border-bottom: 1px solid #eee; cursor: pointer; }
        .bat-nav-item.active { background: var(--blue); color: white; }
        
        #editor-content { flex: 1; background: #edf0f5; display: flex; flex-direction: column; }
        .toolbar-top { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        
        .photo-card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; display: flex; gap: 20px; border-left: 5px solid var(--gold); }
        .img-container img { width: 220px; height: 150px; object-fit: cover; border-radius: 8px; }
        
        .text-area { flex: 1; min-height: 100px; padding: 10px; border: 1px solid #eee; border-radius: 6px; outline: none; background: #fafafa; }
        .btn-expert { background: var(--green); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        #overlay { position: fixed; inset: 0; background: var(--blue); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .img-courage { width: 250px; height: 250px; border-radius: 50%; border: 6px solid var(--gold); object-fit: cover; }
    </style>
</head>
<body>

<img src="Logo_Cr√©teil_Val_Marne.svg.png" id="sys-logo" style="display:none" crossorigin="anonymous">

<div class="main-header">
    <div style="display:flex; align-items:center; gap:15px;">
        <h2 style="margin:0;">STUDIO <span style="color:var(--gold)">CCAS</span></h2>
        <div id="cloud-indicator" class="cloud-status" onclick="syncCloud()">‚òÅÔ∏è CLOUD : SYNCHRONISER</div>
    </div>
</div>

<div id="view-dashboard">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h1 style="color:var(--blue); margin:0;">Mes Rapports</h1>
        <button onclick="createProj()" style="background:var(--blue); color:white; border:none; padding:15px 30px; border-radius:10px; font-weight:bold; cursor:pointer;">+ NOUVEAU DOSSIER</button>
    </div>
    <div id="grid-projects" class="grid"></div>
</div>

<div id="view-studio">
    <div id="sidebar">
        <button onclick="goDashboard()" style="padding:20px; background:#f8f9fa; border:none; border-bottom:1px solid #ddd; cursor:pointer; font-weight:bold;">‚¨Ö RETOUR</button>
        <div id="list-bat" style="flex:1; overflow-y:auto;"></div>
        <button onclick="newBat()" style="padding:20px; background:var(--blue); color:white; border:none; font-weight:bold; cursor:pointer;">+ B√ÇTIMENT</button>
    </div>
    <div id="editor-content">
        <div class="toolbar-top">
            <h2 id="lbl-bat" style="margin:0; color:var(--blue);">B√¢timent</h2>
            <button class="btn-expert" onclick="generateFinal()">üöÄ G√âN√âRER LE RAPPORT POUR LES CHEFS</button>
        </div>
        <div id="area-photos" style="flex:1; padding:30px; overflow-y:auto;"></div>
    </div>
</div>

<div id="overlay">
    <img src="courage.jpg.JPG" class="img-courage" onerror="this.src='https://via.placeholder.com/250?text=COURAGE+MAMAN'">
    <h1 style="color:var(--gold); margin:20px 0 0 0;">COURAGE MAMAN ! ‚ù§Ô∏è</h1>
    <p id="overlay-txt">Cr√©ation du fichier interactif...</p>
</div>

<input type="file" id="photo-input" style="display:none" multiple onchange="processPhotos(this)">

<script>
    const CLOUD_ID = "ccas_maman_" + btoa("finance_creteil"); 
    let db = JSON.parse(localStorage.getItem('ccas_expert_v16')) || {};
    let curP = null, curB = null, logoData = "";

    window.onload = () => { refreshGrid(); imgTo64(); syncCloud(true); };

    function imgTo64() {
        const img = document.getElementById('sys-logo');
        img.onload = () => {
            const c = document.createElement('canvas');
            c.width = img.width; c.height = img.height;
            c.getContext('2d').drawImage(img, 0, 0);
            logoData = c.toDataURL();
        };
    }

    async function syncCloud(silent = false) {
        try {
            if(!silent) document.getElementById('overlay').style.display = 'flex';
            const res = await fetch(`https://api.keyvalue.xyz/${CLOUD_ID}/data`);
            if(res.ok) {
                const cloudData = await res.json();
                if(!silent && confirm("Donn√©es trouv√©es sur le Cloud ! R√©cup√©rer ?")) {
                    db = cloudData; save(false); refreshGrid();
                }
            }
            document.getElementById('overlay').style.display = 'none';
        } catch (e) { console.log("Cloud non joignable"); }
    }

    function save(pushCloud = true) {
        localStorage.setItem('ccas_expert_v16', JSON.stringify(db));
        if(pushCloud) fetch(`https://api.keyvalue.xyz/${CLOUD_ID}/data`, { method: 'POST', body: JSON.stringify(db) });
    }

    function refreshGrid() {
        const g = document.getElementById('grid-projects'); g.innerHTML = '';
        Object.keys(db).forEach(id => {
            const div = document.createElement('div'); div.className = 'folder-card';
            div.innerHTML = `<div onclick="event.stopPropagation(); delete db['${id}']; save(); refreshGrid();" style="position:absolute; top:10px; right:10px; color:red;">üóëÔ∏è</div><h3>üìÇ ${db[id].name}</h3>`;
            div.onclick = () => openProj(id);
            g.appendChild(div);
        });
    }

    function createProj() { const n = prompt("Nom du dossier :"); if(n) { const id = Date.now().toString(); db[id] = { name:n, data:{} }; save(); openProj(id); } }
    function openProj(id) { curP = id; curB = null; document.getElementById('view-dashboard').style.display='none'; document.getElementById('view-studio').style.display='flex'; refreshSide(); refreshMain(); }
    function goDashboard() { document.getElementById('view-studio').style.display='none'; document.getElementById('view-dashboard').style.display='flex'; refreshGrid(); }
    function newBat() { const n = prompt("Nom du b√¢timent :"); if(n) { db[curP].data[n] = []; save(); openBat(n); } }
    function refreshSide() {
        const l = document.getElementById('list-bat'); l.innerHTML = '';
        Object.keys(db[curP].data).forEach(b => {
            const div = document.createElement('div'); div.className = 'bat-nav-item' + (curB === b ? ' active' : '');
            div.innerText = b; div.onclick = () => openBat(b); l.appendChild(div);
        });
    }
    function openBat(b) { curB = b; document.getElementById('lbl-bat').innerText = b; refreshSide(); refreshMain(); }
    function refreshMain() {
        const area = document.getElementById('area-photos'); area.innerHTML = '';
        if(!curB) return;
        area.innerHTML = `<button onclick="document.getElementById('photo-input').click()" style="width:100%; padding:20px; margin-bottom:20px;">üì∏ AJOUTER PHOTOS</button>`;
        db[curP].data[curB].forEach((p, i) => {
            const div = document.createElement('div'); div.className = 'photo-card';
            div.innerHTML = `<div class="img-container"><img src="${p.img}"></div>
                <div class="text-area" contenteditable="true" oninput="db[curP].data[curB][${i}].desc=this.innerHTML; save()">${p.desc}</div>
                <button onclick="db[curP].data[curB].splice(${i},1); save(); refreshMain();" style="color:red; border:none; background:none; cursor:pointer;">‚ùå</button>`;
            area.appendChild(div);
        });
    }

    function processPhotos(input) {
        Array.from(input.files).forEach(f => {
            const r = new FileReader();
            r.onload = e => { db[curP].data[curB].push({img: e.target.result, desc: "Notes..."}); save(); refreshMain(); };
            r.readAsDataURL(f);
        });
    }

    function generateFinal() {
        const proj = db[curP];
        document.getElementById('overlay').style.display = 'flex';
        setTimeout(() => {
            const json = JSON.stringify(proj.data).replace(/</g, '\\u003c');
            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${proj.name}</title><style>
                body{font-family:sans-serif;margin:0;display:flex;height:100vh;background:#050E24;color:white;overflow:hidden}
                #side{width:260px;background:#0A1A3C;border-right:3px solid #CCA43B}
                .btn{width:100%;padding:15px;text-align:left;border:none;background:none;color:#8E8E93;cursor:pointer;border-bottom:1px solid #1f2d40}
                .btn.active{color:#CCA43B;background:rgba(204,164,59,0.1);border-left:5px solid #CCA43B;font-weight:bold}
                #main{flex:1;display:flex;flex-direction:column;position:relative;background:radial-gradient(circle,#142850,#050E24)}
                .top-logo{position:absolute;top:20px;right:25px;display:flex;align-items:center;gap:12px;background:rgba(10,26,60,0.85);padding:10px;border:1px solid #CCA43B;border-radius:6px}
                .logo-img{width:50px}
                .frame{flex:1;display:flex;align-items:center;justify-content:center;padding:40px}
                .frame img{max-width:95%;max-height:95%;border:3px solid #CCA43B;box-shadow:0 0 50px #000}
                .bot{padding:30px;background:rgba(5,14,36,0.95);border-top:3px solid #CCA43B}
                .arr{position:absolute;top:50%;transform:translateY(-50%);background:#CCA43B;color:#0A1A3C;width:50px;height:50px;display:flex;align-items:center;justify-content:center;border-radius:50%;cursor:pointer;font-weight:bold}
            </style></head><body>
                <div id="side"><div style="padding:20px;color:#CCA43B;font-weight:bold">${proj.name}</div><div id="nav"></div></div>
                <div id="main">
                    <div class="top-logo"><img src="${logoData}" class="logo-img"><div style="font-size:9px;color:#CCA43B;font-weight:bold">DIRECTION G√âN√âRALE<br>DES FINANCES</div></div>
                    <div class="frame" id="fr"><div id="sc"></div></div>
                    <div class="bot"><h2 id="tit" style="color:#CCA43B;margin:0"></h2><div id="desc" style="margin-top:10px"></div></div>
                </div>
                <script>
                const d=${json};let cB=Object.keys(d)[0],cI=0;
                function sh(){
                    const s=document.getElementById('sc'),f=document.getElementById('fr'),i=d[cB];
                    if(!i||!i.length)return;
                    s.innerHTML='<img src="'+i[cI].img+'">';
                    document.getElementById('tit').innerText=cB; document.getElementById('desc').innerHTML=i[cI].desc;
                    document.querySelectorAll('.arr').forEach(a=>a.remove());
                    if(i.length>1){
                        const l=document.createElement('div');l.className='arr';l.style.left='20px';l.innerHTML='‚ùÆ';l.onclick=()=>{cI=(cI-1+i.length)%i.length;sh()};
                        const r=document.createElement('div');r.className='arr';r.style.right='20px';r.innerHTML='‚ùØ';r.onclick=()=>{cI=(cI+1)%i.length;sh()};
                        f.appendChild(l);f.appendChild(r);
                    }
                }
                function rn(){const n=document.getElementById('nav');n.innerHTML='';Object.keys(d).forEach(k=>{const b=document.createElement('button');b.className='btn'+(cB===k?' active':'');b.innerText=k;b.onclick=()=>{cB=k;cI=0;sh();rn()};n.appendChild(b)})}
                window.onload=()=>{rn();sh()};
                <\/script></body></html>`;
            
            // --- LA SOLUTION : ON PASSE EN HTML MAIS AVEC UN NOM CLAIR ---
            const b = new Blob([html], {type: 'text/html'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = proj.name + "_INTERACTIF.html";
            a.click();
            document.getElementById('overlay').style.display='none';
        }, 1500);
    }
</script>
</body></html>
