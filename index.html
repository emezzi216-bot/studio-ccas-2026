<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Studio CCAS | v55 D√âBLOCAGE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --blue: #0A1A3C; --gold: #CCA43B; --bg: #f0f2f5; --white: #fff; --green: #27ae60; --red: #c0392b; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        * { box-sizing: border-box; outline: none; }
        
        /* HEADER */
        .header { height: 60px; background: var(--white); border-bottom: 3px solid var(--gold); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .logo { font-size: 1.2rem; font-weight: bold; color: var(--blue); }
        .btn { padding: 8px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .btn-green { background: var(--green); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-outline { background: white; border: 2px solid #ccc; color: #333; }

        /* VUES */
        #dashboard, #studio { flex: 1; overflow: hidden; display: flex; }
        #dashboard { flex-direction: column; padding: 40px; align-items: center; }
        #studio { display: none; flex-direction: row; }

        /* DASHBOARD */
        .big-btn { padding: 20px 40px; font-size: 1.2rem; background: var(--blue); color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 50px; }
        .file-zone { margin-top: 20px; border: 2px dashed #ccc; padding: 20px; border-radius: 8px; cursor: pointer; background: white; }

        /* STUDIO: SIDEBAR */
        .sidebar { width: 280px; background: var(--blue); color: white; display: flex; flex-direction: column; }
        .side-top { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .bat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .bat-item { padding: 10px; background: rgba(255,255,255,0.1); margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; }
        .bat-item.active { background: var(--gold); color: black; font-weight: bold; }
        .add-bat { padding: 15px; border-top: 1px solid rgba(255,255,255,0.2); text-align: center; }
        .btn-add-bat { width: 100%; padding: 10px; background: transparent; border: 1px dashed white; color: white; cursor: pointer; }

        /* STUDIO: MAIN */
        .main { flex: 1; background: #eef2f6; display: flex; flex-direction: column; }
        .toolbar { height: 60px; background: white; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .content { flex: 1; overflow-y: auto; padding: 30px; }

        /* PHOTO CARD */
        .block { background: white; padding: 10px; margin-bottom: 20px; display: flex; height: 250px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-radius: 8px; }
        .block-img { width: 250px; background: #eee; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 15px; position: relative; }
        .block-img img { max-width: 100%; max-height: 180px; }
        .block-txt { flex: 1; display: flex; flex-direction: column; }
        .editable { flex: 1; border: 1px solid #ddd; padding: 10px; overflow-y: auto; font-family: sans-serif; }
        
        .handle { cursor: grab; background: #f0f0f0; width: 30px; display: flex; align-items: center; justify-content: center; margin-right: 10px; color: #999; }
        .del-btn { position: absolute; top: 5px; right: 5px; background: red; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; }

        /* LOADING */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .bar { width: 300px; height: 20px; background: #ddd; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .fill { height: 100%; width: 0%; background: var(--green); transition: 0.3s; }
    </style>
</head>
<body>

<div id="loader">
    <h2 style="color:#0A1A3C">Traitement des photos...</h2>
    <div class="bar"><div class="fill" id="progress"></div></div>
</div>

<div id="dashboard">
    <div class="header">
        <div class="logo">STUDIO CCAS v55</div>
    </div>
    <button class="big-btn" onclick="newProject()">+ NOUVEAU DOSSIER</button>
    
    <div class="file-zone" onclick="document.getElementById('file-load').click()">
        üìÇ OU REPRENDRE UNE SAUVEGARDE (.json)
    </div>
</div>

<div id="studio">
    <div class="sidebar">
        <div class="side-top">
            <button onclick="saveToPC()" class="btn btn-green" style="width:100%; justify-content:center;">üíæ SAUVEGARDE PC</button>
            <br><br>
            <button onclick="goHome()" style="background:none; border:none; color:white; cursor:pointer;">‚¨ÖÔ∏è Retour</button>
            <div id="proj-title" style="text-align:center; font-weight:bold; margin-top:10px;">PROJET</div>
        </div>
        <div id="list-bat" class="bat-list"></div>
        <div class="add-bat">
            <button class="btn-add-bat" onclick="addBat()">+ RUBRIQUE</button>
        </div>
    </div>
    
    <div class="main">
        <div class="toolbar">
            <h3 id="bat-title" style="color:var(--blue); margin:0;">Accueil</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-blue" onclick="document.getElementById('file-photo').click()">üì∏ AJOUTER PHOTOS</button>
                <button class="btn btn-outline" onclick="generateZip()">üì¶ G√âN√âRER PDF/SITE</button>
            </div>
        </div>
        <div id="content" class="content"></div>
    </div>
</div>

<input type="file" id="file-photo" multiple accept="image/*" style="display:none" onchange="processPhotos(this)">
<input type="file" id="file-load" style="display:none" onchange="loadFile(this)">

<script>
// --- DONN√âES (RAM) ---
let app = { 
    name: "Nouveau Projet", 
    data: {} // Structure: { "Cuisine": [ {img: "data...", text: "desc"} ], "Salon": [] }
};
let curBat = null;
let dragSrc = null;

// --- NAVIGATION ---
function newProject() {
    let n = prompt("Nom du dossier :");
    if(!n) return;
    app = { name: n, data: {} };
    app.data["Zone 1"] = []; // Cr√©ation auto d'une zone pour √©viter le bug
    openStudio();
    selectBat("Zone 1");
}

function openStudio() {
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('studio').style.display = 'flex';
    document.getElementById('proj-title').innerText = app.name;
    renderSide();
}

function goHome() {
    if(confirm("Attention : Avez-vous cliqu√© sur 'SAUVEGARDE PC' ? Sinon tout sera perdu.")) {
        document.getElementById('studio').style.display = 'none';
        document.getElementById('dashboard').style.display = 'flex';
    }
}

// --- GESTION BATIMENTS ---
function addBat() {
    let n = prompt("Nom de la rubrique :");
    if(n) {
        if(!app.data[n]) app.data[n] = [];
        renderSide();
        selectBat(n);
    }
}

function renderSide() {
    let list = document.getElementById('list-bat');
    list.innerHTML = "";
    Object.keys(app.data).forEach(k => {
        let div = document.createElement('div');
        div.className = "bat-item " + (curBat === k ? "active" : "");
        div.innerHTML = `<span>${k}</span> <span onclick="delBat('${k}', event)" style="color:red;font-weight:bold;">√ó</span>`;
        div.onclick = () => selectBat(k);
        list.appendChild(div);
    });
}

function selectBat(k) {
    curBat = k;
    document.getElementById('bat-title').innerText = k;
    renderSide(); // Pour mettre √† jour la classe active
    renderContent();
}

function delBat(k, e) {
    e.stopPropagation();
    if(confirm("Supprimer la rubrique "+k+" ?")) {
        delete app.data[k];
        if(curBat === k) curBat = Object.keys(app.data)[0] || null;
        renderSide();
        if(curBat) selectBat(curBat); else document.getElementById('content').innerHTML = "";
    }
}

// --- PHOTOS (LE COEUR DU PROBLEME) ---
function processPhotos(input) {
    // 1. AUTO-CORRECTION : Si aucune rubrique s√©lectionn√©e, on prend la premi√®re ou on en cr√©e une
    if(!curBat) {
        let keys = Object.keys(app.data);
        if(keys.length === 0) {
            app.data["Zone 1"] = [];
            curBat = "Zone 1";
        } else {
            curBat = keys[0];
        }
        selectBat(curBat);
        alert("‚ö†Ô∏è Aucune rubrique n'√©tait s√©lectionn√©e. Les photos iront dans : " + curBat);
    }

    if(!input.files.length) return;

    let loader = document.getElementById('loader');
    let bar = document.getElementById('progress');
    loader.style.display = "flex";
    
    let files = Array.from(input.files);
    let done = 0;

    files.forEach(f => {
        let reader = new FileReader();
        reader.onload = function(e) {
            // Compression via Canvas pour √©viter saturation m√©moire
            let img = new Image();
            img.onload = function() {
                let canvas = document.createElement('canvas');
                let ctx = canvas.getContext('2d');
                let max = 1000; // Largeur max
                let w = img.width; 
                let h = img.height;
                
                if(w > max) { h *= max/w; w = max; }
                
                canvas.width = w;
                canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                
                // Ajout des donn√©es
                app.data[curBat].push({
                    img: canvas.toDataURL("image/jpeg", 0.7),
                    text: "Description..."
                });

                done++;
                bar.style.width = (done / files.length * 100) + "%";
                
                if(done === files.length) {
                    setTimeout(() => {
                        loader.style.display = "none";
                        renderContent();
                    }, 500);
                }
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(f);
    });
    input.value = ""; // Reset pour permettre de remettre les m√™mes photos
}

function renderContent() {
    let div = document.getElementById('content');
    div.innerHTML = "";
    
    if(!curBat || !app.data[curBat]) return;

    app.data[curBat].forEach((item, idx) => {
        let b = document.createElement('div');
        b.className = "block";
        b.draggable = true;
        b.innerHTML = `
            <div class="handle">‚†ø</div>
            <div class="block-img">
                <div class="del-btn" onclick="delPhoto(${idx})">√ó</div>
                <img src="${item.img}">
            </div>
            <div class="block-txt">
                <div class="editable" contenteditable="true" oninput="updateText(${idx}, this.innerHTML)">${item.text}</div>
            </div>
        `;
        
        // Drag & Drop simplifi√©
        b.ondragstart = (e) => { dragSrc = idx; e.dataTransfer.effectAllowed = 'move'; };
        b.ondragover = (e) => { e.preventDefault(); };
        b.ondrop = (e) => {
            e.stopPropagation();
            let arr = app.data[curBat];
            let val = arr.splice(dragSrc, 1)[0];
            arr.splice(idx, 0, val);
            renderContent();
        };

        div.appendChild(b);
    });
}

function updateText(idx, txt) { app.data[curBat][idx].text = txt; }
function delPhoto(idx) { 
    if(confirm("Supprimer ?")) {
        app.data[curBat].splice(idx, 1);
        renderContent();
    }
}

// --- SAUVEGARDE ---
function saveToPC() {
    let str = JSON.stringify(app);
    let blob = new Blob([str], {type: "application/json"});
    let a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "CCAS_" + app.name.replace(/\s/g,'_') + ".json";
    a.click();
    alert("‚úÖ Fichier de sauvegarde t√©l√©charg√© !");
}

function loadFile(input) {
    let f = input.files[0];
    if(!f) return;
    let r = new FileReader();
    r.onload = function(e) {
        try {
            app = JSON.parse(e.target.result);
            openStudio();
            // S√©lectionne le premier batiment
            let keys = Object.keys(app.data);
            if(keys.length > 0) selectBat(keys[0]);
        } catch(err) {
            alert("Erreur de fichier");
        }
    };
    r.readAsText(f);
}

// --- GENERATION FINALE ---
function generateZip() {
    if(typeof JSZip === "undefined") { alert("Erreur : Moteur ZIP non charg√©. V√©rifiez votre connexion internet au lancement."); return; }
    
    let zip = new JSZip();
    let safeName = app.name.replace(/[^a-z0-9]/gi, '_');
    
    // HTML Template (Celui que vous aimez : Noir/Or/Blanc)
    let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${app.name}</title>
    <style>
        body { margin:0; background:#050505; color:white; font-family:sans-serif; height:100vh; display:flex; overflow:hidden; }
        #sidebar { width:250px; background:#0A1A3C; border-right:3px solid #CCA43B; display:flex; flex-direction:column; }
        .btn { padding:15px; color:#aaa; background:none; border:none; text-align:left; cursor:pointer; border-bottom:1px solid #333; width:100%; font-size:16px; }
        .btn.active { color:#CCA43B; font-weight:bold; background:rgba(255,255,255,0.1); border-left:5px solid #CCA43B; }
        #main { flex:1; display:flex; flex-direction:column; }
        #top { height:75vh; display:flex; align-items:center; justify-content:center; border-bottom:3px solid #CCA43B; position:relative; background:black; }
        #bot { height:25vh; padding:20px 40px; background:#111; overflow-y:auto; box-sizing:border-box; }
        img { max-width:100%; max-height:100%; object-fit:contain; }
        #titre { color:#CCA43B; text-transform:uppercase; border-bottom:1px solid #333; padding-bottom:10px; margin-top:0; }
        #desc { color:white; font-size:18px; line-height:1.6; }
        .nav-btn { position:absolute; top:50%; transform:translateY(-50%); background:rgba(204,164,59,0.5); color:white; border:none; font-size:40px; padding:10px; cursor:pointer; }
        .prev { left:20px; } .next { right:20px; }
        .pdf-btn { position:absolute; top:10px; left:10px; background:#c0392b; color:white; padding:5px 10px; border:none; border-radius:4px; font-weight:bold; cursor:pointer; z-index:99; }
        @media print { #sidebar, .nav-btn, .pdf-btn { display:none; } #top { height:70vh; page-break-inside:avoid; } #bot { height:30vh; page-break-after:always; } }
    </style></head><body>
    <button class="pdf-btn" onclick="window.print()">üñ®Ô∏è PDF</button>
    <div id="sidebar"><div style="padding:20px; text-align:center; font-weight:bold; color:#CCA43B; border-bottom:1px solid #333;">${app.name}</div><div id="nav"></div></div>
    <div id="main"><div id="top"><img id="img"><div class="nav-btn prev" onclick="move(-1)">‚ùÆ</div><div class="nav-btn next" onclick="move(1)">‚ùØ</div></div><div id="bot"><h2 id="titre"></h2><div id="desc"></div></div></div>
    <script>
        var data = ${JSON.stringify(app.data)};
        var keys = Object.keys(data);
        var cb = keys[0];
        var ci = 0;
        function render() {
            var n = document.getElementById('nav'); n.innerHTML="";
            keys.forEach(k => {
                var b = document.createElement('button'); b.className="btn "+(cb===k?"active":""); b.innerText=k;
                b.onclick = function(){ cb=k; ci=0; show(); render(); }; n.appendChild(b);
            });
        }
        function show() {
            var arr = data[cb];
            if(!arr || !arr.length) { document.getElementById('img').src=""; document.getElementById('desc').innerText="Vide"; return; }
            document.getElementById('img').src = arr[ci].img;
            document.getElementById('desc').innerHTML = arr[ci].text;
            document.getElementById('titre').innerText = cb + " (" + (ci+1) + "/" + arr.length + ")";
        }
        function move(d) {
            var arr = data[cb];
            ci += d;
            if(ci < 0) ci = arr.length-1;
            if(ci >= arr.length) ci = 0;
            show();
        }
        if(keys.length) { render(); show(); }
    <\/script></body></html>`;

    zip.file("Dossier_CCAS.html", html);
    zip.generateAsync({type:"blob"}).then(function(content) {
        let a = document.createElement('a');
        a.href = URL.createObjectURL(content);
        a.download = "Dossier_" + safeName + ".zip";
        a.click();
    });
}
</script>
</body>
</html>
