<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Studio CCAS - √âdition Premium</title>
    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-gold: #D4AF37;
            --ios-text: #1C1C1E;
            --ios-silver: #E5E5EA;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            margin: 0;
            background: var(--ios-bg);
            color: var(--ios-text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* En-t√™te Flou (Glassmorphism) */
        header {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid var(--ios-silver);
            z-index: 10;
        }

        #editor-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .card {
            background: var(--ios-card);
            border-radius: 24px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
            border: 1px solid rgba(212, 175, 55, 0.1);
        }

        input[type="text"] {
            width: 100%;
            padding: 15px;
            border-radius: 14px;
            border: 1px solid var(--ios-silver);
            font-size: 1rem;
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus { border-color: var(--ios-gold); }

        .btn {
            padding: 15px 30px;
            border-radius: 50px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-gold {
            background: linear-gradient(135deg, #D4AF37, #F4EBD0);
            color: #5C4412;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .btn-gold:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(212, 175, 55, 0.5); }

        .img-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .img-box {
            position: relative;
            border-radius: 18px;
            overflow: hidden;
            aspect-ratio: 1;
            background: #eee;
        }

        .img-box img { width: 100%; height: 100%; object-fit: cover; }

        /* Pied de page avec bouton de t√©l√©chargement */
        footer {
            padding: 20px;
            background: white;
            border-top: 1px solid var(--ios-silver);
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body>

<header>
    <h1 style="margin:0; font-weight: 800; font-size: 1.5rem;">CCAS STUDIO PREMIUM</h1>
</header>

<div id="editor-container">
    <div class="card">
        <label style="font-weight: 700; color: var(--ios-gold);">NOM DU PROJET</label>
        <input type="text" id="project_title" placeholder="Ex: Plan Rafra√Æchissement 2026">
    </div>
    
    <div id="structures-area"></div>
    
    <div style="text-align:center;">
        <button class="btn btn-gold" onclick="addStructure()" style="background: white; border: 1px solid var(--ios-gold); color: var(--ios-gold);">+ AJOUTER UN B√ÇTIMENT</button>
    </div>
</div>

<footer>
    <button class="btn btn-gold" onclick="downloadViewer()">üì• T√âL√âCHARGER LA PR√âSENTATION FINALE</button>
</footer>

<script>
    let diagnostic = {};

    function addStructure() {
        const nom = prompt("Nom de la structure (ex: Cr√®che Dolto) :");
        if (nom) { diagnostic[nom] = []; render(); }
    }

    function render() {
        const area = document.getElementById('structures-area');
        area.innerHTML = '';
        for (let b in diagnostic) {
            area.innerHTML += `
                <div class="card">
                    <h2 style="margin-top:0;">${b}</h2>
                    <input type="file" multiple onchange="loadImgs('${b}', this)" style="margin-bottom:10px;">
                    <div class="img-preview" id="pre-${b}">
                        ${diagnostic[b].map((s, i) => `
                            <div class="img-box">
                                <img src="${s.img}">
                                <textarea style="width:100%; border:none; padding:5px; font-size:10px;" onchange="diagnostic['${b}'][${i}].txt=this.value" placeholder="Notes...">${s.txt}</textarea>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        }
    }

    function loadImgs(b, input) {
        Array.from(input.files).forEach(f => {
            const r = new FileReader();
            r.onload = e => { diagnostic[b].push({ img: e.target.result, txt: "" }); render(); };
            r.readAsDataURL(f);
        });
    }

    function downloadViewer() {
        const title = document.getElementById('project_title').value || "Diagnostic_CCAS";
        const dataStr = JSON.stringify(diagnostic);
        
        // TEMPLATE DU LECTEUR FINAL (iOS STYLE)
        const finalHTML = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>\${title}</title>
    <style>
        body { font-family: -apple-system, sans-serif; margin: 0; display: flex; height: 100vh; background: #000; color: white; overflow: hidden; }
        #side { width: 320px; background: #1C1C1E; border-right: 1px solid #38383A; overflow-y: auto; }
        .nav-btn { width: 100%; padding: 20px; text-align: left; border: none; background: none; color: #8E8E93; cursor: pointer; border-bottom: 1px solid #2C2C2E; font-size: 0.9rem; transition: 0.3s; }
        .nav-btn.active { color: #D4AF37; background: #2C2C2E; font-weight: bold; border-left: 5px solid #D4AF37; }
        #main { flex: 1; display: flex; flex-direction: column; }
        .viewer { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; background: #000; }
        .viewer img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .arr { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); color: white; border: none; padding: 20px; cursor: pointer; border-radius: 50%; font-size: 24px; }
        .diag-box { padding: 30px; background: #1C1C1E; border-top: 1px solid #38383A; font-style: italic; color: #AEAEB2; }
    </style>
</head>
<body>
    <div id="side"><div style="padding:25px; font-weight:bold; color:#D4AF37; border-bottom:1px solid #38383A;">\${title}</div><div id="menu"></div></div>
    <div id="main"><div class="viewer" id="v"></div><div class="diag-box" id="t"></div></div>
    <script>
        const d = \${dataStr};
        let b = Object.keys(d)[0], i = 0;
        function render() {
            const m = document.getElementById('menu'); m.innerHTML = '';
            Object.keys(d).forEach(k => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn' + (b === k ? ' active' : '');
                btn.innerText = k;
                btn.onclick = () => { b = k; i = 0; show(); render(); };
                m.appendChild(btn);
            });
        }
        function show() {
            const v = document.getElementById('v'), items = d[b];
            if (!items || items.length === 0) return;
            v.innerHTML = '<img src="' + items[i].img + '">';
            if (items.length > 1) {
                v.innerHTML += '<button class="arr" style="left:20px" onclick="mv(-1)">‚ùÆ</button>';
                v.innerHTML += '<button class="arr" style="right:20px" onclick="mv(1)">‚ùØ</button>';
            }
            document.getElementById('t').innerText = items[i].txt || "Aucun diagnostic technique saisi.";
        }
        function mv(dir) { i = (i + dir + d[b].length) % d[b].length; show(); }
        render(); show();
    <\/script>
</body>
</html>`;

        const blob = new Blob([finalHTML], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = title + "_INTERACTIF.html";
        a.click();
    }
</script>
</body>
</html>
