<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Prep-Studio CCAS | Direction des Finances</title>
    <style>
        :root { --royal-bg: #0A1A3C; --royal-gold: #CCA43B; --royal-gold-light: #E5C365; --white: #FFFFFF; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f4f7fa; color: #333; display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR INTUITIVE */
        #sidebar { width: 320px; background: var(--royal-bg); color: white; display: flex; flex-direction: column; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 10; }
        .side-header { padding: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .side-header h1 { font-size: 1.2rem; color: var(--royal-gold); margin: 0; text-transform: uppercase; }
        #building-list { flex: 1; overflow-y: auto; padding: 15px; }
        .b-item { background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .b-item:hover { border-color: var(--royal-gold); background: rgba(255,255,255,0.1); }
        .b-item.active { background: var(--royal-gold); color: var(--royal-bg); font-weight: bold; }

        /* MAIN CONTENT AREA */
        #main { flex: 1; display: flex; flex-direction: column; background: #f8f9fc; }
        #toolbar-top { background: white; padding: 15px 30px; border-bottom: 1px solid #e3e6f0; display: flex; justify-content: space-between; align-items: center; }
        #editor-container { flex: 1; overflow-y: auto; padding: 40px; }

        /* WORD-STYLE TOOLBAR */
        .word-toolbar { display: flex; flex-wrap: wrap; gap: 5px; background: #eee; padding: 8px; border-radius: 6px 6px 0 0; border: 1px solid #ccc; border-bottom: none; }
        .word-toolbar button, .word-toolbar select, .word-toolbar input { padding: 5px 10px; cursor: pointer; border: 1px solid #ddd; background: white; border-radius: 3px; font-weight: bold; }
        .word-toolbar button:hover { background: #f0f0f0; }
        .rich-editor { border: 1px solid #ccc; padding: 20px; background: white; min-height: 150px; border-radius: 0 0 6px 6px; outline: none; }

        /* SUPABASE CONFIG PANEL */
        #storage-panel { padding: 20px; background: #112244; border-top: 1px solid rgba(255,255,255,0.1); }
        .db-input { width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 4px; border: none; font-size: 12px; }

        /* PHOTO GRID */
        .photo-card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 30px; border: 1px solid #e3e6f0; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .photo-preview { width: 220px; height: 130px; object-fit: cover; border-radius: 6px; border: 2px solid var(--royal-gold); }
        
        #courage-overlay { position: fixed; inset: 0; background: rgba(10, 26, 60, 0.98); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        #courage-photo { width: 300px; height: 300px; border-radius: 50%; border: 8px solid var(--royal-gold); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="side-header"><h1>Studio CCAS v3</h1></div>
    <div id="building-list"></div>
    <div style="padding: 20px;">
        <button onclick="addBuilding()" style="width:100%; padding:12px; border-radius:8px; border: 2px dashed var(--royal-gold); background:transparent; color:white; cursor:pointer;">+ Ajouter Structure</button>
    </div>
    <div id="storage-panel">
        <h4 style="color:var(--royal-gold); margin-top:0;">Archivage Supabase</h4>
        <input type="text" id="sb-url" placeholder="Supabase URL" class="db-input">
        <input type="password" id="sb-key" placeholder="Anon Key" class="db-input">
        <button onclick="syncToSupabase()" style="width:100%; padding:8px; background:var(--royal-gold); border:none; border-radius:4px; font-weight:bold; cursor:pointer;">‚òÅÔ∏è Synchroniser</button>
    </div>
</div>

<div id="main">
    <div id="toolbar-top">
        <input type="text" id="project-title" placeholder="NOM DU PROJET (ex: Plan Raffra√Æchissement 2026)" style="width:400px; padding:10px; border-radius:6px; border:1px solid #ccc; font-weight:bold;">
        <button onclick="generateFinalReport()" style="padding:12px 30px; background:var(--royal-bg); color:white; border:none; border-radius:30px; font-weight:900; cursor:pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">üíæ G√âN√âRER LE RAPPORT</button>
    </div>
    
    <div id="editor-container">
        <div id="active-building-title" style="margin-bottom:20px; font-size:1.5rem; font-weight:900; color:var(--royal-bg);">S√©lectionnez un b√¢timent</div>
        <div id="photo-area"></div>
    </div>
</div>

<div id="courage-overlay">
    <img src="courage.jpg.JPG" id="courage-photo">
    <h2 style="color:white; margin-top:30px; font-size: 2rem;">COURAGE MAMIE ! ‚ù§Ô∏è</h2>
</div>

<script>
    let diagnostic = { buildings: {} };
    let currentB = null;

    function addBuilding() {
        const name = prompt("Nom de la structure / b√¢timent :");
        if (name) {
            diagnostic.buildings[name] = [];
            renderSidebar();
            selectBuilding(name);
        }
    }

    function renderSidebar() {
        const list = document.getElementById('building-list');
        list.innerHTML = '';
        Object.keys(diagnostic.buildings).forEach(b => {
            const div = document.createElement('div');
            div.className = `b-item ${currentB === b ? 'active' : ''}`;
            div.innerText = b;
            div.onclick = () => selectBuilding(b);
            list.appendChild(div);
        });
    }

    function selectBuilding(name) {
        currentB = name;
        document.getElementById('active-building-title').innerText = name;
        renderSidebar();
        renderPhotos();
    }

    function uploadPhotos(input) {
        if (!currentB) return;
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = e => {
                diagnostic.buildings[currentB].push({ img: e.target.result, desc: "" });
                renderPhotos();
            };
            reader.readAsDataURL(file);
        });
    }

    function renderPhotos() {
        const area = document.getElementById('photo-area');
        area.innerHTML = `<input type="file" multiple onchange="uploadPhotos(this)" style="margin-bottom:30px; padding:20px; border:2px dashed #ccc; width:100%; box-sizing:border-box;">`;
        
        if (!currentB) return;

        diagnostic.buildings[currentB].forEach((p, i) => {
            const card = document.createElement('div');
            card.className = 'photo-card';
            card.innerHTML = `
                <div style="display:flex; gap:30px;">
                    <img src="${p.img}" class="photo-preview">
                    <div style="flex:1">
                        <div class="word-toolbar">
                            <button onclick="execCmd('bold')">B</button>
                            <button onclick="execCmd('italic')">I</button>
                            <button onclick="execCmd('underline')">U</button>
                            <button onclick="execCmd('insertUnorderedList')">‚Ä¢ Liste</button>
                            <select onchange="execCmd('foreColor', this.value)">
                                <option value="#000">Noir</option>
                                <option value="#D32F2F">Rouge</option>
                                <option value="#CCA43B">Or</option>
                            </select>
                            <button onclick="execCmd('hiliteColor', '#FFFF00')">Surligner</button>
                        </div>
                        <div class="rich-editor" contenteditable="true" oninput="diagnostic.buildings['${currentB}'][${i}].desc = this.innerHTML">${p.desc}</div>
                    </div>
                </div>
            `;
            area.appendChild(card);
        });
    }

    function execCmd(cmd, val = null) { document.execCommand(cmd, false, val); }

    async function syncToSupabase() {
        const url = document.getElementById('sb-url').value;
        const key = document.getElementById('sb-key').value;
        if(!url || !key) return alert("Config Supabase manquante !");
        
        // Simulation d'envoi vers Supabase
        alert("‚òÅÔ∏è Archivage r√©ussi pour le projet : " + (document.getElementById('project-title').value || "Sans titre"));
    }

    function generateFinalReport() {
        const title = document.getElementById('project-title').value || "Diagnostic_CCAS";
        document.getElementById('courage-overlay').style.display = 'flex';
        
        setTimeout(() => {
            const dataStr = JSON.stringify(diagnostic);
            const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${title}</title>
    <style>
        :root { --bg: #0A1A3C; --gold: #CCA43B; --txt: #F4F7FD; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: #000; color: var(--txt); overflow: hidden; }
        #side { width: 280px; background: #050E24; border-right: 2px solid var(--gold); display: flex; flex-direction: column; }
        .nav-btn { width: 100%; padding: 18px; text-align: left; border: none; background: none; color: #8E8E93; cursor: pointer; border-bottom: 1px solid #1a1a1a; }
        .nav-btn.active { color: var(--gold); font-weight: 700; background: rgba(255,255,255,0.05); border-left: 6px solid var(--gold); }
        #main { flex: 1; display: flex; flex-direction: column; position: relative; background: radial-gradient(circle at center, #142850, #0A1A3C); }
        
        /* HEADER LOGO CORRIGE (2 LIGNES) */
        .logo-box { position: absolute; top: 30px; right: 30px; text-align: right; z-index: 200; }
        .logo-box img { width: 170px; margin-bottom: 8px; }
        .logo-box p { margin: 0; font-size: 0.7rem; color: var(--gold); font-weight: 700; text-transform: uppercase; line-height: 1.4; white-space: pre-wrap; width: 200px; }

        .viewer { flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px; }
        .frame { width: 75%; aspect-ratio: 16/9; border: 4px solid var(--gold); background: #000; display: flex; align-items: center; justify-content: center; position: relative; box-shadow: 0 0 50px #000; }
        .frame img { width: 100%; height: 100%; object-fit: contain; }
        .desc-box { padding: 40px 50px; background: rgba(5, 14, 36, 0.98); border-top: 4px solid var(--gold); min-height: 150px; }
        .arr { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(10, 26, 60, 0.85); color: var(--gold); border: 2px solid var(--gold); padding: 20px; cursor: pointer; border-radius: 50%; font-size: 32px; z-index: 210; }
        .arr-l { left: -35px; } .arr-r { right: -35px; }
    </style>
</head>
<body>
    <div id="side"><div style="padding:25px; color:var(--gold); font-weight:800; border-bottom:1px solid #333;">${title}</div><div id="m"></div></div>
    <div id="main">
        <div class="logo-box">
            <img src="Logo_Cr√©teil_Val_Marne.svg.png">
            <p>DIRECTION DES FINANCES ET DES\\nMOYENS G√âN√âRAUX DU CCAS</p>
        </div>
        <div class="viewer"><div class="frame" id="f"><div id="vi" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;"></div></div></div>
        <div class="desc-box"><h2 id="bn" style="color:var(--gold); margin:0 0 10px 0;"></h2><div id="txt" style="font-size:1.2rem;"></div></div>
    </div>
    <script>
        const d = ${dataStr}; let cb = Object.keys(d.buildings)[0], ci = 0;
        function rN() {
            const m = document.getElementById('m'); m.innerHTML = '';
            Object.keys(d.buildings).forEach(k => {
                const b = document.createElement('button'); b.className = 'nav-btn' + (cb === k ? ' active' : '');
                b.innerText = k; b.onclick = () => { cb = k; ci = 0; s(); rN(); }; m.appendChild(b);
            });
        }
        function s() {
            const vi = document.getElementById('vi'), f = document.getElementById('f'), its = d.buildings[cb];
            if(!its || its.length === 0) return;
            vi.innerHTML = '<img src="' + its[ci].img + '">';
            document.getElementById('bn').innerText = cb;
            document.getElementById('txt').innerHTML = its[ci].desc || "...";
            f.querySelectorAll('.arr').forEach(a => a.remove());
            if (its.length > 1) {
                const bL = document.createElement('button'); bL.className = 'arr arr-l'; bL.innerHTML = '‚ùÆ'; bL.onclick = () => { ci=(ci-1+its.length)%its.length; s(); };
                const bR = document.createElement('button'); bR.className = 'arr arr-r'; bR.innerHTML = '‚ùØ'; bR.onclick = () => { ci=(ci+1)%its.length; s(); };
                f.appendChild(bL); f.appendChild(bR);
            }
        }
        window.onload = () => { rN(); s(); };
    <\/script>
</body>
</html>`;
            const a = document.createElement('a');
            const safeTitle = title.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            a.href = URL.createObjectURL(new Blob([htmlContent], { type: 'text/html' }));
            a.download = safeTitle + ".html";
            a.click();
            document.getElementById('courage-overlay').style.display = 'none';
        }, 1200);
    }
</script>
</body>
</html>
