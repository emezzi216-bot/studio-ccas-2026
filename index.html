<!DOCTYPE html><html lang="fr"><head>
    <meta charset="UTF-8">
    <title>STUDIO CCAS | Cloud Expert</title>
    <style>
        :root { --blue: #0A1A3C; --gold: #CCA43B; --bg: #f4f7f9; --green: #27ae60; --cloud: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* HEADER */
        .main-header { background: var(--blue); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 100; border-bottom: 2px solid var(--gold); }
        .status-badge { background: #27ae60; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        
        #view-dashboard { flex:1; padding: 40px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; }
        .folder-card { background: white; border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; border: 1px solid #ddd; position: relative; transition: 0.2s; }
        .folder-card:hover { border-color: var(--gold); transform: translateY(-3px); }

        #view-studio { display: none; height: calc(100vh - 70px); flex-direction: row; }
        #sidebar { width: 300px; background: var(--blue); border-right: 2px solid var(--gold); display: flex; flex-direction: column; color: white; }
        .bat-nav-item { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.2s; }
        .bat-nav-item.active { background: var(--gold); color: var(--blue); font-weight: bold; }
        
        #editor-content { flex: 1; background: #0A1A3C; display: flex; flex-direction: column; }
        .toolbar-top { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        
        .photo-card { background: rgba(255,255,255,0.05); border-radius: 10px; padding: 20px; margin: 0 30px 20px 30px; display: flex; gap: 20px; border-left: 5px solid var(--gold); color: white; }
        .img-container img { width: 220px; height: 150px; object-fit: cover; border-radius: 4px; border: 1px solid var(--gold); }
        
        .text-area { flex: 1; min-height: 100px; padding: 15px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; outline: none; background: rgba(0,0,0,0.2); color: white; font-size: 1rem; }
        .btn-expert { background: var(--green); color: white; border: none; padding: 12px 25px; border-radius: 5px; font-weight: bold; cursor: pointer; }

        #overlay { position: fixed; inset: 0; background: var(--blue); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .img-courage { width: 200px; height: 200px; border-radius: 50%; border: 4px solid var(--gold); object-fit: cover; margin-bottom: 20px; }
    </style>
</head>
<body>

<img src="Logo_Cr√©teil_Val_Marne.svg.png" id="sys-logo" style="display:none" crossorigin="anonymous">

<div class="main-header">
    <div style="display:flex; align-items:center; gap:15px;">
        <h2 style="margin:0; letter-spacing:1px;">STUDIO <span style="color:var(--gold)">CCAS</span></h2>
        <div id="cloud-info" class="status-badge">‚òÅÔ∏è SAUVEGARDE CLOUD OK</div>
    </div>
    <div style="font-size: 0.8rem; font-weight: bold; color: var(--gold);">DIRECTION G√âN√âRALE DES FINANCES</div>
</div>

<div id="view-dashboard">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h1 style="color:var(--blue); margin:0;">Mes Projets de Travaux</h1>
        <button onclick="createProj()" style="background:var(--blue); color:white; border:none; padding:15px 30px; border-radius:8px; font-weight:bold; cursor:pointer;">+ NOUVEAU DOSSIER</button>
    </div>
    <div id="grid-projects" class="grid"></div>
</div>

<div id="view-studio">
    <div id="sidebar">
        <button onclick="goDashboard()" style="padding:20px; background:rgba(255,255,255,0.1); border:none; color:white; cursor:pointer; font-weight:bold;">üè† RETOUR √Ä L'ACCUEIL</button>
        <div id="list-bat" style="flex:1; overflow-y:auto;"></div>
        <button onclick="newBat()" style="padding:20px; background:var(--gold); color:var(--blue); border:none; font-weight:bold; cursor:pointer;">+ AJOUTER UN B√ÇTIMENT</button>
    </div>
    <div id="editor-content">
        <div class="toolbar-top">
            <h2 id="lbl-bat" style="margin:0; color:var(--blue);">B√¢timent</h2>
            <button class="btn-expert" onclick="generateReport()">üöÄ G√âN√âRER LE RAPPORT FINAL</button>
        </div>
        <div id="area-photos" style="flex:1; padding-top:30px; overflow-y:auto;"></div>
    </div>
</div>

<div id="overlay">
    <img src="courage.jpg.JPG" class="img-courage" onerror="this.src='https://via.placeholder.com/200?text=COURAGE'">
    <h2 style="color:var(--gold);">COURAGE MAMAN ! ‚ù§Ô∏è</h2>
    <p>Le fichier interactif est en cours de pr√©paration...</p>
</div>

<input type="file" id="photo-input" style="display:none" multiple onchange="processPhotos(this)">

<script>
    const CLOUD_ID = "ccas_maman_final_storage"; 
    let db = JSON.parse(localStorage.getItem('ccas_db_v18')) || {};
    let curP = null, curB = null, logoData = "";

    window.onload = () => { refreshGrid(); getLogo(); syncFromCloud(); };

    function getLogo() {
        const img = document.getElementById('sys-logo');
        img.onload = () => {
            const c = document.createElement('canvas');
            c.width = img.width; c.height = img.height;
            c.getContext('2d').drawImage(img, 0, 0);
            logoData = c.toDataURL();
        };
    }

    // CLOUD
    async function syncToCloud() {
        try {
            await fetch(`https://api.keyvalue.xyz/${CLOUD_ID}/data`, { method: 'POST', body: JSON.stringify(db) });
            document.getElementById('cloud-info').innerText = "‚òÅÔ∏è CLOUD : √Ä JOUR";
        } catch (e) {}
    }

    async function syncFromCloud() {
        try {
            const res = await fetch(`https://api.keyvalue.xyz/${CLOUD_ID}/data`);
            if(res.ok) {
                const cloudData = await res.json();
                if(Object.keys(cloudData).length > Object.keys(db).length) {
                    db = cloudData; refreshGrid();
                }
            }
        } catch (e) {}
    }

    function save() {
        localStorage.setItem('ccas_db_v18', JSON.stringify(db));
        syncToCloud();
    }

    // DASHBOARD
    function refreshGrid() {
        const g = document.getElementById('grid-projects'); g.innerHTML = '';
        Object.keys(db).forEach(id => {
            const div = document.createElement('div'); div.className = 'folder-card';
            div.innerHTML = `<div onclick="event.stopPropagation(); if(confirm('Supprimer ?')){delete db['${id}']; save(); refreshGrid();}" style="position:absolute; top:10px; right:15px; color:red;">üóëÔ∏è</div>
                             <div style="font-size:3rem; margin-bottom:10px;">üìÅ</div><h3>${db[id].name}</h3>`;
            div.onclick = () => openProj(id);
            g.appendChild(div);
        });
    }

    function createProj() { const n = prompt("Nom du dossier :"); if(n) { const id = Date.now().toString(); db[id] = { name:n, data:{} }; save(); openProj(id); } }
    function openProj(id) { curP = id; curB = null; document.getElementById('view-dashboard').style.display='none'; document.getElementById('view-studio').style.display='flex'; refreshSide(); refreshMain(); }
    function goDashboard() { document.getElementById('view-studio').style.display='none'; document.getElementById('view-dashboard').style.display='flex'; refreshGrid(); }
    
    // STUDIO
    function newBat() { const n = prompt("Nom du b√¢timent :"); if(n) { if(!db[curP].data[n]) db[curP].data[n] = []; save(); openBat(n); } }
    function refreshSide() {
        const l = document.getElementById('list-bat'); l.innerHTML = '';
        Object.keys(db[curP].data).forEach(b => {
            const div = document.createElement('div'); div.className = 'bat-nav-item' + (curB === b ? ' active' : '');
            div.innerText = b; div.onclick = () => openBat(b); l.appendChild(div);
        });
    }
    function openBat(b) { curB = b; document.getElementById('lbl-bat').innerText = b; refreshSide(); refreshMain(); }
    
    function refreshMain() {
        const area = document.getElementById('area-photos'); area.innerHTML = '';
        if(!curB) return;
        area.innerHTML = `<button onclick="document.getElementById('photo-input').click()" style="width:calc(100% - 60px); padding:20px; margin:0 30px 20px 30px; cursor:pointer; font-weight:bold; background:white; border:2px dashed var(--gold); border-radius:8px;">üì∏ AJOUTER DES PHOTOS ICI</button>`;
        db[curP].data[curB].forEach((p, i) => {
            const div = document.createElement('div'); div.className = 'photo-card';
            div.innerHTML = `<div class="img-container"><img src="${p.img}"></div>
                <div class="text-area" contenteditable="true" oninput="db[curP].data[curB][${i}].desc=this.innerHTML; save()">${p.desc}</div>
                <button onclick="db[curP].data[curB].splice(${i},1); save(); refreshMain();" style="color:red; border:none; background:none; cursor:pointer; font-weight:bold;">üóëÔ∏è</button>`;
            area.appendChild(div);
        });
    }

    function processPhotos(input) {
        Array.from(input.files).forEach(f => {
            const r = new FileReader();
            r.onload = e => { db[curP].data[curB].push({img: e.target.result, desc: "Notes de visite..."}); save(); refreshMain(); };
            r.readAsDataURL(f);
        });
    }

    // G√âN√âRATION RAPPORT INTERACTIF (S√âCURIS√â)
    function generateReport() {
        const proj = db[curP];
        document.getElementById('overlay').style.display = 'flex';
        
        setTimeout(() => {
            const reportData = JSON.stringify(proj.data).replace(/</g, '\\u003c');
            const reportHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>REPORTING CCAS</title><style>
                body{font-family:sans-serif;margin:0;display:flex;height:100vh;background:#050E24;color:white;overflow:hidden}
                #side{width:260px;background:#0A1A3C;border-right:3px solid #CCA43B;display:flex;flex-direction:column}
                .btn{width:100%;padding:18px;text-align:left;border:none;background:none;color:#8E8E93;cursor:pointer;border-bottom:1px solid #1f2d40;transition:0.2s}
                .btn.active{color:#CCA43B;background:rgba(204,164,59,0.1);border-left:5px solid #CCA43B;font-weight:bold}
                #main{flex:1;display:flex;flex-direction:column;position:relative;background:radial-gradient(circle at center, #142850, #050E24)}
                .top-logo{position:absolute;top:20px;right:25px;display:flex;align-items:center;gap:12px;background:rgba(10,26,60,0.9);padding:10px 15px;border:1px solid #CCA43B;border-radius:6px}
                .logo-img{width:55px}
                .logo-txt{font-size:9px;font-weight:bold;color:#CCA43B;line-height:1.2;text-transform:uppercase}
                .frame{flex:1;display:flex;align-items:center;justify-content:center;padding:40px}
                .frame img{max-width:95%;max-height:95%;border:3px solid #CCA43B;box-shadow:0 0 50px #000;border-radius:4px}
                .bot{padding:30px 50px;background:rgba(5,14,36,0.95);border-top:3px solid #CCA43B;min-height:120px}
                .arr{position:absolute;top:50%;transform:translateY(-50%);background:#CCA43B;color:#0A1A3C;width:55px;height:55px;display:flex;align-items:center;justify-content:center;border-radius:50%;cursor:pointer;font-weight:bold;font-size:24px}
            </style></head><body>
                <div id="side"><div style="padding:25px;color:#CCA43B;font-weight:bold;font-size:18px;border-bottom:1px solid #1f2d40">${proj.name}</div><div id="nav"></div></div>
                <div id="main">
                    <div class="top-logo"><img src="${logoData}" class="logo-img"><div class="logo-txt">DIRECTION G√âN√âRALE<br>DES FINANCES ET DES<br>MOYENS G√âN√âRAUX</div></div>
                    <div class="frame" id="fr"><div id="sc" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center"></div></div>
                    <div class="bot"><h2 id="tit" style="color:#CCA43B;margin:0 0 10px 0;text-transform:uppercase;letter-spacing:1px"></h2><div id="desc" style="font-size:1.3rem;line-height:1.5"></div></div>
                </div>
                <script>
                const data = ${reportData}; let cB = Object.keys(data)[0], cI = 0;
                function sh(){
                    const s=document.getElementById('sc'),f=document.getElementById('fr'),i=data[cB];
                    if(!i||!i.length)return;
                    s.innerHTML='<img src="'+i[cI].img+'">';
                    document.getElementById('tit').innerText=cB; document.getElementById('desc').innerHTML=i[cI].desc;
                    document.querySelectorAll('.arr').forEach(a=>a.remove());
                    if(i.length>1){
                        const l=document.createElement('div');l.className='arr';l.style.left='25px';l.innerHTML='‚ùÆ';l.onclick=()=>{cI=(cI-1+i.length)%i.length;sh()};
                        const r=document.createElement('div');r.className='arr';r.style.right='25px';r.innerHTML='‚ùØ';r.onclick=()=>{cI=(cI+1)%i.length;sh()};
                        f.appendChild(l);f.appendChild(r);
                    }
                }
                function rn(){const n=document.getElementById('nav');n.innerHTML='';Object.keys(data).forEach(k=>{const b=document.createElement('button');b.className='btn'+(cB===k?' active':'');b.innerText=k;b.onclick=()=>{cB=k;cI=0;sh();rn()};n.appendChild(b)})}
                window.onload=()=>{if(cB){rn();sh()}};
                <\/script></body></html>`;
            
            const b = new Blob([reportHtml], {type: 'text/html'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = proj.name + "_INTERACTIF.html";
            a.click();
            document.getElementById('overlay').style.display='none';
        }, 1500);
    }
</script>
</body></html>
