<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio CCAS | v55 FINAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* --- STYLE ROBUSTE --- */
        :root { --blue: #0A1A3C; --gold: #CCA43B; --bg: #f4f6f8; --white: #fff; --green: #27ae60; --red: #c0392b; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        * { box-sizing: border-box; outline: none; }
        
        /* HEADER FIXE */
        .app-header { height: 60px; background: var(--white); padding: 0 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--gold); z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { color: var(--blue); font-size: 1.4rem; font-weight: 900; letter-spacing: 1px; }
        .actions { display: flex; gap: 10px; }
        
        button { cursor: pointer; border: none; border-radius: 4px; padding: 8px 15px; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        button:active { transform: scale(0.98); }
        .btn-green { background: var(--green); color: white; border: 1px solid var(--green); }
        .btn-blue { background: var(--blue); color: white; }
        .btn-outline { background: white; border: 1px solid #ccc; color: #333; }
        
        /* GESTION DES VUES (IMPORTANT) */
        .view-container { flex: 1; position: relative; overflow: hidden; }
        .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; background: var(--bg); }
        .view.active { display: flex; }

        /* VUE 1 : DASHBOARD */
        #dashboard { align-items: center; padding-top: 50px; overflow-y: auto; }
        .big-card { background: white; padding: 40px; border-radius: 12px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 2px solid transparent; width: 100%; max-width: 500px; }
        .big-btn { background: var(--blue); color: white; font-size: 1.2rem; padding: 15px 40px; border-radius: 8px; margin-bottom: 20px; width: 100%; justify-content: center; }
        .load-zone { border: 2px dashed #ccc; padding: 20px; border-radius: 8px; cursor: pointer; color: #666; margin-top: 20px; }
        .load-zone:hover { border-color: var(--blue); color: var(--blue); }

        /* VUE 2 : STUDIO */
        #studio { flex-direction: row; }
        
        /* SIDEBAR */
        .sidebar { width: 280px; background: var(--blue); color: white; display: flex; flex-direction: column; box-shadow: 4px 0 10px rgba(0,0,0,0.1); z-index: 10; }
        .side-head { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.2); }
        .proj-name { text-align: center; font-weight: bold; font-size: 1.1rem; margin-top: 5px; color: var(--gold); }
        
        .bat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .bat-item { padding: 12px; background: rgba(255,255,255,0.05); margin-bottom: 5px; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; border-left: 4px solid transparent; }
        .bat-item:hover { background: rgba(255,255,255,0.1); }
        .bat-item.active { background: white; color: var(--blue); border-left-color: var(--gold); font-weight: bold; }
        
        .add-zone { padding: 15px; border-top: 1px solid rgba(255,255,255,0.15); }
        .btn-add { width: 100%; background: transparent; border: 1px dashed rgba(255,255,255,0.5); color: white; justify-content: center; }

        /* MAIN EDITOR */
        .main-area { flex: 1; display: flex; flex-direction: column; background: #eef2f6; }
        .toolbar { height: 50px; background: white; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .logo-btn { width: 40px; height: 40px; border: 1px dashed #ccc; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 4px; overflow: hidden; }
        .logo-btn img { width: 100%; height: 100%; object-fit: contain; }
        
        .content { flex: 1; overflow-y: auto; padding: 30px; scroll-behavior: smooth; }

        /* PHOTO BLOCK */
        .block { background: white; border-radius: 8px; margin-bottom: 20px; display: flex; height: 300px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #ddd; }
        
        .block-img { width: 300px; background: #f8f8f8; padding: 10px; border-right: 1px solid #eee; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .img-view { width: 100%; height: 200px; object-fit: contain; background: white; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
        .handle { position: absolute; top: 5px; left: 5px; cursor: grab; font-size: 20px; color: #999; background: white; padding: 0 5px; border-radius: 4px; }
        .btn-del { margin-top: 10px; background: #fee2e2; color: var(--red); width: 100%; justify-content: center; }

        .block-txt { flex: 1; padding: 15px; display: flex; flex-direction: column; }
        .txt-tools { display: flex; gap: 5px; margin-bottom: 5px; background: #f0f0f0; padding: 5px; border-radius: 4px; }
        .txt-btn { width: 25px; height: 25px; padding: 0; justify-content: center; background: white; border: 1px solid #ccc; color: black; }
        .editable { flex: 1; border: 1px solid #ccc; padding: 10px; overflow-y: auto; background: white; font-size: 15px; line-height: 1.4; border-radius: 4px; }
        
        /* LOADING */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .bar { width: 200px; height: 8px; background: #ddd; border-radius: 4px; margin-top: 15px; overflow: hidden; }
        .fill { height: 100%; width: 0%; background: var(--blue); transition: width 0.2s; }
        
        /* PAINT */
        #paint { position: fixed; inset: 0; background: #222; z-index: 3000; display: none; flex-direction: column; }
        .paint-tools { height: 50px; background: #333; display: flex; justify-content: center; gap: 10px; align-items: center; }
        #canvas-wrap { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        canvas { box-shadow: 0 0 20px black; }
    </style>
</head>
<body>

<div id="loader"><h2 style="color:var(--blue)">Traitement...</h2><div class="bar"><div class="fill" id="progress"></div></div></div>

<div class="app-header">
    <div class="logo">STUDIO CCAS v55</div>
    <div class="actions">
        <button class="btn-green" onclick="saveToPC()">üíæ SAUVEGARDE PC</button>
    </div>
</div>

<div class="view-container">
    
    <div id="dashboard" class="view active">
        <div class="big-card">
            <h2 style="color:var(--blue); margin-bottom:30px;">Bienvenue</h2>
            <button class="big-btn" onclick="createProject()">+ NOUVEAU DOSSIER</button>
            <div class="load-zone" onclick="document.getElementById('f-load').click()">
                üìÇ Cliquez ici pour ouvrir une sauvegarde (.json)
            </div>
        </div>
    </div>

    <div id="studio" class="view">
        <div class="sidebar">
            <div class="side-head">
                <button onclick="goDashboard()" style="background:none; border:none; color:white; padding:0;">‚¨ÖÔ∏è Fermer</button>
                <div class="proj-name" id="lbl-proj">Projet</div>
            </div>
            <div id="bat-list" class="bat-list"></div>
            <div class="add-zone">
                <button class="btn-add" onclick="addBat()">+ RUBRIQUE</button>
            </div>
        </div>
        
        <div class="main-area">
            <div class="toolbar">
                <div class="logo-btn" onclick="document.getElementById('f-logo').click()">
                    <img id="img-logo" src="Logo_Cr√©teil_Val_Marne.svg.png" onerror="this.src='https://via.placeholder.com/50?text=LOGO'">
                </div>
                <h3 id="lbl-bat" style="margin:0; color:var(--blue);">Accueil</h3>
                <div style="display:flex; gap:10px;">
                    <button class="btn-blue" onclick="document.getElementById('f-photo').click()">üì∏ AJOUTER PHOTOS</button>
                    <button class="btn-outline" onclick="generateZip()">üì¶ G√âN√âRER</button>
                </div>
            </div>
            <div id="content" class="content"></div>
        </div>
    </div>

</div>

<div id="paint">
    <div style="background:#444; padding:10px; display:flex; justify-content:space-between; color:white;">
        <b>RETOUCHE</b>
        <div><button class="btn-green" onclick="savePaint()">OK</button> <button class="btn-outline" style="background:transparent; color:#ccc; border:none;" onclick="closePaint()">Annuler</button></div>
    </div>
    <div id="canvas-wrap"><canvas id="canvas"></canvas></div>
    <div class="paint-tools">
        <button onclick="tool='rect'">‚¨ú</button><button onclick="tool='circle'">‚≠ï</button><button onclick="tool='arrow'">‚ÜóÔ∏è</button><button onclick="tool='free'">‚úèÔ∏è</button>
        <input type="color" onchange="color=this.value" value="#ff0000">
        <input type="range" min="2" max="20" value="5" onchange="width=this.value">
    </div>
</div>

<input type="file" id="f-load" style="display:none" onchange="loadFile(this)">
<input type="file" id="f-photo" style="display:none" multiple accept="image/png, image/jpeg, image/jpg" onchange="addPhotos(this)">
<input type="file" id="f-logo" style="display:none" accept="image/*" onchange="setLogo(this)">

<script>
// --- DONNEES (RAM) ---
let app = { name: "Projet", data: {} };
let curBat = null;
let pIdx = null; // Index photo pour paint

// --- NAVIGATION ---
function showView(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function createProject() {
    let n = prompt("Nom du dossier :");
    if(!n) return;
    app = { name: n, data: { "Zone 1": [] } }; // Cr√©ation auto Zone 1
    document.getElementById('lbl-proj').innerText = n;
    showView('studio');
    selectBat("Zone 1");
}

function goDashboard() {
    if(confirm("ATTENTION : Avez-vous sauvegard√© sur PC ? Sinon tout sera perdu.")) {
        showView('dashboard');
    }
}

// --- BATIMENTS ---
function addBat() {
    let n = prompt("Nom :");
    if(n) { if(!app.data[n]) app.data[n]=[]; selectBat(n); }
}

function selectBat(name) {
    curBat = name;
    document.getElementById('lbl-bat').innerText = name;
    renderSide();
    renderContent();
}

function delBat(name, e) {
    e.stopPropagation();
    if(confirm("Supprimer "+name+" ?")) {
        delete app.data[name];
        let keys = Object.keys(app.data);
        if(keys.length > 0) selectBat(keys[0]); else { curBat=null; renderSide(); renderContent(); }
    }
}

function renderSide() {
    let l = document.getElementById('bat-list'); l.innerHTML = "";
    Object.keys(app.data).forEach(k => {
        let d = document.createElement('div');
        d.className = "bat-item " + (curBat === k ? "active" : "");
        d.innerHTML = `<span>${k}</span> <span onclick="delBat('${k}',event)" style="color:#e74c3c;font-weight:bold;">√ó</span>`;
        d.onclick = () => selectBat(k);
        l.appendChild(d);
    });
}

// --- PHOTOS ---
function addPhotos(input) {
    if(!curBat) { // Auto-correction si clic sans s√©lection
        if(Object.keys(app.data).length === 0) app.data["Zone 1"] = [];
        curBat = Object.keys(app.data)[0];
        selectBat(curBat);
    }
    
    if(!input.files.length) return;
    
    let loader = document.getElementById('loader');
    let bar = document.getElementById('progress');
    loader.style.display = 'flex';
    
    let c = 0;
    Array.from(input.files).forEach(f => {
        let r = new FileReader();
        r.onload = e => {
            let img = new Image();
            img.onload = () => {
                let cvs = document.createElement('canvas');
                let ctx = cvs.getContext('2d');
                let max = 1000;
                let w = img.width, h = img.height;
                if(w > max) { h *= max/w; w = max; }
                cvs.width = w; cvs.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                
                app.data[curBat].push({ img: cvs.toDataURL('image/jpeg', 0.7), text: "Description..." });
                c++;
                bar.style.width = (c/input.files.length*100) + "%";
                if(c === input.files.length) {
                    renderContent();
                    setTimeout(() => loader.style.display = 'none', 500);
                }
            };
            img.src = e.target.result;
        };
        r.readAsDataURL(f);
    });
    input.value = "";
}

function renderContent() {
    let c = document.getElementById('content'); c.innerHTML = "";
    if(!curBat) return;
    
    app.data[curBat].forEach((item, idx) => {
        let b = document.createElement('div'); b.className = "block";
        b.innerHTML = `
            <div class="block-img">
                <span class="handle">‚ò∞</span>
                <img src="${item.img}" class="img-view" onclick="editP(${idx})">
                <button class="btn-del" onclick="delPhoto(${idx})">Supprimer</button>
            </div>
            <div class="block-txt">
                <div class="txt-tools">
                    <button class="txt-btn" onclick="document.execCommand('bold')">B</button>
                    <button class="txt-btn" onclick="document.execCommand('italic')">I</button>
                    <button class="txt-btn" onclick="document.execCommand('underline')">U</button>
                    <input type="color" onchange="document.execCommand('foreColor',false,this.value)" style="width:25px;height:25px;border:none;">
                </div>
                <div class="editable" contenteditable="true" oninput="updTxt(${idx},this.innerHTML)">${item.text}</div>
            </div>
        `;
        c.appendChild(b);
    });
}

function updTxt(i, t) { app.data[curBat][i].text = t; }
function delPhoto(i) { if(confirm("Supprimer ?")) { app.data[curBat].splice(i, 1); renderContent(); } }

// --- PAINT ---
let paintCvs = document.getElementById('canvas');
let paintCtx = paintCvs.getContext('2d');
let paintImg = new Image();
let tool='rect', color='#ff0000', width=5, drawing=false, sx, sy;

function editP(i) {
    pIdx = i;
    paintImg.src = app.data[curBat][i].img;
    paintImg.onload = () => {
        paintCvs.width = paintImg.width;
        paintCvs.height = paintImg.height;
        paintCtx.drawImage(paintImg, 0, 0);
        document.getElementById('paint').style.display = 'flex';
    };
}
function savePaint() {
    app.data[curBat][pIdx].img = paintCvs.toDataURL('image/jpeg', 0.8);
    closePaint();
    renderContent();
}
function closePaint() { document.getElementById('paint').style.display = 'none'; }

paintCvs.addEventListener('mousedown', e => { drawing=true; let r=paintCvs.getBoundingClientRect(); let s=paintCvs.width/r.width; sx=(e.clientX-r.left)*s; sy=(e.clientY-r.top)*s; paintCtx.beginPath(); });
paintCvs.addEventListener('mousemove', e => { if(!drawing) return; let r=paintCvs.getBoundingClientRect(); let s=paintCvs.width/r.width; let x=(e.clientX-r.left)*s; let y=(e.clientY-r.top)*s; paintCtx.strokeStyle=color; paintCtx.lineWidth=width; if(tool==='free'){ paintCtx.lineTo(x,y); paintCtx.stroke(); } });
paintCvs.addEventListener('mouseup', e => { drawing=false; if(tool!=='free'){ let r=paintCvs.getBoundingClientRect(); let s=paintCvs.width/r.width; let x=(e.clientX-r.left)*s; let y=(e.clientY-r.top)*s; paintCtx.beginPath(); paintCtx.strokeStyle=color; paintCtx.lineWidth=width; if(tool==='rect') paintCtx.strokeRect(sx,sy,x-sx,y-sy); if(tool==='circle'){ let rad=Math.sqrt(Math.pow(x-sx,2)+Math.pow(y-sy,2)); paintCtx.arc(sx,sy,rad,0,2*Math.PI); paintCtx.stroke(); } if(tool==='arrow'){ paintCtx.moveTo(sx,sy); paintCtx.lineTo(x,y); paintCtx.stroke(); } } });

// --- FICHIERS ---
function saveToPC() {
    let b = new Blob([JSON.stringify(app)], {type:"application/json"});
    let a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = "CCAS_PROJET.json"; a.click();
    alert("Sauvegarde t√©l√©charg√©e !");
}
function loadFile(i) {
    if(!i.files[0]) return;
    let r = new FileReader();
    r.onload = e => {
        try { app = JSON.parse(e.target.result); document.getElementById('lbl-proj').innerText = app.name; showView('studio'); selectBat(Object.keys(app.data)[0] || ""); }
        catch(x) { alert("Fichier invalide"); }
    };
    r.readAsText(i.files[0]);
}
function setLogo(i) { if(i.files[0]) { let r=new FileReader(); r.onload=e=>{ document.getElementById('img-logo').src=e.target.result; }; r.readAsDataURL(i.files[0]); } }

// --- GENERATION ZIP ---
function generateZip() {
    if(typeof JSZip === 'undefined') { alert("Erreur ZIP. V√©rifiez connexion."); return; }
    document.getElementById('loader').style.display='flex';
    setTimeout(() => {
        let zip = new JSZip();
        let json = JSON.stringify(app.data).replace(/</g,'\\u003c');
        let logo = document.getElementById('img-logo').src;
        
        let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${app.name}</title><style>
        body{margin:0;background:#000;font-family:sans-serif;height:100vh;display:flex;overflow:hidden;color:white;}
        #side{width:250px;background:#0A1A3C;border-right:3px solid #CCA43B;display:flex;flex-direction:column;}
        .btn{padding:15px;color:#888;background:none;border:none;text-align:left;cursor:pointer;border-bottom:1px solid #222;width:100%;font-size:16px;}
        .btn.active{color:#CCA43B;font-weight:bold;background:rgba(255,255,255,0.1);border-left:5px solid #CCA43B;}
        #main{flex:1;display:flex;flex-direction:column;}
        #top{height:75vh;display:flex;align-items:center;justify-content:center;border-bottom:3px solid #CCA43B;position:relative;}
        #bot{height:25vh;background:#111;padding:20px;overflow-y:auto;}
        img{max-width:100%;max-height:100%;}
        #desc{font-size:1.2rem;line-height:1.5;} #desc * {color:white!important;}
        .nav{position:absolute;top:50%;transform:translateY(-50%);font-size:40px;color:white;background:rgba(204,164,59,0.5);padding:10px;cursor:pointer;border-radius:50%;}
        .p{left:20px;} .n{right:20px;}
        .pdf{position:absolute;top:10px;left:10px;background:#c0392b;color:white;padding:5px 15px;border-radius:4px;border:none;font-weight:bold;cursor:pointer;z-index:99;}
        @media print{ #side,.nav,.pdf{display:none;} #top{height:70vh;page-break-inside:avoid;} #bot{height:30vh;page-break-after:always;} }
        </style></head><body>
        <button class="pdf" onclick="window.print()">üñ®Ô∏è PDF</button>
        <div id="side"><h3 style="text-align:center;color:#CCA43B">${app.name}</h3><div id="nav"></div></div>
        <div id="main"><div id="top"><img id="img"><div class="nav p" onclick="mv(-1)">‚ùÆ</div><div class="nav n" onclick="mv(1)">‚ùØ</div></div><div id="bot"><h2 id="tit" style="color:#CCA43B;margin-top:0;"></h2><div id="desc"></div></div></div>
        <script>
        var d=${json}, keys=Object.keys(d), cb=keys[0], ci=0;
        function rn(){ var n=document.getElementById('nav'); n.innerHTML=''; keys.forEach(k=>{ var b=document.createElement('button'); b.className='btn '+(cb===k?'active':''); b.innerText=k; b.onclick=()=>{cb=k;ci=0;sh();rn();}; n.appendChild(b); }); }
        function sh(){ var i=d[cb]; if(!i||!i.length){ document.getElementById('img').style.display='none'; return; } document.getElementById('img').style.display='block'; document.getElementById('img').src=i[ci].img; document.getElementById('desc').innerHTML=i[ci].text; document.getElementById('tit').innerText=cb+" ("+(ci+1)+"/"+i.length+")"; }
        function mv(x){ var l=d[cb].length; ci+=x; if(ci<0)ci=l-1; if(ci>=l)ci=0; sh(); }
        if(keys.length){ rn(); sh(); }
        <\/script></body></html>`;
        
        zip.file("Dossier_INTERACTIF.html", html);
        zip.generateAsync({type:"blob"}).then(c=>{ let a=document.createElement('a'); a.href=URL.createObjectURL(c); a.download="Dossier.zip"; a.click(); document.getElementById('loader').style.display='none'; });
    }, 1000);
}
</script>
</body>
</html>
