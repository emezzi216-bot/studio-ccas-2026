<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Studio CCAS | v40 REPARATION</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        :root { --blue: #0A1A3C; --gold: #CCA43B; --bg: #f4f7f6; --panel: #ffffff; --green: #27ae60; --red: #c0392b; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        * { box-sizing: border-box; outline: none; }
        button { cursor: pointer; }

        /* DASHBOARD */
        #view-dashboard { flex: 1; padding: 30px; display: flex; flex-direction: column; }
        .header { background: var(--panel); padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 4px solid var(--gold); }
        .btn-save-main { background: var(--green); color: white; padding: 12px 30px; border-radius: 8px; border: none; font-weight: bold; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
        .btn-usb { padding: 10px 20px; border: 1px solid #d1d5db; border-radius: 6px; font-weight: 600; background: white; color: #374151; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 25px; overflow-y: auto; padding: 10px; }
        .card { background: white; padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; box-shadow: 0 4px 6px rgba(0,0,0,0.04); position: relative; display: flex; flex-direction: column; align-items: center; }
        .card:hover { border-color: var(--gold); transform: translateY(-4px); }
        .del-btn { position: absolute; top: 12px; right: 12px; color: var(--red); font-weight: bold; background:#fee2e2; width: 32px; height: 32px; border-radius:50%; display: flex; align-items: center; justify-content: center; }
        .drag-handle-card { cursor: grab; color: #cbd5e1; font-size: 24px; width: 100%; text-align: center; margin-bottom: 10px; border-bottom: 1px solid #f3f4f6; }

        /* STUDIO */
        #view-studio { display: none; height: 100vh; flex-direction: row; }
        #sidebar { width: 300px; background: var(--blue); color: white; display: flex; flex-direction: column; z-index: 10; box-shadow: 4px 0 20px rgba(0,0,0,0.15); }
        .back-home { padding: 20px; background: rgba(0,0,0,0.2); color: var(--gold); font-weight: bold; cursor: pointer; border: none; text-align: left; width: 100%; border-bottom: 1px solid rgba(255,255,255,0.1); }
        
        #editor-main { flex: 1; display: flex; flex-direction: column; background: #eef2f6; }
        .top-bar { background: white; padding: 0 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; height: 75px; }
        .logo-box { width: 55px; height: 55px; border: 1px dashed #cbd5e1; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 6px; overflow: hidden; background: #f9fafb; }
        .logo-box img { width: 100%; height: 100%; object-fit: contain; }
        .gen-btn { background: linear-gradient(135deg, var(--blue), #1e3a8a); color: white; padding: 12px 25px; border-radius: 8px; border: none; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        .content-area { flex: 1; overflow-y: auto; padding: 40px; scroll-behavior: smooth; }
        
        /* PHOTOS */
        .photo-block { background: white; padding: 0; border-radius: 12px; margin-bottom: 30px; display: flex; border: 1px solid #e5e7eb; box-shadow: 0 2px 10px rgba(0,0,0,0.03); overflow: visible; }
        .drag-handle-photo { width: 30px; background: #f8fafc; cursor: grab; display: flex; align-items: center; justify-content: center; border-right: 1px solid #e5e7eb; color: #cbd5e1; font-size: 20px; }
        .photo-block.dragging { opacity: 0.5; border: 2px dashed var(--blue); }

        .photo-col { width: 300px; background: #f9fafb; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; border-right: 1px solid #e5e7eb; position: relative; }
        .photo-img { width: 100%; height: 200px; object-fit: contain; border: 1px solid #ccc; background: white; border-radius: 6px; cursor: pointer; }
        .btn-edit-photo { background: #374151; color: white; border: none; padding: 10px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; }
        .del-p-btn { position: absolute; top: 10px; left: 10px; background: var(--red); color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; z-index: 5; }

        .text-col { flex: 1; padding: 20px; display: flex; flex-direction: column; }
        .toolbar { display: flex; gap: 5px; margin-bottom: 10px; background: #f1f5f9; padding: 8px; border-radius: 8px; border: 1px solid #ddd; flex-wrap: wrap; }
        .toolbar button, .toolbar input[type=color] { height: 32px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; min-width: 32px; }
        .rich-text { flex: 1; min-height: 150px; border: 1px solid #ccc; padding: 15px; border-radius: 6px; font-size: 16px; overflow-y: auto; background: #fff; color: black; }

        /* BATIMENTS */
        .bat-item { padding: 12px 15px; margin-bottom: 8px; background: rgba(255,255,255,0.05); cursor: pointer; display: flex; align-items: center; border-radius: 6px; color: #eee; transition: 0.2s; }
        .bat-item.active { background: white; color: var(--blue); font-weight: bold; }
        .bat-item.dragging { opacity: 0.5; border: 1px dashed white; }
        .drag-handle-bat { cursor: grab; padding-right: 10px; color: rgba(255,255,255,0.3); font-size: 20px; }

        /* PAINT */
        #paint-modal { position: fixed; inset: 0; background: #1e1e1e; z-index: 20000; display: none; flex-direction: column; }
        .paint-header { height: 60px; background: #252526; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; color: white; }
        .paint-toolbar { height: 80px; background: #333; display: flex; align-items: center; justify-content: center; gap: 20px; }
        #paint-canvas-container { flex: 1; display: flex; align-items: center; justify-content: center; background: #111; overflow: hidden; }
        #paint-canvas { cursor: crosshair; box-shadow: 0 0 50px black; }
        .p-btn { width: 40px; height: 40px; background: #444; border: 1px solid #555; color: white; font-size: 18px; cursor: pointer; }
        .p-btn.active { background: var(--gold); color: black; }
        .color-swatch { width: 28px; height: 28px; border-radius: 4px; border: 2px solid transparent; cursor: pointer; }
        .color-swatch.active { border-color: white; transform: scale(1.1); box-shadow: 0 0 0 2px white; }

        /* MODALS */
        #overlay, #success-modal { position: fixed; inset: 0; background: rgba(10, 26, 60, 0.95); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .success-box { background: white; width: 600px; padding: 40px; border-radius: 16px; text-align: left; color: #1f2937; border-top: 8px solid var(--green); }
        #save-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--green); color: white; padding: 10px 30px; border-radius: 50px; font-weight: bold; opacity: 0; transition: 0.3s; z-index: 30000; pointer-events: none; }
        #save-toast.show { opacity: 1; top: 40px; }
        #photo-courage { width: 200px; height: 200px; border-radius: 50%; border: 6px solid var(--gold); object-fit: cover; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="save-toast">‚úÖ ENREGISTR√â !</div>

<input type="file" id="import-input" style="display:none" onchange="loadFile(this)">
<input type="file" id="photo-input" style="display:none" multiple accept="image/*" onchange="processPhotos(this)">
<input type="file" id="courage-input" style="display:none" onchange="updateCourage(this)">
<input type="file" id="logo-input" style="display:none" onchange="updateLogo(this)">

<div id="view-dashboard">
    <div class="header">
        <div><h1 style="color:var(--blue); margin:0;">STUDIO CCAS <span style="font-size:12px; background:var(--gold); color:black; padding:2px 6px; border-radius:4px;">v40</span></h1><p style="margin:0;color:#666;">Direction des Finances</p></div>
        <button class="btn-save-main" onclick="manualSave()">üíæ ENREGISTRER TOUT</button>
        <div style="display:flex; gap:10px;">
            <button class="btn-usb" onclick="saveToUSB()">üíæ SAUVEGARDE USB</button>
            <button class="btn-usb" onclick="document.getElementById('import-input').click()">üìÇ OUVRIR USB</button>
        </div>
    </div>
    <div id="grid-projects" class="grid"></div>
</div>

<div id="view-studio">
    <div id="sidebar">
        <button class="back-home" onclick="goDashboard()">‚¨ÖÔ∏è DOSSIERS</button>
        <div style="padding:20px; text-align:center; color:var(--gold); font-weight:bold; font-size:1.1rem; border-bottom:1px solid rgba(255,255,255,0.1);" id="lbl-proj">Projet</div>
        <div id="list-bat" style="flex:1; overflow-y:auto; padding:10px;"></div>
        <div style="padding:20px;"><button onclick="newBat()" style="width:100%; padding:15px; background:transparent; border:2px dashed rgba(255,255,255,0.3); color:white; font-weight:bold; cursor:pointer;">+ NOUVEAU B√ÇTIMENT</button></div>
    </div>
    <div id="editor-main">
        <div class="top-bar">
            <div class="logo-box" onclick="document.getElementById('logo-input').click()" title="Logo"><img id="logo-preview" src="Logo_Cr√©teil_Val_Marne.svg.png" onerror="this.src='https://via.placeholder.com/50?text=LOGO'"></div>
            <div id="lbl-bat" style="font-weight:bold; color:var(--blue); font-size:1.5rem;">Accueil</div>
            <div style="display:flex; gap:15px;">
                <button class="btn-save-main" onclick="manualSave()">üíæ ENREGISTRER</button>
                <button class="gen-btn" onclick="generateZip()">üì¶ G√âN√âRER (INTERACTIF)</button>
            </div>
        </div>
        <div id="area-photos" class="content-area"></div>
    </div>
</div>

<div id="paint-modal">
    <div class="paint-header">
        <div style="font-weight:bold; font-size:1.2rem;">üé® RETOUCHE</div>
        <div style="display:flex; gap:10px;">
            <button onclick="savePaint()" style="background:var(--gold); color:black; border:none; padding:8px 25px; font-weight:bold;">üíæ OK</button>
            <button onclick="closePaint()" style="background:#555; color:white; border:none; padding:8px 20px;">Annuler</button>
        </div>
    </div>
    <div class="paint-toolbar">
        <button class="p-btn active" onclick="setTool('rect')">‚¨ú</button>
        <button class="p-btn" onclick="setTool('circle')">‚≠ï</button>
        <button class="p-btn" onclick="setTool('arrow')">‚ÜóÔ∏è</button>
        <button class="p-btn" onclick="setTool('free')">‚úèÔ∏è</button>
        <button class="p-btn" onclick="undoPaint()">‚Ü©Ô∏è</button>
        <div style="width:20px"></div>
        <div class="color-swatch active" style="background:#ff0000;" onclick="setColor('#ff0000', this)"></div>
        <div class="color-swatch" style="background:#ffff00;" onclick="setColor('#ffff00', this)"></div>
        <div class="color-swatch" style="background:#0000ff;" onclick="setColor('#0000ff', this)"></div>
        <div class="color-swatch" style="background:#ffffff;" onclick="setColor('#ffffff', this)"></div>
        <input type="range" min="2" max="20" value="5" oninput="setLineWidth(this.value)" style="width:100px;">
    </div>
    <div id="paint-canvas-container"><canvas id="paint-canvas"></canvas></div>
</div>

<div id="overlay">
    <img src="courage.jpg.JPG" id="photo-courage" onclick="document.getElementById('courage-input').click()" onerror="this.src='https://via.placeholder.com/300?text=PHOTO+MANQUANTE'" style="width:200px; height:200px; border-radius:50%; border:5px solid var(--gold); object-fit:cover; margin-bottom:20px;">
    <h2 style="color:var(--gold);">COURAGE MAMIE ! ‚ù§Ô∏è</h2>
    <p>G√©n√©ration du dossier en cours...</p>
</div>

<div id="success-modal">
    <div class="success-box">
        <h2 style="color:var(--blue); margin-top:0;">üì¶ Dossier Pr√™t !</h2>
        <p>Le fichier <strong>Dossier_Final.zip</strong> est dans <strong>T√©l√©chargements</strong>.</p>
        <div style="background:#f0f9ff; padding:15px; border-radius:8px; margin:15px 0; border:1px solid #bae6fd;">
            <strong>Contenu :</strong>
            <ul style="margin:10px 0 0 20px;">
                <li>üìÇ <strong>_INTERACTIF.html</strong> : Le rapport final avec texte blanc forc√©.</li>
            </ul>
        </div>
        <button style="background:var(--blue); color:white; border:none; padding:15px 30px; width:100%; border-radius:8px; font-weight:bold; cursor:pointer;" onclick="document.getElementById('success-modal').style.display='none'">FERMER</button>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('ccas_db_v40')) || {};
    let appConfig = JSON.parse(localStorage.getItem('ccas_config')) || { logo: "", courage: "" };
    let curP = null, curB = null;
    let canvas, ctx, paintImg, isDrawing=false, startX, startY, currentTool='rect', currentColor='#ff0000', currentWidth=5, paintHistory=[], currentPhotoIndex=null, dragSrcEl = null;

    window.onload = () => {
        refreshGrid();
        if(appConfig.logo) document.getElementById('logo-preview').src=appConfig.logo;
        if(appConfig.courage) document.getElementById('photo-courage').src=appConfig.courage;
        if(!appConfig.logo) { const img=document.getElementById('logo-preview'); if(img.complete && img.naturalWidth>0) imgTo64(img, r=>{appConfig.logo=r;saveConfig();}); }
        canvas = document.getElementById('paint-canvas'); ctx = canvas.getContext('2d');
        canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw); window.addEventListener('mouseup', stopDraw);
    };

    function notifySave() { const t = document.getElementById('save-toast'); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); }
    function manualSave() { 
        try {
            localStorage.setItem('ccas_db_v40', JSON.stringify(db)); 
            notifySave(); 
        } catch(e) {
            alert("‚ö†Ô∏è M√âMOIRE PLEINE ! Impossible de sauvegarder. Supprimez des photos ou des anciens dossiers.");
        }
    }
    function save() { try { localStorage.setItem('ccas_db_v40', JSON.stringify(db)); } catch(e){ console.log("Auto-save failed: full"); } }
    function saveConfig() { localStorage.setItem('ccas_config', JSON.stringify(appConfig)); }
    function imgTo64(img, cb) { try { const c=document.createElement('canvas');c.width=img.naturalWidth;c.height=img.naturalHeight;c.getContext('2d').drawImage(img,0,0);cb(c.toDataURL('image/png')); } catch(e){} }
    function updateLogo(i) { if(i.files[0]) { const r=new FileReader(); r.onload=e=>{ document.getElementById('logo-preview').src=e.target.result; appConfig.logo=e.target.result; saveConfig(); }; r.readAsDataURL(i.files[0]); } }
    function updateCourage(i) { if(i.files[0]) { const r=new FileReader(); r.onload=e=>{ document.getElementById('photo-courage').src=e.target.result; appConfig.courage=e.target.result; saveConfig(); }; r.readAsDataURL(i.files[0]); } }

    function refreshGrid() {
        const g = document.getElementById('grid-projects');
        g.innerHTML = `<div class="card" onclick="createProj()" style="border:2px dashed #cbd5e1; justify-content:center; color:#9ca3af;"><h1>+</h1><div style="font-weight:bold;">NOUVEAU DOSSIER</div></div>`;
        let keys = Object.keys(db).sort((a,b) => (db[a].order||0) - (db[b].order||0));
        keys.forEach(id => {
            const p = db[id];
            const div = document.createElement('div');
            div.className = 'card'; div.draggable = true; div.dataset.id = id;
            div.innerHTML = `<div class="del-btn" onclick="delProj('${id}', event)">√ó</div><div class="drag-handle-card">‚†ø</div><div style="font-size:2.5rem; margin-bottom:10px;">üìÅ</div><div style="font-weight:bold; color:#0A1A3C; font-size:1.1rem;">${p.name}</div><div style="color:#6b7280; font-size:0.8rem; margin-top:5px;">${new Date(p.date).toLocaleDateString()}</div>`;
            div.onclick = (e) => { if(!e.target.closest('.del-btn')) openProj(id); };
            div.ondragstart = function(e) { dragSrcEl = this; e.dataTransfer.effectAllowed = 'move'; this.classList.add('dragging'); };
            div.ondragover = function(e) { if(e.preventDefault) e.preventDefault(); return false; };
            div.ondrop = function(e) {
                if(e.stopPropagation) e.stopPropagation(); this.classList.remove('dragging');
                if(dragSrcEl !== this && dragSrcEl.classList.contains('card')) {
                    let all = Array.from(g.querySelectorAll('.card:not(:first-child)'));
                    let srcI = all.indexOf(dragSrcEl); let tgtI = all.indexOf(this);
                    if(srcI < tgtI) this.after(dragSrcEl); else this.before(dragSrcEl);
                    Array.from(g.querySelectorAll('.card:not(:first-child)')).forEach((c, i) => db[c.dataset.id].order = i);
                    save();
                } return false;
            };
            div.ondragend = function() { this.classList.remove('dragging'); };
            g.appendChild(div);
        });
    }

    function createProj() { const n = prompt("Nom du dossier :"); if(n) { const id = Date.now().toString(); db[id] = { name:n, date:Date.now(), order:9999, data:{} }; save(); openProj(id); } }
    function delProj(id, e) { e.stopPropagation(); if(confirm("Supprimer ce dossier ?")) { delete db[id]; save(); refreshGrid(); } }
    function saveToUSB() { const d = { db: db, config: appConfig }; const b = new Blob([JSON.stringify(d)], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `CCAS_SAUVEGARDE_${new Date().toLocaleDateString().replace(/\//g,'-')}.json`; a.click(); }
    function loadFile(i) { const f = i.files[0]; if(!f) return; const r = new FileReader(); r.onload = e => { try { const j = JSON.parse(e.target.result); if(j.config) { appConfig = j.config; db = { ...db, ...j.db }; saveConfig(); } else { db = { ...db, ...j }; } save(); refreshGrid(); alert("Dossiers r√©cup√©r√©s !"); } catch(err) { alert("Fichier invalide."); } }; r.readAsText(f); }

    function openProj(id) { curP = id; curB = null; document.getElementById('view-dashboard').style.display='none'; document.getElementById('view-studio').style.display='flex'; document.getElementById('lbl-proj').innerText = db[id].name; refreshSide(); refreshMain(); }
    function goDashboard() { curP = null; document.getElementById('view-studio').style.display='none'; document.getElementById('view-dashboard').style.display='flex'; refreshGrid(); }
    function newBat() { const n = prompt("Nom du b√¢timent :"); if(n) { if(!db[curP].data[n]) { db[curP].data[n] = []; save(); openBat(n); refreshSide(); } else alert("Existe d√©j√†"); } }
    
    function refreshSide() { 
        const l = document.getElementById('list-bat'); l.innerHTML = ''; 
        Object.keys(db[curP].data).forEach(b => { 
            const d = document.createElement('div'); d.className = `bat-item ${curB === b ? 'active' : ''}`; d.draggable = true; d.dataset.bat = b;
            d.innerHTML = `<span class="drag-handle-bat">‚ò∞</span><span style="flex:1" onclick="openBat('${b}')">${b}</span><span onclick="delBat('${b}', event)" style="color:#ff6b6b; font-weight:bold; padding:0 10px;">√ó</span>`; 
            d.ondragstart = function(e) { dragSrcEl = this; e.dataTransfer.effectAllowed='move'; this.classList.add('dragging'); };
            d.ondragover = function(e) { e.preventDefault(); };
            d.ondrop = function(e) {
                if(e.stopPropagation) e.stopPropagation(); this.classList.remove('dragging');
                if(dragSrcEl !== this && dragSrcEl.classList.contains('bat-item')) {
                    const srcKey = dragSrcEl.dataset.bat; const tgtKey = this.dataset.bat;
                    const keys = Object.keys(db[curP].data); const srcI = keys.indexOf(srcKey); const tgtI = keys.indexOf(tgtKey);
                    keys.splice(srcI, 1); keys.splice(tgtI, 0, srcKey);
                    const newData = {}; keys.forEach(k => newData[k] = db[curP].data[k]);
                    db[curP].data = newData; save(); refreshSide();
                } return false;
            };
            d.ondragend = function() { this.classList.remove('dragging'); };
            l.appendChild(d); 
        }); 
    }
    
    function delBat(b, e) { e.stopPropagation(); if(confirm("Supprimer "+b+" ?")) { delete db[curP].data[b]; if(curB === b) curB = null; save(); refreshSide(); refreshMain(); } }
    function openBat(b) { curB = b; document.getElementById('lbl-bat').innerText = b; refreshSide(); refreshMain(); }

    function refreshMain() {
        const area = document.getElementById('area-photos');
        if(!curB) { area.innerHTML = '<div style="text-align:center; color:#999; margin-top:100px; font-size:1.5rem;">‚¨ÖÔ∏è S√©lectionnez un b√¢timent pour commencer.</div>'; return; }
        area.innerHTML = `<div onclick="document.getElementById('photo-input').click()" style="padding:40px; border:3px dashed #d1d5db; text-align:center; background:white; cursor:pointer; margin-bottom:40px; font-weight:bold; color:#6b7280; border-radius:12px; font-size:1.1rem; transition:0.2s;">üì∏ CLIQUER ICI POUR AJOUTER DES PHOTOS</div>`;
        db[curP].data[curB].forEach((p, idx) => {
            const div = document.createElement('div');
            div.className = 'photo-block'; div.draggable = true; div.dataset.index = idx;
            div.ondragstart = function(e){ dragSrcEl = this; e.dataTransfer.effectAllowed = 'move'; this.classList.add('dragging'); };
            div.ondragover = function(e){ if(e.preventDefault) e.preventDefault(); return false; };
            div.ondrop = function(e){
                if(e.stopPropagation) e.stopPropagation();
                if(dragSrcEl !== this && dragSrcEl.classList.contains('photo-block')) {
                    const oldIdx = parseInt(dragSrcEl.dataset.index); const newIdx = parseInt(this.dataset.index);
                    const arr = db[curP].data[curB]; const item = arr.splice(oldIdx, 1)[0]; arr.splice(newIdx, 0, item);
                    save(); refreshMain();
                } return false;
            };
            div.ondragend = function(){ this.classList.remove('dragging'); };

            div.innerHTML = `
                <div class="drag-handle-photo">‚†ø</div>
                <div class="photo-col">
                    <div class="del-p-btn" onclick="delPhoto(${idx})" title="Supprimer">√ó</div>
                    <img src="${p.img}" class="photo-img" onclick="openPaint(${idx})">
                    <button class="btn-edit-photo" onclick="openPaint(${idx})">üé® RETOUCHER</button>
                </div>
                <div class="text-col">
                    <div class="toolbar">
                        <button onclick="cmd('bold')" title="Gras"><b>B</b></button>
                        <button onclick="cmd('italic')" title="Italique"><i>I</i></button>
                        <button onclick="cmd('underline')" title="Soulign√©"><u>U</u></button>
                        <input type="color" onchange="cmd('foreColor', this.value)" title="Couleur" value="#000000">
                        <button onclick="cmd('hiliteColor', 'yellow')" style="background:yellow;border:1px solid #ccc;">üñçÔ∏è</button>
                        <button onclick="cmd('justifyLeft')">‚´∑</button><button onclick="cmd('justifyCenter')">||</button><button onclick="cmd('insertUnorderedList')">‚Ä¢ Liste</button>
                        <select onchange="cmd('fontSize', this.value)"><option value="3">Normale</option><option value="5">Grande</option><option value="6">Tr√®s Grande</option></select>
                    </div>
                    <div class="rich-text" contenteditable="true" oninput="updateTxt(${idx}, this.innerHTML)">${p.desc}</div>
                </div>`;
            area.appendChild(div);
        });
    }

    function cmd(c, v=null) { document.execCommand(c, false, v); }
    
    // --- CORRECTION UPLOAD PHOTOS ---
    function processPhotos(input) { 
        if(!input.files || input.files.length === 0) return;
        
        Array.from(input.files).forEach(f => { 
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    // REDUCTION AGRESSIVE POUR EVITER LE BLOCAGE MEMOIRE
                    const MAX_WIDTH = 800; // 800px suffisent pour un rapport standard et √©conomisent la m√©moire
                    let width = img.width; let height = img.height;
                    
                    if (width > MAX_WIDTH) { 
                        height *= MAX_WIDTH / width; 
                        width = MAX_WIDTH; 
                    }
                    
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // COMPRESSION JPEG 0.6 (Qualit√© moyenne mais fichier l√©ger)
                    try {
                        const dataUrl = canvas.toDataURL("image/jpeg", 0.6);
                        db[curP].data[curB].push({img: dataUrl, desc: "Cliquez ici pour √©crire..."}); 
                        save(); 
                        refreshMain();
                    } catch(e) {
                        alert("ERREUR MEMOIRE: Photo trop lourde ou m√©moire pleine.");
                    }
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(f);
        }); 
        // IMPORTANT: Reset l'input pour pouvoir r√©importer la m√™me photo si on s'est tromp√©
        input.value = '';
    }

    function delPhoto(idx) { if(confirm("Supprimer ?")) { db[curP].data[curB].splice(idx, 1); save(); refreshMain(); } }
    function updateTxt(idx, h) { db[curP].data[curB][idx].desc = h; save(); }

    function openPaint(idx) {
        currentPhotoIndex = idx; const src = db[curP].data[curB][idx].img; paintImg = new Image();
        paintImg.onload = () => {
            const maxW = window.innerWidth * 0.8, maxH = window.innerHeight * 0.7;
            let w = paintImg.width, h = paintImg.height, r = Math.min(maxW/w, maxH/h);
            w *= r; h *= r; canvas.width = w; canvas.height = h;
            ctx.lineJoin = 'round'; ctx.lineCap = 'round'; ctx.drawImage(paintImg, 0, 0, w, h);
            saveHistory(); document.getElementById('paint-modal').style.display = 'flex';
        }; paintImg.src = src;
    }
    function setTool(t) { currentTool = t; document.querySelectorAll('.p-btn').forEach(b=>b.classList.remove('active')); event.currentTarget.classList.add('active'); }
    function setColor(c, el) { currentColor = c; if(el){ document.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('active')); el.classList.add('active'); } }
    function setLineWidth(w) { currentWidth = w; }
    function saveHistory() { paintHistory.push(canvas.toDataURL()); if(paintHistory.length>8) paintHistory.shift(); }
    function undoPaint() { if(paintHistory.length>1) { paintHistory.pop(); let i = new Image(); i.onload=()=>{ctx.clearRect(0,0,canvas.width,canvas.height);ctx.drawImage(i,0,0);}; i.src = paintHistory[paintHistory.length-1]; } }
    function startDraw(e) { isDrawing=true; const r=canvas.getBoundingClientRect(); startX=e.clientX-r.left; startY=e.clientY-r.top; saveHistory(); }
    function draw(e) {
        if(!isDrawing) return; const r=canvas.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
        if(currentTool==='free') { ctx.strokeStyle=currentColor; ctx.lineWidth=currentWidth; ctx.lineTo(x,y); ctx.stroke(); }
        else {
            let i=new Image(); i.src=paintHistory[paintHistory.length-1]; ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(i,0,0);
            ctx.strokeStyle=currentColor; ctx.lineWidth=currentWidth; ctx.beginPath();
            if(currentTool==='circle'){ let rad=Math.sqrt(Math.pow(x-startX,2)+Math.pow(y-startY,2)); ctx.arc(startX,startY,rad,0,2*Math.PI); ctx.stroke(); }
            else if(currentTool==='rect'){ ctx.strokeRect(startX,startY,x-startX,y-startY); }
            else if(currentTool==='arrow'){ const h=15+currentWidth*0.5, a=Math.atan2(y-startY,x-startX); ctx.moveTo(startX,startY); ctx.lineTo(x,y); ctx.lineTo(x-h*Math.cos(a-Math.PI/6),y-h*Math.sin(a-Math.PI/6)); ctx.moveTo(x,y); ctx.lineTo(x-h*Math.cos(a+Math.PI/6),y-h*Math.sin(a+Math.PI/6)); ctx.stroke(); }
        }
    }
    function stopDraw() { if(isDrawing && currentTool==='free') ctx.beginPath(); isDrawing=false; }
    function savePaint() { db[curP].data[curB][currentPhotoIndex].img=canvas.toDataURL('image/jpeg',0.9); save(); notifySave(); closePaint(); refreshMain(); }
    function closePaint() { document.getElementById('paint-modal').style.display='none'; paintHistory=[]; }

    function generateZip() {
        if(!window.JSZip) { alert("ERREUR : JSZip non charg√©. V√©rifiez votre connexion."); return; }
        const proj = db[curP]; document.getElementById('overlay').style.display='flex';
        const finalLogo = appConfig.logo || "";
        
        setTimeout(() => {
            try {
                const json = JSON.stringify(proj.data).replace(/</g, '\\u003c');
                
                let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${proj.name}</title><style>
                body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #0A1A3C; color: #F4F7FD; height: 100vh; display: flex; overflow: hidden; }
                
                /* SIDEBAR GAUCHE */
                #side { width: 280px; background: #050E24; border-right: 3px solid #CCA43B; display: flex; flex-direction: column; z-index: 10; box-shadow: 5px 0 15px rgba(0,0,0,0.5); position: relative; }
                .head { padding: 25px; color: #CCA43B; font-weight: 800; border-bottom: 1px solid #1f2d40; text-transform: uppercase; text-align: center; }
                .btn { width: 100%; padding: 20px; text-align: left; border: none; background: none; color: #8E8E93; cursor: pointer; border-bottom: 1px solid #111; transition: 0.2s; font-size: 16px; }
                .btn.active { color: #CCA43B; background: rgba(204,164,59,0.1); border-left: 5px solid #CCA43B; font-weight: bold; }
                .btn:hover { color: white; }
                
                /* MAIN (Flexbox Vertical) */
                #main { flex: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }
                
                /* ZONE CONTENU (Image + Texte) */
                .view { 
                    height: 75vh; /* IMAGE FIG√âE A 75% DE LA HAUTEUR ECRAN */
                    width: 100%;
                    padding: 20px 20px 0 20px;
                    box-sizing: border-box;
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                    position: relative;
                }
                
                .frame { 
                    width: 100%; 
                    height: 100%; 
                    border: 3px solid #CCA43B; 
                    border-bottom: none;
                    background: #000; 
                    box-shadow: 0 0 50px rgba(0,0,0,0.8);
                    position: relative;
                    display: flex;
                    flex-direction: column;
                }
                
                /* HEADER IMAGE (Fixe en haut de l'image) */
                .top-zone { 
                    position: absolute; 
                    top: 10px; 
                    right: 10px; 
                    display: flex; 
                    align-items: center; 
                    gap: 10px; 
                    background: rgba(10,26,60,0.9); 
                    padding: 5px 10px; 
                    border: 1px solid #CCA43B; 
                    border-radius: 4px; 
                    z-index: 100; 
                }
                .logo { height: 40px; width: auto; display: block; }
                .txt { margin: 0; font-size: 9px !important; color: #CCA43B; font-weight: 700; text-transform: uppercase; line-height: 1.1; text-align: left; }
                
                /* IMAGE CONTAINER */
                #sc { 
                    flex: 1; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    overflow: hidden; 
                    background: #000;
                    position: relative;
                    width: 100%;
                }
                #sc img { 
                    max-width: 100%; 
                    max-height: 100%; 
                    object-fit: contain; 
                }
                
                /* TEXTE CONTAINER (En bas, FIG√â A 25% DE LA HAUTEUR ECRAN) */
                .bot { 
                    height: 25vh; /* TEXTE FIG√â A 25% DE LA HAUTEUR ECRAN */
                    width: 100%;
                    padding: 20px; 
                    background: rgba(5,14,36,0.95); 
                    border: 3px solid #CCA43B; 
                    overflow-y: auto; 
                    box-sizing: border-box;
                    margin: 0 20px 20px 20px;
                    width: calc(100% - 40px);
                }
                
                /* NAVIGATION */
                .arr { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(10,26,60,0.8); color: #CCA43B; border: 2px solid #CCA43B; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; font-size: 20px; z-index: 60; transition:0.2s; }
                .arr:hover { background: #CCA43B; color: black; }
                .al { left: 10px; } .ar { right: 10px; }
                
                /* BOUTON PDF (Haut Gauche) */
                .btn-print { 
                    position: absolute; 
                    top: 10px; 
                    left: 290px; /* Juste apr√®s la sidebar */
                    background: #c0392b; 
                    color: white; 
                    padding: 8px 15px; 
                    border-radius: 4px; 
                    border: none; 
                    font-weight: bold; 
                    font-size: 12px; 
                    cursor: pointer; 
                    z-index: 9999; 
                    opacity: 0.3; 
                    transition: 0.3s;
                }
                .btn-print:hover { opacity: 1; transform: scale(1.05); }
                
                /* FORCE LE TEXTE EN BLANC */
                #desc { color: #ffffff !important; font-size: 1.1rem; line-height: 1.5; }
                #desc * { color: inherit !important; background-color: transparent !important; }
                #tit { color: #CCA43B; margin: 0 0 5px 0; text-transform: uppercase; font-size: 1.2rem; border-bottom: 1px solid #333; padding-bottom: 5px; }
                
                /* MODE IMPRESSION */
                @media print {
                    body { display: block; overflow: visible; background: #0A1A3C; -webkit-print-color-adjust: exact; }
                    #side, .btn-print, .arr { display: none !important; }
                    #main { height: auto; display: block; }
                    .view { height: 70vh; page-break-after: avoid; padding: 0; margin: 0; display: flex; width: 100%; }
                    .frame { height: 100%; border: 2px solid #CCA43B; width: 100%; }
                    .bot { height: 25vh; border: 2px solid #CCA43B; border-top: none; page-break-after: always; margin: 0; width: 100%; }
                }
                </style></head><body>
                
                <button class="btn-print" onclick="window.print()">üñ®Ô∏è PDF</button>
                
                <div id="side"><div class="head">${proj.name}</div><div id="nav" style="flex:1;overflow-y:auto"></div></div>
                <div id="main">
                    <div class="view">
                        <div class="frame" id="fr">
                            <div class="top-zone"><img src="${finalLogo}" class="logo"><div class="txt">DIRECTION G√âN√âRALE<br>DES FINANCES ET DES<br>MOYENS G√âN√âRAUX</div></div>
                            <div id="sc"></div>
                        </div>
                    </div>
                    <div class="bot">
                        <h2 id="tit"></h2>
                        <div id="desc"></div>
                    </div>
                </div>
                
                <script>
                const d=${json};
                let cB = Object.keys(d)[0];
                let cI = 0;
                
                function rn() {
                    const n = document.getElementById('nav');
                    n.innerHTML = '';
                    Object.keys(d).forEach(k => {
                        const b = document.createElement('button');
                        b.className = 'btn' + (cB === k ? ' active' : '');
                        b.innerText = k;
                        b.onclick = () => { cB = k; cI = 0; sh(); rn(); };
                        n.appendChild(b);
                    });
                }
                
                function sh() {
                    const s = document.getElementById('sc');
                    const f = document.getElementById('fr');
                    const i = d[cB];
                    
                    if (!i || !i.length) {
                        s.innerHTML = '';
                        document.getElementById('desc').innerHTML = 'Aucune photo';
                        f.querySelectorAll('.arr').forEach(a => a.remove());
                        return;
                    }
                    
                    s.innerHTML = '<img src="' + i[cI].img + '">';
                    document.getElementById('tit').innerText = cB + " (" + (cI + 1) + "/" + i.length + ")";
                    
                    let txt = i[cI].desc || "";
                    if(txt.includes("Cliquez ici pour √©crire...")) txt = "";
                    document.getElementById('desc').innerHTML = txt;
                    
                    f.querySelectorAll('.arr').forEach(a => a.remove());
                    if (i.length > 1) {
                        const l = document.createElement('div'); l.className = 'arr al'; l.innerHTML = '‚ùÆ';
                        l.onclick = () => { cI = (cI - 1 + i.length) % i.length; sh(); };
                        const r = document.createElement('div'); r.className = 'arr ar'; r.innerHTML = '‚ùØ';
                        r.onclick = () => { cI = (cI + 1) % i.length; sh(); };
                        f.appendChild(l); f.appendChild(r);
                    }
                }
                
                window.onload = () => { if (cB) { rn(); sh(); } };
                <\/script></body></html>`;

                const zip = new JSZip();
                const safeName = proj.name.replace(/[^a-z0-9]/gi, '_');
                zip.file("Dossier_INTERACTIF.html", html);
                
                zip.generateAsync({type:"blob"}).then(function(c) {
                    const a = document.createElement('a'); a.href = URL.createObjectURL(c); a.download = safeName + "_FINAL.zip"; a.click();
                    document.getElementById('overlay').style.display='none'; document.getElementById('success-modal').style.display='flex';
                }).catch(err => {
                    alert("Erreur ZIP : " + err);
                    document.getElementById('overlay').style.display='none';
                });
            } catch(e) {
                alert("ERREUR : " + e);
                document.getElementById('overlay').style.display='none';
            }
        }, 1000);
    }
</script>
</body>
</html>
