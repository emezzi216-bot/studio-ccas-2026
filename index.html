<!DOCTYPE html><html lang="fr"><head>
    <meta charset="UTF-8">
    <title>STUDIO CCAS | Expertise Finances</title>
    <style>
        :root { --blue: #0A1A3C; --gold: #CCA43B; --bg: #f4f7f9; --green: #27ae60; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* HEADER PRINCIPAL */
        .main-header { background: var(--blue); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 100; }
        .status-pill { background: rgba(39, 174, 96, 0.2); color: #2ecc71; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; border: 1px solid #2ecc71; font-weight: bold; }

        /* DASHBOARD */
        #view-dashboard { flex:1; padding: 40px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; }
        .folder-card { background: white; border-radius: 15px; padding: 30px; text-align: center; cursor: pointer; transition: 0.3s; border: 1px solid #ddd; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .folder-card:hover { transform: translateY(-5px); border-color: var(--gold); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .folder-card h3 { color: var(--blue); margin: 15px 0 5px 0; }
        .folder-delete { position: absolute; top: 10px; right: 10px; color: #e74c3c; font-size: 1.2rem; opacity: 0.3; }
        .folder-delete:hover { opacity: 1; }

        /* STUDIO */
        #view-studio { display: none; height: calc(100vh - 70px); flex-direction: row; }
        #sidebar { width: 300px; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .bat-nav-item { padding: 15px 20px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .bat-nav-item:hover { background: #f9f9f9; }
        .bat-nav-item.active { background: var(--blue); color: white; border-left: 5px solid var(--gold); }
        
        #editor-content { flex: 1; background: #edf0f5; display: flex; flex-direction: column; }
        .toolbar-top { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        
        /* BLOC PHOTO EXPERT */
        .photo-card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; display: flex; gap: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid var(--gold); }
        .img-container { position: relative; width: 220px; height: 150px; flex-shrink: 0; }
        .img-container img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; cursor: zoom-in; }
        
        /* TEXT EDITOR */
        .editor-tools { display: flex; gap: 5px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .tool-btn { background: #f0f0f0; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .tool-btn:hover { background: var(--gold); color: white; }
        .text-area { flex: 1; min-height: 100px; padding: 10px; border: 1px solid #eee; border-radius: 6px; font-size: 1rem; line-height: 1.5; outline: none; background: #fafafa; }
        .text-area:focus { background: #fff; border-color: var(--gold); }

        /* BOUTONS */
        .btn-expert { background: var(--green); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 1rem; }
        .btn-expert:hover { background: #219150; transform: scale(1.02); }
        
        #overlay { position: fixed; inset: 0; background: var(--blue); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .img-courage { width: 250px; height: 250px; border-radius: 50%; border: 6px solid var(--gold); margin-bottom: 20px; object-fit: cover; }
    </style>
</head>
<body>

<img src="Logo_Cr√©teil_Val_Marne.svg.png" id="sys-logo" style="display:none" crossorigin="anonymous">

<div class="main-header">
    <div style="display:flex; align-items:center; gap:15px;">
        <h2 style="margin:0; letter-spacing:1px;">STUDIO <span style="color:var(--gold)">CCAS</span></h2>
        <div class="status-pill">‚óè SYST√àME PR√äT</div>
    </div>
    <div style="display:flex; gap:10px;">
        <button onclick="saveToUSB()" style="background:transparent; border:1px solid white; color:white; padding:8px 15px; border-radius:5px; cursor:pointer;">üíæ SAUVEGARDE CL√â</button>
        <button onclick="document.getElementById('import-input').click()" style="background:white; border:none; color:var(--blue); padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">üìÇ R√âCUP√âRER TRAVAIL</button>
    </div>
</div>

<div id="view-dashboard">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h1 style="color:var(--blue); margin:0;">Mes Rapports de Chantier</h1>
        <button onclick="createProj()" style="background:var(--blue); color:white; border:none; padding:15px 30px; border-radius:10px; font-weight:bold; cursor:pointer; font-size:1.1rem;">+ CR√âER UN NOUVEAU DOSSIER</button>
    </div>
    <div id="grid-projects" class="grid"></div>
</div>

<div id="view-studio">
    <div id="sidebar">
        <button onclick="goDashboard()" style="padding:20px; background:#f8f9fa; border:none; border-bottom:1px solid #ddd; cursor:pointer; font-weight:bold; color:var(--blue);">‚¨Ö QUITTER LE DOSSIER</button>
        <div id="list-bat" style="flex:1; overflow-y:auto;"></div>
        <button onclick="newBat()" style="padding:20px; background:var(--blue); color:white; border:none; font-weight:bold; cursor:pointer;">+ AJOUTER UN B√ÇTIMENT</button>
    </div>
    <div id="editor-content">
        <div class="toolbar-top">
            <h2 id="lbl-bat" style="margin:0; color:var(--blue);">S√©lectionnez un b√¢timent</h2>
            <button class="btn-expert" onclick="generateRuse()">üöÄ G√âN√âRER LE RAPPORT (Format .doc)</button>
        </div>
        <div id="area-photos" style="flex:1; padding:30px; overflow-y:auto;"></div>
    </div>
</div>

<div id="overlay">
    <img src="courage.jpg.JPG" class="img-courage" onerror="this.src='https://via.placeholder.com/250?text=COURAGE+MAMAN'">
    <h1 style="color:var(--gold); margin:0;">COURAGE MAMAN ! ‚ù§Ô∏è</h1>
    <p>Le rapport pour les chefs est en cours de cr√©ation...</p>
</div>

<input type="file" id="import-input" style="display:none" onchange="loadFile(this)">
<input type="file" id="photo-input" style="display:none" multiple onchange="processPhotos(this)">

<script>
    let db = JSON.parse(localStorage.getItem('ccas_expert_v1')) || {};
    let curP = null, curB = null, logoData = "";

    window.onload = () => {
        refreshGrid();
        const img = document.getElementById('sys-logo');
        img.onload = () => {
            const c = document.createElement('canvas');
            c.width = img.width; c.height = img.height;
            c.getContext('2d').drawImage(img, 0, 0);
            logoData = c.toDataURL();
        };
    };

    function save() { localStorage.setItem('ccas_expert_v1', JSON.stringify(db)); }

    function refreshGrid() {
        const g = document.getElementById('grid-projects'); g.innerHTML = '';
        Object.keys(db).forEach(id => {
            const div = document.createElement('div'); div.className = 'folder-card';
            div.innerHTML = `<div class="folder-delete" onclick="event.stopPropagation(); if(confirm('Supprimer ce dossier ?')){delete db['${id}']; save(); refreshGrid();}">üóëÔ∏è</div>
                <div style="font-size:3rem; margin-bottom:10px;">üìÇ</div>
                <h3>${db[id].name}</h3>
                <div style="color:#888; font-size:0.9rem;">${Object.keys(db[id].data).length} b√¢timent(s)</div>`;
            div.onclick = () => openProj(id);
            g.appendChild(div);
        });
    }

    function createProj() { const n = prompt("Nom du nouveau dossier de travaux :"); if(n) { const id = Date.now().toString(); db[id] = { name:n, data:{} }; save(); openProj(id); } }
    function openProj(id) { curP = id; curB = null; document.getElementById('view-dashboard').style.display='none'; document.getElementById('view-studio').style.display='flex'; refreshSide(); refreshMain(); }
    function goDashboard() { document.getElementById('view-studio').style.display='none'; document.getElementById('view-dashboard').style.display='flex'; refreshGrid(); }
    
    function newBat() { const n = prompt("Nom du b√¢timent (ex: Ecole Joliot Curie) :"); if(n) { if(!db[curP].data[n]) db[curP].data[n] = []; save(); openBat(n); } }
    function refreshSide() {
        const l = document.getElementById('list-bat'); l.innerHTML = '';
        Object.keys(db[curP].data).forEach(b => {
            const div = document.createElement('div'); div.className = 'bat-nav-item' + (curB === b ? ' active' : '');
            div.innerHTML = `<span>${b}</span><span>‚ùØ</span>`;
            div.onclick = () => openBat(b);
            l.appendChild(div);
        });
    }

    function openBat(b) { curB = b; document.getElementById('lbl-bat').innerText = b; refreshSide(); refreshMain(); }
    
    function refreshMain() {
        const area = document.getElementById('area-photos'); area.innerHTML = '';
        if(!curB) { area.innerHTML = '<div style="text-align:center; margin-top:100px; color:#aaa;"><h3>Cliquez sur un b√¢timent √† gauche pour commencer</h3></div>'; return; }
        
        const addBtn = document.createElement('div');
        addBtn.style = "background:white; padding:30px; border:3px dashed var(--gold); border-radius:15px; text-align:center; cursor:pointer; color:var(--blue); font-weight:bold; margin-bottom:30px;";
        addBtn.innerHTML = "üì∏ CLIQUEZ ICI POUR AJOUTER LES PHOTOS DU B√ÇTIMENT";
        addBtn.onclick = () => document.getElementById('photo-input').click();
        area.appendChild(addBtn);

        db[curP].data[curB].forEach((p, i) => {
            const div = document.createElement('div'); div.className = 'photo-card';
            div.innerHTML = `
                <div class="img-container"><img src="${p.img}" onclick="window.open(this.src)"></div>
                <div style="flex:1; display:flex; flex-direction:column;">
                    <div class="editor-tools">
                        <button class="tool-btn" onclick="document.execCommand('bold')">B</button>
                        <button class="tool-btn" onclick="document.execCommand('italic')">I</button>
                        <button class="tool-btn" onclick="document.execCommand('foreColor', false, 'red')" style="color:red">A</button>
                        <button class="tool-btn" onclick="document.execCommand('hiliteColor', false, 'yellow')">üñçÔ∏è</button>
                        <div style="flex:1"></div>
                        <button onclick="if(confirm('Supprimer cette photo ?')){db[curP].data[curB].splice(${i},1); save(); refreshMain();}" style="background:none; border:none; color:red; cursor:pointer;">Supprimer üóëÔ∏è</button>
                    </div>
                    <div class="text-area" contenteditable="true" oninput="db[curP].data[curB][${i}].desc=this.innerHTML; save()">${p.desc}</div>
                </div>`;
            area.appendChild(div);
        });
    }

    function processPhotos(input) {
        Array.from(input.files).forEach(f => {
            const r = new FileReader();
            r.onload = e => { db[curP].data[curB].push({img: e.target.result, desc: "√âcrire les remarques ici..."}); save(); refreshMain(); };
            r.readAsDataURL(f);
        });
    }

    function generateRuse() {
        const proj = db[curP];
        document.getElementById('overlay').style.display = 'flex';
        setTimeout(() => {
            const json = JSON.stringify(proj.data).replace(/</g, '\\u003c');
            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>
                body{font-family:'Segoe UI',sans-serif;margin:0;display:flex;height:100vh;background:#050E24;color:white;overflow:hidden}
                #side{width:280px;background:#0A1A3C;border-right:3px solid #CCA43B;display:flex;flex-direction:column}
                .btn{width:100%;padding:18px;text-align:left;border:none;background:none;color:#8E8E93;cursor:pointer;border-bottom:1px solid #1f2d40;font-size:14px}
                .btn.active{color:#CCA43B;background:rgba(204,164,59,0.1);border-left:5px solid #CCA43B;font-weight:bold}
                #main{flex:1;display:flex;flex-direction:column;position:relative;background:radial-gradient(circle at center,#142850,#050E24)}
                .top-logo{position:absolute;top:20px;right:25px;display:flex;align-items:center;gap:12px;background:rgba(10,26,60,0.85);padding:10px 15px;border:1px solid #CCA43B;border-radius:6px;z-index:100}
                .logo-img{width:55px;height:auto}
                .logo-txt{font-size:9px;font-weight:800;color:#CCA43B;line-height:1.2;text-align:left;text-transform:uppercase}
                .frame{flex:1;display:flex;align-items:center;justify-content:center;padding:40px;position:relative}
                .frame img{max-width:95%;max-height:95%;border:3px solid #CCA43B;box-shadow:0 0 50px rgba(0,0,0,0.8);border-radius:4px}
                .bot{padding:35px 50px;background:rgba(5,14,36,0.95);border-top:3px solid #CCA43B;min-height:140px}
                .arr{position:absolute;top:50%;transform:translateY(-50%);background:rgba(204,164,59,0.9);color:#0A1A3C;width:55px;height:55px;display:flex;align-items:center;justify-content:center;border-radius:50%;cursor:pointer;font-weight:bold;font-size:28px;transition:0.2s}
                .arr:hover{background:#fff;transform:translateY(-50%) scale(1.1)}
            </style></head><body>
                <div id="side"><div style="padding:25px;color:#CCA43B;font-weight:bold;font-size:18px;border-bottom:1px solid #1f2d40">${proj.name}</div><div id="nav" style="flex:1;overflow-y:auto"></div></div>
                <div id="main">
                    <div class="top-logo">
                        <img src="${logoData}" class="logo-img">
                        <div class="logo-txt">DIRECTION G√âN√âRALE<br>DES FINANCES ET DES<br>MOYENS G√âN√âRAUX</div>
                    </div>
                    <div class="frame" id="fr"><div id="sc" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center"></div></div>
                    <div class="bot"><h2 id="tit" style="color:#CCA43B;margin:0 0 10px 0;text-transform:uppercase;letter-spacing:1px"></h2><div id="desc" style="font-size:1.3rem;line-height:1.6"></div></div>
                </div>
                <script>
                const d=${json};let cB=Object.keys(d)[0],cI=0;
                function sh(){
                    const s=document.getElementById('sc'),f=document.getElementById('fr'),i=d[cB];
                    if(!i||!i.length){s.innerHTML='';document.getElementById('desc').innerHTML='';return}
                    s.innerHTML='<img src="'+i[cI].img+'">';
                    document.getElementById('tit').innerText=cB; document.getElementById('desc').innerHTML=i[cI].desc;
                    document.querySelectorAll('.arr').forEach(a=>a.remove());
                    if(i.length>1){
                        const l=document.createElement('div');l.className='arr';l.style.left='25px';l.innerHTML='‚ùÆ';l.onclick=()=>{cI=(cI-1+i.length)%i.length;sh()};
                        const r=document.createElement('div');r.className='arr';r.style.right='25px';r.innerHTML='‚ùØ';r.onclick=()=>{cI=(cI+1)%i.length;sh()};
                        f.appendChild(l);f.appendChild(r);
                    }
                }
                function rn(){const n=document.getElementById('nav');n.innerHTML='';Object.keys(d).forEach(k=>{const b=document.createElement('button');b.className='btn'+(cB===k?' active':'');b.innerText=k;b.onclick=()=>{cB=k;cI=0;sh();rn()};n.appendChild(b)})}
                window.onload=()=>{if(cB){rn();sh()}};
                <\/script></body></html>`;
            
            const b = new Blob([html], {type: 'application/msword'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = proj.name + "_INTERACTIF.doc"; a.click();
            document.getElementById('overlay').style.display='none';
        }, 1500);
    }

    function saveToUSB() {
        const blob = new Blob([JSON.stringify(db)], {type: "application/json"});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `SAUVEGARDE_TRAVAUX_CCAS.json`; a.click();
    }
    function loadFile(input) {
        const r = new FileReader(); r.onload = e => { db = JSON.parse(e.target.result); save(); refreshGrid(); alert("Travail r√©cup√©r√© avec succ√®s !"); }; r.readAsText(input.files[0]);
    }
</script>
</body></html>
