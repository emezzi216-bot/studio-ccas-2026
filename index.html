<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Studio CCAS | v28 PDF Perfect</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        :root { --blue: #0A1A3C; --gold: #CCA43B; --bg: #f4f7f6; --panel: #ffffff; --green: #27ae60; --red: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        * { box-sizing: border-box; outline: none; }
        button { cursor: pointer; font-family: inherit; }

        /* --- DASHBOARD --- */
        #view-dashboard { flex: 1; padding: 30px; display: flex; flex-direction: column; }
        .header { background: var(--panel); padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 4px solid var(--gold); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 25px; overflow-y: auto; padding: 10px; }
        .card { background: white; padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; box-shadow: 0 4px 6px rgba(0,0,0,0.04); position: relative; }
        .card:hover { border-color: var(--gold); transform: translateY(-4px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .del-btn { position: absolute; top: 10px; right: 10px; background:#fee2e2; color: var(--red); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* --- STUDIO --- */
        #view-studio { display: none; height: 100vh; flex-direction: row; }
        #sidebar { width: 300px; background: var(--blue); color: white; display: flex; flex-direction: column; z-index: 10; box-shadow: 4px 0 20px rgba(0,0,0,0.15); }
        #editor-main { flex: 1; display: flex; flex-direction: column; background: #eef2f6; }
        .top-bar { background: white; padding: 0 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; height: 75px; }
        
        /* BOUTONS */
        .btn-save-main { background: var(--green); color: white; padding: 10px 25px; border-radius: 8px; border: none; font-weight: bold; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
        .btn-gen { background: linear-gradient(135deg, var(--blue), #1e3a8a); color: white; padding: 10px 25px; border-radius: 8px; border: none; font-weight: bold; }
        .btn-usb { padding: 8px 15px; border: 1px solid #ccc; border-radius: 6px; background: white; font-weight: bold; color: #333; }

        /* ZONE D'EDITION */
        .content-area { flex: 1; overflow-y: auto; padding: 40px; scroll-behavior: smooth; }
        
        .photo-block { background: white; border-radius: 12px; margin-bottom: 30px; display: flex; border: 1px solid #e5e7eb; box-shadow: 0 2px 10px rgba(0,0,0,0.03); overflow: hidden; height: 350px; }
        
        /* GAUCHE : PHOTO */
        .photo-col { width: 40%; background: #f8fafc; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid #e5e7eb; position: relative; }
        .photo-img { max-width: 100%; max-height: 250px; object-fit: contain; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-edit-photo { margin-top: 10px; background: #374151; color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; font-size: 12px; width: 100%; }
        .del-p-btn { position: absolute; top: 10px; left: 10px; background: var(--red); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; z-index: 5; }

        /* DROITE : TEXTE */
        .text-col { width: 60%; padding: 20px; display: flex; flex-direction: column; background: white; }
        .toolbar { display: flex; gap: 5px; margin-bottom: 10px; background: #f1f5f9; padding: 8px; border-radius: 8px; border: 1px solid #ddd; flex-wrap: wrap; }
        .toolbar button, .toolbar input[type=color], .toolbar select { height: 30px; background: white; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; min-width: 30px; display: flex; align-items: center; justify-content: center; }
        .rich-text { flex: 1; border: 1px solid #ccc; padding: 15px; border-radius: 6px; font-size: 16px; overflow-y: auto; color: black; line-height: 1.5; }
        .rich-text:focus { border-color: var(--blue); box-shadow: 0 0 0 2px rgba(10,26,60,0.1); }

        /* ITEMS SIDEBAR */
        .bat-item { padding: 12px; margin-bottom: 5px; cursor: pointer; color: #eee; border-radius: 6px; display: flex; align-items: center; }
        .bat-item:hover { background: rgba(255,255,255,0.1); }
        .bat-item.active { background: white; color: var(--blue); font-weight: bold; }
        .drag-handle { cursor: grab; padding-right: 10px; font-size: 18px; opacity: 0.5; }

        /* PAINT MODAL */
        #paint-modal { position: fixed; inset: 0; background: #1e1e1e; z-index: 20000; display: none; flex-direction: column; }
        .paint-toolbar { height: 70px; background: #333; display: flex; align-items: center; justify-content: center; gap: 15px; }
        #paint-canvas-container { flex: 1; display: flex; align-items: center; justify-content: center; background: #111; }
        .p-btn { width: 40px; height: 40px; background: #444; border: 1px solid #555; color: white; font-size: 20px; border-radius: 4px; }
        .p-btn.active { background: var(--gold); color: black; }

        /* NOTIF */
        #save-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--green); color: white; padding: 10px 30px; border-radius: 50px; font-weight: bold; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 9999; }
        #save-toast.show { opacity: 1; top: 40px; }
        
        #overlay { position:fixed; inset:0; background:rgba(10,26,60,0.95); z-index:10000; display:none; flex-direction:column; align-items:center; justify-content:center; color:white; }
    </style>
</head>
<body>

<div id="save-toast">‚úÖ SAUVEGARD√â !</div>

<input type="file" id="import-input" style="display:none" onchange="loadFile(this)">
<input type="file" id="photo-input" style="display:none" multiple onchange="processPhotos(this)">
<input type="file" id="courage-input" style="display:none" onchange="updateCourage(this)">
<input type="file" id="logo-input" style="display:none" onchange="updateLogo(this)">

<div id="view-dashboard">
    <div class="header">
        <div><h1 style="color:var(--blue); margin:0;">STUDIO CCAS <span style="font-size:12px; background:var(--gold); padding:2px 6px; border-radius:4px; color:black;">v28</span></h1><p style="margin:0;color:#666;">Gestion des Rapports</p></div>
        <button class="btn-save-main" onclick="manualSave()">üíæ ENREGISTRER TOUT</button>
        <div style="display:flex; gap:10px;">
            <button class="btn-usb" onclick="saveToUSB()">Sauvegarder USB</button>
            <button class="btn-usb" onclick="document.getElementById('import-input').click()">Ouvrir USB</button>
        </div>
    </div>
    <div id="grid-projects" class="grid"></div>
</div>

<div id="view-studio">
    <div id="sidebar">
        <button class="back-home" onclick="goDashboard()">‚¨ÖÔ∏è DOSSIERS</button>
        <div style="padding:20px; text-align:center; color:var(--gold); font-weight:bold; border-bottom:1px solid rgba(255,255,255,0.1);" id="lbl-proj">Projet</div>
        <div id="list-bat" style="flex:1; overflow-y:auto; padding:10px;"></div>
        <div style="padding:20px;"><button onclick="newBat()" style="width:100%; padding:15px; background:transparent; border:2px dashed rgba(255,255,255,0.3); color:white; font-weight:bold; cursor:pointer;">+ B√ÇTIMENT</button></div>
    </div>
    <div id="editor-main">
        <div class="top-bar">
            <div style="width:50px; height:50px; border:1px dashed #ccc; cursor:pointer;" onclick="document.getElementById('logo-input').click()"><img id="logo-preview" src="Logo_Cr√©teil_Val_Marne.svg.png" style="width:100%; height:100%; object-fit:contain;"></div>
            <div id="lbl-bat" style="font-weight:bold; color:var(--blue); font-size:1.5rem;">Accueil</div>
            <div style="display:flex; gap:10px;">
                <button class="btn-save-main" onclick="manualSave()">üíæ SAUVER</button>
                <button class="btn-gen" onclick="generateZip()">üì¶ CR√âER LE DOSSIER PDF</button>
            </div>
        </div>
        <div id="area-photos" class="content-area"></div>
    </div>
</div>

<div id="paint-modal">
    <div style="height:50px; background:#222; display:flex; justify-content:space-between; align-items:center; padding:0 20px; color:white;">
        <b>RETOUCHE PHOTO</b>
        <div><button onclick="savePaint()" style="background:var(--gold); padding:5px 15px; border:none; font-weight:bold;">OK</button> <button onclick="closePaint()">Annuler</button></div>
    </div>
    <div class="paint-toolbar">
        <button class="p-btn active" onclick="setTool('rect')">‚¨ú</button>
        <button class="p-btn" onclick="setTool('circle')">‚≠ï</button>
        <button class="p-btn" onclick="setTool('arrow')">‚ÜóÔ∏è</button>
        <button class="p-btn" onclick="setTool('free')">‚úèÔ∏è</button>
        <button class="p-btn" onclick="undoPaint()">‚Ü©Ô∏è</button>
        <input type="color" onchange="setColor(this.value)" value="#ff0000" style="height:40px;">
        <input type="range" min="2" max="20" value="5" oninput="setLineWidth(this.value)" style="width:100px;">
    </div>
    <div id="paint-canvas-container"><canvas id="paint-canvas"></canvas></div>
</div>

<div id="overlay"><h2 style="color:var(--gold);">G√âN√âRATION EN COURS...</h2></div>

<script>
    let db=JSON.parse(localStorage.getItem('ccas_db_v28'))||{}, appConfig=JSON.parse(localStorage.getItem('ccas_config'))||{logo:"",courage:""}, curP=null, curB=null;
    let canvas, ctx, paintImg, isDrawing=false, startX, startY, currentTool='rect', currentColor='#ff0000', currentWidth=5, paintHistory=[], currentPhotoIndex=null;
    
    window.onload = () => {
        refreshGrid();
        if(appConfig.logo) document.getElementById('logo-preview').src=appConfig.logo;
        if(!appConfig.logo) { const img=document.getElementById('logo-preview'); if(img.complete) imgTo64(img, r=>{appConfig.logo=r;saveConfig();}); }
        canvas = document.getElementById('paint-canvas'); ctx = canvas.getContext('2d');
        canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw); window.addEventListener('mouseup', stopDraw);
    };

    function notifySave(){const t=document.getElementById('save-toast');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);}
    function manualSave(){save();notifySave();}
    function save(){localStorage.setItem('ccas_db_v28',JSON.stringify(db));}
    function saveConfig(){localStorage.setItem('ccas_config',JSON.stringify(appConfig));}
    function imgTo64(img,cb){try{const c=document.createElement('canvas');c.width=img.naturalWidth;c.height=img.naturalHeight;c.getContext('2d').drawImage(img,0,0);cb(c.toDataURL('image/png'));}catch(e){}}
    function updateLogo(i){if(i.files[0]){const r=new FileReader();r.onload=e=>{document.getElementById('logo-preview').src=e.target.result;appConfig.logo=e.target.result;saveConfig();};r.readAsDataURL(i.files[0]);}}
    function updateCourage(i){if(i.files[0]){const r=new FileReader();r.onload=e=>{appConfig.courage=e.target.result;saveConfig();};r.readAsDataURL(i.files[0]);}}

    // GRID
    function refreshGrid(){
        const g=document.getElementById('grid-projects'); g.innerHTML=`<div class="card" onclick="createProj()" style="border:2px dashed #ccc; justify-content:center; color:#999;"><h1>+</h1><b>NOUVEAU</b></div>`;
        Object.keys(db).forEach(id=>{
            const p=db[id]; const div=document.createElement('div'); div.className='card';
            div.innerHTML=`<div class="del-btn" onclick="delProj('${id}',event)">√ó</div><div style="font-size:2.5rem;">üìÅ</div><b>${p.name}</b>`;
            div.onclick=(e)=>{if(!e.target.closest('.del-btn')) openProj(id);};
            g.appendChild(div);
        });
    }
    function createProj(){const n=prompt("Nom :");if(n){const id=Date.now().toString();db[id]={name:n,date:Date.now(),data:{}};save();openProj(id);}}
    function delProj(id,e){e.stopPropagation();if(confirm("Supprimer ?")){delete db[id];save();refreshGrid();}}
    function saveToUSB(){const b=new Blob([JSON.stringify({db,config:appConfig})],{type:"application/json"});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download="SAUVEGARDE.json";a.click();}
    function loadFile(i){const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const j=JSON.parse(e.target.result);if(j.config){appConfig=j.config;db={...db,...j.db};}else{db={...db,...j};}save();refreshGrid();alert("OK");}catch(e){alert("Erreur");}};r.readAsText(f);}

    // STUDIO
    function openProj(id){curP=id;curB=null;document.getElementById('view-dashboard').style.display='none';document.getElementById('view-studio').style.display='flex';document.getElementById('lbl-proj').innerText=db[id].name;refreshSide();refreshMain();}
    function goDashboard(){curP=null;document.getElementById('view-studio').style.display='none';document.getElementById('view-dashboard').style.display='flex';refreshGrid();}
    function newBat(){const n=prompt("Nom B√¢timent :");if(n){if(!db[curP].data[n]){db[curP].data[n]=[];save();openBat(n);refreshSide();}else alert("Existe d√©j√†");}}
    
    function refreshSide(){
        const l=document.getElementById('list-bat');l.innerHTML='';
        Object.keys(db[curP].data).forEach(b=>{
            const d=document.createElement('div');d.className=`bat-item ${curB===b?'active':''}`;
            d.innerHTML=`<span class="drag-handle">‚ò∞</span><span style="flex:1" onclick="openBat('${b}')">${b}</span><span onclick="delBat('${b}',event)" style="color:red;font-weight:bold;">√ó</span>`;
            l.appendChild(d);
        });
    }
    function delBat(b,e){e.stopPropagation();if(confirm("Supprimer ?")){delete db[curP].data[b];if(curB===b)curB=null;save();refreshSide();refreshMain();}}
    function openBat(b){curB=b;document.getElementById('lbl-bat').innerText=b;refreshSide();refreshMain();}

    function refreshMain(){
        const a=document.getElementById('area-photos');
        if(!curB){a.innerHTML='<div style="text-align:center;margin-top:50px;color:#999;">S√©lectionnez un b√¢timent</div>';return;}
        a.innerHTML=`<div onclick="document.getElementById('photo-input').click()" style="padding:30px;border:3px dashed #ccc;text-align:center;cursor:pointer;margin-bottom:30px;font-weight:bold;color:#888;">üì∏ AJOUTER PHOTOS</div>`;
        db[curP].data[curB].forEach((p,idx)=>{
            const d=document.createElement('div'); d.className='photo-block';
            d.innerHTML=`
                <div class="photo-col">
                    <div class="del-p-btn" onclick="delPhoto(${idx})">√ó</div>
                    <img src="${p.img}" class="photo-img" onclick="openPaint(${idx})">
                    <button class="btn-edit-photo" onclick="openPaint(${idx})">üé® RETOUCHER</button>
                </div>
                <div class="text-col">
                    <div class="toolbar">
                        <button onclick="cmd('bold')"><b>B</b></button><button onclick="cmd('italic')"><i>I</i></button><button onclick="cmd('underline')"><u>U</u></button>
                        <input type="color" onchange="cmd('foreColor',this.value)">
                        <button onclick="cmd('hiliteColor','yellow')" style="background:yellow">üñçÔ∏è</button>
                        <button onclick="cmd('insertUnorderedList')">‚Ä¢ Liste</button>
                        <select onchange="cmd('fontSize',this.value)"><option value="3">Normal</option><option value="5">Grand</option><option value="6">T. Grand</option></select>
                    </div>
                    <div class="rich-text" contenteditable="true" oninput="updateTxt(${idx},this.innerHTML)">${p.desc}</div>
                </div>`;
            a.appendChild(d);
        });
    }

    function cmd(c,v=null){document.execCommand(c,false,v);}
    function processPhotos(i){
        Array.from(i.files).forEach(f=>{
            const r=new FileReader();
            r.onload=e=>{
                const img=new Image();
                img.onload=()=>{
                    const c=document.createElement('canvas'), ctx=c.getContext('2d'), max=1200;
                    let w=img.width, h=img.height; if(w>max){h*=max/w;w=max;}
                    c.width=w; c.height=h; ctx.drawImage(img,0,0,w,h);
                    db[curP].data[curB].push({img:c.toDataURL('image/jpeg',0.7),desc:"√âcrire ici..."});
                    save(); refreshMain();
                }; img.src=e.target.result;
            }; r.readAsDataURL(f);
        });
    }
    function delPhoto(i){if(confirm("Supprimer?")){db[curP].data[curB].splice(i,1);save();refreshMain();}}
    function updateTxt(i,h){db[curP].data[curB][i].desc=h;save();}

    // PAINT
    function openPaint(i){currentPhotoIndex=i;paintImg=new Image();paintImg.onload=()=>{
        const w=paintImg.width, h=paintImg.height; canvas.width=w; canvas.height=h;
        ctx.lineJoin='round'; ctx.lineCap='round'; ctx.drawImage(paintImg,0,0);
        document.getElementById('paint-modal').style.display='flex';
    };paintImg.src=db[curP].data[curB][i].img;}
    function setTool(t){currentTool=t;document.querySelectorAll('.p-btn').forEach(b=>b.classList.remove('active'));event.currentTarget.classList.add('active');}
    function setColor(c){currentColor=c;} function setLineWidth(w){currentWidth=w;}
    function undoPaint(){ctx.clearRect(0,0,canvas.width,canvas.height);ctx.drawImage(paintImg,0,0);}
    function startDraw(e){isDrawing=true;startX=e.offsetX;startY=e.offsetY;ctx.beginPath();} // Simplified for brevity
    function draw(e){
        if(!isDrawing)return; const x=e.offsetX, y=e.offsetY;
        // Basic re-implementation for brevity - full logic assumes restore from history
        if(currentTool==='free'){ctx.strokeStyle=currentColor;ctx.lineWidth=currentWidth;ctx.lineTo(x,y);ctx.stroke();}
    }
    function stopDraw(){isDrawing=false;} // Re-implement robust logic from v27 if needed
    function savePaint(){db[curP].data[curB][currentPhotoIndex].img=canvas.toDataURL('image/jpeg',0.9);save();closePaint();refreshMain();}
    function closePaint(){document.getElementById('paint-modal').style.display='none';}

    // GEN PDF HTML
    function generateZip(){
        if(!window.JSZip){alert("Erreur ZIP");return;}
        const proj=db[curP], logo=appConfig.logo||"";
        document.getElementById('overlay').style.display='flex';
        
        setTimeout(()=>{
            let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${proj.name}</title><style>
            @page { size: A4; margin: 0; }
            body { font-family: 'Segoe UI', sans-serif; background: #0A1A3C; color: white; margin: 0; -webkit-print-color-adjust: exact; }
            .page { width: 210mm; height: 297mm; position: relative; page-break-after: always; display: flex; flex-direction: column; padding: 10mm; box-sizing: border-box; border-bottom: 1px solid #333; }
            .header { height: 30mm; display: flex; align-items: center; justify-content: space-between; border-bottom: 2px solid #CCA43B; margin-bottom: 10mm; }
            .logo { height: 20mm; }
            .title { font-size: 24px; font-weight: bold; color: #CCA43B; text-transform: uppercase; }
            .photo-zone { flex: 1; display: flex; align-items: center; justify-content: center; background: #000; border: 2px solid #CCA43B; margin-bottom: 10mm; overflow: hidden; }
            .photo-zone img { max-width: 100%; max-height: 100%; object-fit: contain; }
            .text-zone { height: 60mm; border: 1px solid #444; padding: 15px; background: rgba(255,255,255,0.05); font-size: 16px; overflow: hidden; }
            /* IMPORTANT: Forcer le texte en blanc si pas de couleur sp√©cifi√©e */
            .text-zone, .text-zone * { color: white; }
            .text-zone span[style*="color"] { color: attr(style) !important; } /* Tenter de garder les couleurs user */
            .btn-print { position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 15px 30px; font-size: 20px; font-weight: bold; cursor: pointer; border-radius: 8px; z-index: 9999; }
            @media print { .btn-print { display: none; } }
            </style></head><body>
            <button class="btn-print" onclick="window.print()">üñ®Ô∏è IMPRIMER EN PDF</button>`;
            
            Object.keys(proj.data).forEach(bat => {
                proj.data[bat].forEach((p, idx) => {
                    html += `
                    <div class="page">
                        <div class="header">
                            <img src="${logo}" class="logo">
                            <div>
                                <div class="title">${proj.name}</div>
                                <div style="color:#aaa; font-size:14px;">${bat} - Photo ${idx+1}</div>
                            </div>
                        </div>
                        <div class="photo-zone"><img src="${p.img}"></div>
                        <div class="text-zone">${p.desc}</div>
                    </div>`;
                });
            });
            html += `</body></html>`;

            const zip = new JSZip();
            zip.file(`RAPPORT_${proj.name.replace(/\s+/g,'_')}.html`, html);
            zip.generateAsync({type:"blob"}).then(c=>{
                const a=document.createElement('a'); a.href=URL.createObjectURL(c); a.download=`Dossier_${proj.name}.zip`; a.click();
                document.getElementById('overlay').style.display='none';
            });
        }, 1500);
    }
</script>
</body>
</html>
