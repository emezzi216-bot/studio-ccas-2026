<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Studio CCAS - Diagnostic GroupÃ©</title>
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        :root { --ios-bg: #F2F2F7; --ios-gold: #D4AF37; --ios-silver: #E5E5EA; --ios-text: #1C1C1E; }
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: var(--ios-bg); color: var(--ios-text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        header { background: rgba(255,255,255,0.7); backdrop-filter: blur(20px); padding: 20px; text-align: center; border-bottom: 1px solid var(--ios-silver); z-index: 100; }
        #editor { flex: 1; padding: 30px; overflow-y: auto; max-width: 950px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        
        .ios-card { background: white; border-radius: 24px; padding: 25px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(212, 175, 55, 0.1); }
        h2 { color: var(--ios-gold); font-size: 1.4rem; margin: 0 0 15px 0; border-bottom: 2px solid var(--ios-silver); padding-bottom: 10px; }
        
        .photo-grid-editor { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .photo-box { background: #F9F9FB; border-radius: 18px; padding: 10px; border: 1px solid var(--ios-silver); position: relative; }
        .photo-box img { width: 100%; height: 120px; object-fit: cover; border-radius: 12px; margin-bottom: 10px; }
        textarea { width: 100%; height: 60px; border-radius: 10px; border: 1px solid var(--ios-silver); padding: 8px; font-size: 0.8rem; resize: none; box-sizing: border-box; }

        .footer { padding: 25px; background: white; border-top: 1px solid var(--ios-silver); text-align: center; }
        .btn { padding: 15px 35px; border-radius: 50px; border: none; font-weight: 700; cursor: pointer; transition: 0.3s; font-size: 1rem; }
        .btn-gold { background: linear-gradient(135deg, #D4AF37, #B4942E); color: white; box-shadow: 0 8px 20px rgba(212, 175, 55, 0.3); }
        .btn-gold:hover { transform: scale(1.02); }
    </style>
</head>
<body>

<header><h1 style="margin:0; font-weight:800; letter-spacing:-1px;">STUDIO DIAGNOSTIC PAR BÃ‚TIMENT</h1></header>

<div id="editor">
    <div class="ios-card">
        <label><strong>Titre du Projet :</strong></label>
        <input type="text" id="ppt-title" style="width:100%; padding:15px; border-radius:12px; border:1px solid #ddd; margin-top:10px;" placeholder="Ex: Ã‰tat des CrÃ¨ches - Ã‰tÃ© 2026">
    </div>
    <div id="main-list"></div>
    <div style="text-align:center;"><button class="btn" style="background:white; color:var(--ios-gold); border:1px solid var(--ios-gold);" onclick="addStructure()">+ AJOUTER UN BÃ‚TIMENT</button></div>
</div>

<div class="footer"><button class="btn btn-gold" onclick="generatePPTX()">ðŸ’¾ GÃ‰NÃ‰RER LE FICHIER GROUPÃ‰ (.pptx)</button></div>

<script>
    let diagnostic = {};

    function addStructure() {
        const nom = prompt("Nom du bÃ¢timent (ex: CrÃ¨che Elsa Triolet) :");
        if (nom) { diagnostic[nom] = []; render(); }
    }

    function upload(nom, input) {
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = e => { diagnostic[nom].push({ img: e.target.result, desc: "" }); render(); };
            reader.readAsDataURL(file); // UHD [cite: 2026-01-02]
        });
    }

    function render() {
        const list = document.getElementById('main-list'); list.innerHTML = '';
        for (let b in diagnostic) {
            let h = `<div class="ios-card">
                <h2>${b}</h2>
                <input type="file" multiple onchange="upload('${b}', this)">
                <div class="photo-grid-editor">`;
            diagnostic[b].forEach((p, i) => {
                h += `<div class="photo-box">
                    <img src="${p.img}">
                    <textarea onchange="diagnostic['${b}'][${i}].desc = this.value" placeholder="Note technique...">${p.desc}</textarea>
                    <button onclick="diagnostic['${b}'].splice(${i},1); render()" style="position:absolute; top:5px; right:5px; background:red; color:white; border:none; border-radius:50%; width:20px; height:20px; cursor:pointer;">Ã—</button>
                </div>`;
            });
            list.innerHTML += h + `</div></div>`;
        }
    }

    function generatePPTX() {
        const projName = document.getElementById('ppt-title').value || "Diagnostic_CCAS";
        let pptx = new PptxGenJS();
        
        // 1. Page de Garde
        let slideGarde = pptx.addSlide();
        slideGarde.background = { fill: "F2F2F7" };
        slideGarde.addText(projName, { x: 1, y: 2.2, w: "80%", fontSize: 36, color: "005596", bold: true, align: "center" });

        // 2. Boucle par BÃ¢timent
        for (let bati in diagnostic) {
            const photos = diagnostic[bati];
            if (photos.length === 0) continue;

            // On regroupe les photos par 2 par slide pour Ã©viter l'Ã©tirement
            for (let i = 0; i < photos.length; i += 2) {
                let slide = pptx.addSlide();
                
                // En-tÃªte du bÃ¢timent
                slide.addShape(pptx.ShapeType.rect, { x: 0, y: 0, w: "100%", h: 0.6, fill: { color: "D4AF37" } });
                slide.addText(bati + " (" + (Math.floor(i/2)+1) + ")", { x: 0.5, y: 0.1, fontSize: 20, color: "FFFFFF", bold: true });

                // Photo 1 (Gauche)
                slide.addImage({ data: photos[i].img, x: 0.5, y: 0.8, w: 4.3, h: 3.2, sizing: { type: "contain" } });
                slide.addShape(pptx.ShapeType.rect, { x: 0.5, y: 4.1, w: 4.3, h: 1.2, fill: { color: "F2F2F7" } });
                slide.addText(photos[i].desc || "Observation 1", { x: 0.6, y: 4.2, w: 4.1, fontSize: 12, italic: true });

                // Photo 2 (Droite) - si elle existe
                if (photos[i+1]) {
                    slide.addImage({ data: photos[i+1].img, x: 5.2, y: 0.8, w: 4.3, h: 3.2, sizing: { type: "contain" } });
                    slide.addShape(pptx.ShapeType.rect, { x: 5.2, y: 4.1, w: 4.3, h: 1.2, fill: { color: "F2F2F7" } });
                    slide.addText(photos[i+1].desc || "Observation 2", { x: 5.3, y: 4.2, w: 4.1, fontSize: 12, italic: true });
                }
            }
        }
        pptx.writeFile({ fileName: projName + ".pptx" }).then(() => alert("PowerPoint groupÃ© gÃ©nÃ©rÃ© !"));
    }
</script>
</body>
</html>
