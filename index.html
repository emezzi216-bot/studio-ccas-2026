<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio CCAS | v69 GITHUB SAFE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* CHARTE : BLEU NUIT (#0A1A3C) & OR (#CCA43B) */
        :root { --blue: #0A1A3C; --gold: #CCA43B; --white: #fff; --green: #27ae60; --red: #c0392b; }
        
        body { 
            font-family: 'Segoe UI', sans-serif; margin: 0; 
            background-color: var(--blue); color: var(--white); 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
        }
        * { box-sizing: border-box; outline: none; }
        
        /* HEADER */
        .header { height: 60px; background: rgba(0,0,0,0.3); padding: 0 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--gold); }
        .logo { font-size: 1.3rem; font-weight: 800; color: var(--gold); }
        .status-bar { font-size: 0.8rem; padding: 5px 10px; border-radius: 4px; border: 1px solid #555; }
        
        .btn { padding: 8px 15px; border-radius: 4px; font-weight: bold; border: none; cursor: pointer; color: white; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        .btn-green { background: var(--green); border: 1px solid #2ecc71; }
        .btn-blue { background: var(--blue); border: 1px solid var(--gold); color: var(--gold); }
        
        /* VUES */
        #view-dash, #view-studio { flex: 1; overflow: hidden; display: flex; }
        #view-dash { flex-direction: column; padding: 30px; align-items: center; }
        
        /* DASHBOARD */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; width: 100%; max-width: 900px; margin-top: 30px; }
        .card { background: rgba(255,255,255,0.05); border: 1px solid var(--gold); padding: 20px; text-align: center; cursor: pointer; position: relative; }
        .card:hover { background: rgba(204, 164, 59, 0.15); }
        .card-del { position: absolute; top: 5px; right: 5px; color: var(--red); font-weight: bold; cursor: pointer; font-size: 1.2rem; }

        /* STUDIO */
        .sidebar { width: 260px; border-right: 2px solid var(--gold); display: flex; flex-direction: column; background: rgba(0,0,0,0.2); }
        .side-head { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .back-link { color: #aaa; cursor: pointer; display: block; margin-bottom: 5px; font-size: 0.9rem; }
        #proj-name { font-size: 1.1rem; font-weight: bold; color: var(--gold); cursor: pointer; border-bottom: 1px dashed #666; }
        
        .bat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .bat-item { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; display: flex; justify-content: space-between; }
        .bat-item.active { background: var(--gold); color: var(--blue); font-weight: bold; }
        
        .editor { flex: 1; display: flex; flex-direction: column; background: var(--blue); }
        .editor-bar { height: 50px; border-bottom: 1px solid var(--gold); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: rgba(0,0,0,0.2); }
        .content { flex: 1; overflow-y: auto; padding: 30px; }

        /* BLOCS */
        .block { display: flex; border: 1px solid var(--gold); margin-bottom: 20px; background: black; height: 300px; }
        .block-img { width: 60%; display: flex; align-items: center; justify-content: center; border-right: 1px solid var(--gold); position: relative; }
        .block-img img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .btn-del-blk { position: absolute; top: 5px; left: 5px; background: var(--red); color: white; border: none; cursor: pointer; padding: 2px 6px; }
        
        .block-txt { width: 40%; display: flex; flex-direction: column; padding: 10px; background: var(--blue); }
        .toolbar { display: flex; gap: 5px; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .tb-btn { background: #333; color: white; border: 1px solid #555; width: 25px; height: 25px; cursor: pointer; }
        .editable { flex: 1; overflow-y: auto; color: white; font-size: 0.95rem; outline: none; }
        
        /* NOTIFICATIONS */
        #toast { position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; border-radius: 4px; font-weight: bold; display: none; z-index: 9999; }
        .toast-ok { background: var(--green); color: white; }
        .toast-err { background: var(--red); color: white; }
    </style>
</head>
<body>

<div id="toast"></div>

<input type="file" id="f-import" class="hidden" onchange="importFile(this)">
<input type="file" id="f-photo" class="hidden" multiple accept="image/*" onchange="addPhotos(this)">
<input type="file" id="f-logo" class="hidden" accept="image/*" onchange="setLogo(this)">

<div id="view-dash">
    <div class="header" style="width:100%">
        <div class="logo">STUDIO CCAS v69</div>
        <div class="status-bar" id="mem-status">M√©moire: OK</div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-green" onclick="exportPC()">üì• SAUVEGARDE PC</button>
            <button class="btn" style="border:1px solid #aaa;" onclick="document.getElementById('f-import').click()">üìÇ Ouvrir</button>
        </div>
    </div>
    <div id="grid" class="grid"></div>
    <div style="margin-top: 40px;">
        <button class="btn btn-blue" style="padding: 15px 30px; font-size: 1.1rem;" onclick="newProj()">+ NOUVEAU DOSSIER</button>
    </div>
</div>

<div id="view-studio" style="display:none;">
    <div class="sidebar">
        <div class="side-head">
            <span class="back-link" onclick="goHome()">‚¨ÖÔ∏è Retour</span>
            <div id="proj-name" onclick="renameProj()">Projet</div>
        </div>
        <div id="bat-list" class="bat-list"></div>
        <div style="padding:10px;"><button class="btn" style="width:100%; border:1px dashed var(--gold); color:var(--gold); background:transparent;" onclick="newBat()">+ RUBRIQUE</button></div>
    </div>
    
    <div class="editor">
        <div class="editor-bar">
            <div onclick="document.getElementById('f-logo').click()" style="cursor:pointer; border:1px dashed #555; padding:2px;">
                <img id="img-logo" src="" style="height:30px; display:none;">
                <span id="lbl-logo" style="font-size:0.7rem; color:#888;">LOGO</span>
            </div>
            <div id="bat-title" style="color:var(--gold); font-weight:bold;">Accueil</div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-green" onclick="saveSite()">üíæ SAUVER</button>
                <button class="btn btn-blue" onclick="genZip()">üì¶ PDF</button>
            </div>
        </div>
        <div id="content" class="content"></div>
    </div>
</div>

<script>
/* MOTEUR V69 - GESTION MEMOIRE */
const STORAGE_KEY = "CCAS_V69_DATA";
let app = { projects: {}, config: { logo: "" } };
let curP = null, curB = null;

// CHARGEMENT
try {
    const d = localStorage.getItem(STORAGE_KEY);
    if(d) app = JSON.parse(d);
    if(app.config.logo) { document.getElementById('img-logo').src=app.config.logo; document.getElementById('img-logo').style.display='block'; document.getElementById('lbl-logo').style.display='none'; }
} catch(e) { console.log("Reset"); }
renderGrid();

/* SAUVEGARDE INTELLIGENTE */
function saveSite() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(app));
        notify("Sauvegard√© !", "toast-ok");
        document.getElementById('mem-status').innerText = "M√©moire: OK";
        document.getElementById('mem-status').style.color = "white";
    } catch(e) {
        // MEMOIRE PLEINE -> FORCE DOWNLOAD
        notify("‚ö†Ô∏è M√âMOIRE PLEINE ! T√âL√âCHARGEMENT REQUIS", "toast-err");
        document.getElementById('mem-status').innerText = "‚ö†Ô∏è M√âMOIRE PLEINE";
        document.getElementById('mem-status').style.color = "red";
        exportPC(); // Force le t√©l√©chargement pour ne pas perdre les donn√©es
    }
}

function notify(msg, cls) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.className = cls; t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 3000);
}

/* EXPORT/IMPORT */
function exportPC() {
    const b = new Blob([JSON.stringify(app)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `CCAS_V69_${Date.now()}.json`; a.click();
}
function importFile(i) {
    if(!i.files[0]) return;
    const r = new FileReader();
    r.onload = e => { try { app = JSON.parse(e.target.result); saveSite(); renderGrid(); notify("Projet charg√©", "toast-ok"); } catch(x){alert("Erreur fichier");} };
    r.readAsText(i.files[0]);
}

/* NAVIGATION */
function newProj() { const n = prompt("Nom :"); if(n) { const id = 'p'+Date.now(); app.projects[id] = {name:n, date:Date.now(), data:{}}; saveSite(); renderGrid(); openProj(id); } }
function openProj(id) { curP=id; curB=null; document.getElementById('view-dash').style.display='none'; document.getElementById('view-studio').style.display='flex'; document.getElementById('proj-name').innerText=app.projects[id].name; if(Object.keys(app.projects[id].data).length===0) app.projects[id].data["Zone 1"]=[]; renderBats(); openBat(Object.keys(app.projects[id].data)[0]); }
function goHome() { document.getElementById('view-studio').style.display='none'; document.getElementById('view-dash').style.display='flex'; curP=null; renderGrid(); }
function renderGrid() { const g = document.getElementById('grid'); g.innerHTML=''; Object.keys(app.projects).forEach(id => { const p=app.projects[id]; const d=document.createElement('div'); d.className='card'; d.innerHTML=`<div class="card-del" onclick="delProj('${id}',event)">√ó</div><div style="font-size:2rem;margin-bottom:10px;">üìÅ</div><b>${p.name}</b>`; d.onclick=()=>openProj(id); g.appendChild(d); }); }
function delProj(id,e) { e.stopPropagation(); if(confirm("Supprimer ?")) { delete app.projects[id]; saveSite(); renderGrid(); } }
function renameProj() { const n=prompt("Nom :", app.projects[curP].name); if(n) { app.projects[curP].name=n; document.getElementById('proj-name').innerText=n; saveSite(); } }

/* RUBRIQUES */
function newBat() { const n=prompt("Nom :"); if(n) { if(!app.projects[curP].data[n]) app.projects[curP].data[n]=[]; saveSite(); openBat(n); } }
function renderBats() {
    const l = document.getElementById('bat-list'); l.innerHTML = '';
    Object.keys(app.projects[curP].data).forEach(b => {
        const d = document.createElement('div'); d.className = `bat-item ${curB===b ? 'active':''}`;
        d.innerHTML = `<span onclick="openBat('${b}')" style="flex:1;">${b}</span> <span onclick="delBat('${b}',event)" style="color:var(--red);font-weight:bold;">√ó</span>`;
        l.appendChild(d);
    });
}
function openBat(b) { curB=b; document.getElementById('bat-title').innerText=b; renderBats(); renderContent(); }
function delBat(b,e) { e.stopPropagation(); if(confirm("Supprimer ?")) { delete app.projects[curP].data[b]; saveSite(); if(curB===b) curB=null; renderBats(); renderContent(); } }

/* PHOTOS & TEXTE */
function addPhotos(input) {
    if(!curB) return alert("S√©lectionnez une rubrique !");
    if(!input.files.length) return;
    Array.from(input.files).forEach(f => {
        const r = new FileReader();
        r.onload = e => {
            const img = new Image();
            img.onload = () => {
                const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                // COMPRESSION ULTRA AGRESSIVE (MAX 600px, Qualit√© 0.5) POUR LE STOCKAGE GITHUB
                let w = img.width, h = img.height; const max = 600;
                if(w > max) { h *= max/w; w = max; }
                cvs.width = w; cvs.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                app.projects[curP].data[curB].push({ src: cvs.toDataURL('image/jpeg', 0.5), text: "Description..." });
                saveSite(); renderContent();
            }; img.src = e.target.result;
        }; r.readAsDataURL(f);
    });
    input.value = '';
}

function renderContent() {
    const c = document.getElementById('content'); c.innerHTML = '';
    if(!curB) return;
    const btn = document.createElement('div');
    btn.style = "border:2px dashed var(--gold); padding:15px; text-align:center; color:var(--gold); cursor:pointer; margin-bottom:20px;";
    btn.innerText = "+ AJOUTER PHOTOS";
    btn.onclick = () => document.getElementById('f-photo').click();
    c.appendChild(btn);

    app.projects[curP].data[curB].forEach((item, idx) => {
        const b = document.createElement('div'); b.className = 'block';
        b.innerHTML = `
            <div class="block-img">
                <button class="btn-del-blk" onclick="delPhoto(${idx})">‚úñ</button>
                <img src="${item.src}">
            </div>
            <div class="block-txt">
                <div class="toolbar">
                    <button class="tb-btn" onclick="document.execCommand('bold')">B</button>
                    <button class="tb-btn" onclick="document.execCommand('italic')">I</button>
                    <button class="tb-btn" onclick="document.execCommand('underline')">U</button>
                    <input type="color" onchange="document.execCommand('foreColor',false,this.value)" style="width:25px;height:25px;border:none;">
                </div>
                <div class="editable" contenteditable="true" oninput="updTxt(${idx}, this.innerHTML)">${item.text}</div>
            </div>`;
        c.appendChild(b);
    });
}
function updTxt(i, t) { app.projects[curP].data[curB][i].text = t; clearTimeout(window.st); window.st=setTimeout(saveSite, 1000); }
function delPhoto(i) { if(confirm("Supprimer ?")) { app.projects[curP].data[curB].splice(i,1); saveSite(); renderContent(); } }

function setLogo(i) { if(i.files[0]) { const r = new FileReader(); r.onload = e => { app.config.logo = e.target.result; document.getElementById('img-logo').src = e.target.result; document.getElementById('img-logo').style.display='block'; document.getElementById('lbl-logo').style.display='none'; saveSite(); }; r.readAsDataURL(i.files[0]); } }

/* PDF GENERATOR */
function genZip() {
    if(!window.JSZip) return alert("Erreur ZIP");
    const proj = app.projects[curP];
    const json = JSON.stringify(proj.data).replace(/</g, '\\u003c');
    const logo = app.config.logo || "";
    
    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${proj.name}</title><style>
    body{margin:0;background:#0A1A3C;color:white;font-family:sans-serif;height:100vh;display:flex;overflow:hidden;}
    #side{width:280px;background:rgba(0,0,0,0.3);border-right:3px solid #CCA43B;display:flex;flex-direction:column;}
    .head{padding:20px;color:#CCA43B;font-weight:800;border-bottom:1px solid #555;text-align:center;text-transform:uppercase;}
    .btn{width:100%;padding:15px;color:#ccc;background:none;border:none;text-align:left;cursor:pointer;border-bottom:1px solid #444;}
    .btn.active{color:#CCA43B;border-left:5px solid #CCA43B;background:rgba(204,164,59,0.1);font-weight:bold;}
    #main{flex:1;display:flex;flex-direction:column;position:relative;}
    .view{height:75vh;width:100%;display:flex;align-items:center;justify-content:center;background:black;border-bottom:3px solid #CCA43B;}
    .view img {max-width:100%;max-height:100%;}
    .bot{height:25vh;background:#0A1A3C;padding:20px 40px;overflow-y:auto;}
    #desc{color:white;font-size:1.3rem;} #desc * {background:transparent!important;} #desc font {color:inherit;}
    #tit{color:#CCA43B;text-transform:uppercase;border-bottom:1px solid #555;padding-bottom:10px;margin-top:0;}
    .nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(204,164,59,0.5);color:white;border:none;font-size:40px;padding:10px;cursor:pointer;border-radius:50%;}
    .p{left:20px;} .n{right:20px;}
    .top-logo{position:absolute;top:10px;right:10px;background:rgba(255,255,255,0.9);padding:5px;border:1px solid #CCA43B;border-radius:4px;}
    @media print{ #side,.nav{display:none;} .view{height:70vh;} .bot{height:30vh;} }
    </style></head><body>
    <div id="side"><div class="head">${proj.name}</div><div id="nav"></div></div>
    <div id="main"><div class="view"><div class="top-logo"><img src="${logo}" height="40"></div><div id="sc"></div></div><div class="bot"><h2 id="tit"></h2><div id="desc"></div></div></div>
    <script>
    const d=${json}; let k=Object.keys(d), cb=k[0], ci=0;
    function rn(){ const n=document.getElementById('nav'); n.innerHTML=''; k.forEach(x=>{ const b=document.createElement('button'); b.className='btn'+(cb===x?' active':''); b.innerText=x; b.onclick=()=>{cb=x;ci=0;sh();rn()}; n.appendChild(b); }); }
    function sh(){ const s=document.getElementById('sc'), i=d[cb]; if(!i||!i.length){ s.innerHTML=''; return; } const it=i[ci]; s.innerHTML='<img src="'+it.src+'">'; document.getElementById('tit').innerText=cb+" ("+(ci+1)+"/"+i.length+")"; document.getElementById('desc').innerHTML=it.text;
    document.querySelectorAll('.nav').forEach(e=>e.remove()); if(i.length>1){ const p=document.createElement('button'); p.className='nav p'; p.innerText='‚ùÆ'; p.onclick=()=>{ci=(ci-1+i.length)%i.length;sh()}; document.querySelector('.view').appendChild(p); const n=document.createElement('button'); n.className='nav n'; n.innerText='‚ùØ'; n.onclick=()=>{ci=(ci+1)%i.length;sh()}; document.querySelector('.view').appendChild(n); } }
    if(k.length){rn();sh();}
    <\/script></body></html>`;
    
    const z = new JSZip(); z.file("Dossier_"+proj.name+".html", html);
    z.generateAsync({type:"blob"}).then(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download="Dossier_"+proj.name+".zip"; a.click(); });
}
</script>
</body>
</html>
